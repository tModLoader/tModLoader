--- src/Terraria\Terraria\Main.cs
+++ src/tModLoader\Terraria\Main.cs
@@ -43,6 +_,8 @@
 using Terraria.Initializers;
 using Terraria.IO;
 using Terraria.Map;
+using Terraria.ModLoader;
+using Terraria.ModLoader.IO;
 using Terraria.Net;
 using Terraria.ObjectData;
 using Terraria.Social;
@@ -147,7 +_,7 @@
 		public static int AnnouncementBoxRange = -1;
 		public static Vector2 destroyerHB = new Vector2(0f, 0f);
 		public static FavoritesFile LocalFavoriteData = new FavoritesFile(Main.SavePath + "/favorites.json", false);
-		public static FavoritesFile CloudFavoritesData = new FavoritesFile("/favorites.json", true);
+		public static FavoritesFile CloudFavoritesData = new FavoritesFile("/ModLoader/favorites.json", true);
 		public static FileMetadata WorldFileMetadata;
 		public static FileMetadata MapFileMetadata;
 		private AchievementManager _achievements;
@@ -182,6 +_,8 @@
 		public static Effect tileShader;
 		public static int npcStreamSpeed = 60;
 		public static int musicError = 0;
+		public static int soundError = 0;
+		public static int ambientError = 0;
 		public static bool dedServFPS = false;
 		public static int dedServCount1 = 0;
 		public static int dedServCount2 = 0;
@@ -465,7 +_,7 @@
 		private static bool flameRingLoaded;
 		private Texture2D flameRingTexture;
 		private Texture2D mapDeathTexture;
-		private RenderTarget2D[,] mapTarget = new RenderTarget2D[Main.mapTargetX, Main.mapTargetY];
+		public RenderTarget2D[,] mapTarget = new RenderTarget2D[Main.mapTargetX, Main.mapTargetY];
 		private RenderTarget2D mapSectionTexture;
 		public static bool[,] initMap = new bool[Main.mapTargetX, Main.mapTargetY];
 		public static bool[,] mapWasContentLost = new bool[Main.mapTargetX, Main.mapTargetY];
@@ -1028,7 +_,8 @@
 		public static AudioEngine engine;
 		public static SoundBank soundBank;
 		public static WaveBank waveBank;
-		public static Cue[] music = new Cue[40];
+		public static MusicWrapper[] music = new MusicWrapper[40];
+		// TODO, Resize these arrays
 		public static float[] musicFade = new float[40];
 		public static float musicVolume = 0.75f;
 		public static float ambientVolume = 0.75f;
@@ -1220,7 +_,7 @@
 		public static bool npcChatFocus2 = false;
 		public static bool npcChatFocus3 = false;
 		public static int npcShop = 0;
-		public static int numShops = 21;
+		public static int numShops = 21 + 1;
 		public static int npcChatCornerItem = 0;
 		public Chest[] shop = new Chest[Main.numShops];
 		public static int[] travelShop = new int[40];
@@ -1287,9 +_,9 @@
 		public static List<WorldFileData> WorldList = new List<WorldFileData>();
 		public static WorldFileData ActiveWorldFileData = new WorldFileData();
 		public static string WorldPath = Main.SavePath + Path.DirectorySeparatorChar + "Worlds";
-		public static string CloudWorldPath = "worlds";
+		public static string CloudWorldPath = "ModLoader/worlds";
 		public static string PlayerPath = Main.SavePath + Path.DirectorySeparatorChar + "Players";
-		public static string CloudPlayerPath = "players";
+		public static string CloudPlayerPath = "ModLoader/players";
 		public static Preferences Configuration = new Preferences(Main.SavePath + Path.DirectorySeparatorChar + "config.json", false, false);
 		public static Preferences InputProfiles = new Preferences(Main.SavePath + Path.DirectorySeparatorChar + "input profiles.json", false, false);
 		public static string[] itemName = new string[3730];
@@ -1966,7 +_,7 @@
 		private int selectedMenu2 = -1;
 		public static int selectedPlayer = 0;
 		public static int selectedWorld = 0;
-		public static int menuMode = 0;
+		public static int menuMode = Interface.loadModsID;
 		public static int menuSkip = 0;
 		private static Item cpItem = new Item();
 		public int textBlinkerCount;
@@ -1982,7 +_,7 @@
 		private static int sX = Main.screenWidth - 800;
 		private static int starMana = 20;
 		private static float heartLife = 20f;
-		private static int rare = 0;
+		public static int rare = 0;
 		public static int hairStart = 0;
 		private static int oldHairStyle;
 		private static Microsoft.Xna.Framework.Color oldHairColor;
@@ -2133,6 +_,8 @@
 			}
 		}
 
+		public static ulong TileFrameSeed => Main._tileFrameSeed;
+
 		public static void FindAnnouncementBoxStatus()
 		{
 			Main.AnnouncementBoxDisabled = Program.LaunchParameters.ContainsKey("-disableannouncementbox");
@@ -2250,6 +_,7 @@
 				flag2 = false;
 				Main.anglerQuest = Main.rand.Next(Main.anglerQuestItemNetIDs.Length);
 				int num = Main.anglerQuestItemNetIDs[Main.anglerQuest];
+				//patch file: num, flag2
 				if (num == 2454 && (!Main.hardMode || WorldGen.crimson))
 				{
 					flag2 = true;
@@ -2306,6 +_,7 @@
 				{
 					flag2 = true;
 				}
+				ItemLoader.IsAnglerQuestAvailable(num, ref flag2);
 			}
 			NetMessage.SendAnglerQuest();
 		}
@@ -2518,6 +_,7 @@
 					}
 				});
 			Main.Configuration.Put("QuickLaunch", Main.SkipAssemblyLoad);
+			//ModLoader.ModLoader.SaveConfiguration();
 			bool flag = Main.Configuration.Save(true);
 			return flag && PlayerInput.Save();
 		}
@@ -2982,9 +_,11 @@
 				FileUtilities.Delete(Main.PlayerList[i].Path, Main.PlayerList[i].IsCloudSave);
 				FileUtilities.Delete(Main.PlayerList[i].Path + ".bak", Main.PlayerList[i].IsCloudSave);
 			}
+			//patch file
 			catch
 			{
 			}
+			PlayerIO.ErasePlayer(Main.PlayerList[i].Path, Main.PlayerList[i].IsCloudSave);
 			try
 			{
 				string path = Main.PlayerList[i].Path.Substring(0, Main.PlayerList[i].Path.Length - 4);
@@ -3017,6 +_,7 @@
 				{
 					SocialAPI.Cloud.Delete(Main.WorldList[i].Path);
 				}
+				WorldIO.EraseWorld(Main.WorldList[i].Path, Main.WorldList[i].IsCloudSave);
 				Main.LoadWorlds();
 			}
 			catch
@@ -3441,7 +_,7 @@
 			}
 			else
 			{
-				Console.Title = "Terraria Server " + Main.versionNumber2;
+				Console.Title = "Terraria Server " + Main.versionNumber2 + " - " + ModLoader.ModLoader.versionedName;
 			}
 			Main.dedServ = true;
 			Main.showSplash = false;
@@ -3457,13 +_,14 @@
 				nPC.SetDefaults(i, -1f);
 				Main.npcName[i] = nPC.name;
 			}
+			ModLoader.ModLoader.do_Load(null);
 			while (Main.worldPathName == null || Main.worldPathName == "")
 			{
 				bool flag = true;
 				while (flag)
 				{
 					Main.LoadWorlds();
-					Console.WriteLine("Terraria Server " + Main.versionNumber2);
+					Console.WriteLine("Terraria Server " + Main.versionNumber2 + " - " + ModLoader.ModLoader.versionedName);
 					Console.WriteLine("");
 					for (int j = 0; j < Main.WorldList.Count; j++)
 					{
@@ -3483,6 +_,7 @@
 								"New World"
 							}));
 					Console.WriteLine("d <number>" + '\t' + "Delete World");
+					Console.WriteLine("m\t\tMods Menu");
 					Console.WriteLine("");
 					Console.Write("Choose World: ");
 					string text2 = Console.ReadLine();
@@ -3667,6 +_,11 @@
 							goto IL_5DA;
 						}
 						goto IL_5DA;
+					}
+					else if (text2 == "m" || text2 == "M")
+					{
+						Interface.ServerModMenu();
+						continue;
 					}
 					else
 					{
@@ -3813,6 +_,9 @@
 					Console.WriteLine(Main.statusText);
 				}
 			}
+			//run one tick to JIT all the game content now rather than when a player connects
+			Console.WriteLine("Running one update...");
+			Update(new GameTime());
 			try
 			{
 				Console.Clear();
@@ -3832,20 +_,11 @@
 				Main.startDedInput();
 			}
 			stopwatch.Start();
-			double num7 = 16.666666666666668;
-			double num8 = 0.0;
-			int num9 = 0;
-			Stopwatch stopwatch2 = new Stopwatch();
-			stopwatch2.Start();
+			double delta = 1000 / 60D;
+			double target = delta;
 			while (!Netplay.disconnect)
 			{
-				double num10 = (double)stopwatch.ElapsedMilliseconds;
-				if (num10 + num8 >= num7)
-				{
-					num9++;
-					num8 += num10 - num7;
-					stopwatch.Reset();
-					stopwatch.Start();
+				{
 					if (Main.oldStatusText != Main.statusText)
 					{
 						Main.oldStatusText = Main.statusText;
@@ -3855,26 +_,23 @@
 					{
 						this.Update(new GameTime());
 					}
+					else
+					{
+						Netplay.OnUpdate();
+					}
 					if (Main.OnTick != null)
 					{
 						Main.OnTick();
 					}
-					double num11 = (double)stopwatch.ElapsedMilliseconds + num8;
-					if (num11 < num7)
-					{
-						int num12 = (int)(num7 - num11) - 1;
-						if (num12 > 1)
-						{
-							Thread.Sleep(num12 - 1);
-							if (!Netplay.anyClients)
-							{
-								num8 = 0.0;
-								Thread.Sleep(10);
-							}
-						}
-					}
-				}
-				Thread.Sleep(0);
+					double now = stopwatch.ElapsedMilliseconds;
+					double remaining = target - now;
+					target += delta; //new target
+					if (target < now) //can't catch up, reset target
+					{
+						target = now + delta;
+					}
+					Thread.Sleep(Math.Max((int)remaining, 0));
+				}
 			}
 		}
 
@@ -4325,7 +_,7 @@
 		public static void InitLifeBytes()
 		{
 			NPC nPC = new NPC();
-			for (int i = -65; i < 540; i++)
+			for (int i = -65; i < NPCLoader.NPCCount; i++)
 			{
 				if (i != 0)
 				{
@@ -6887,6 +_,10 @@
 		protected override void LoadContent()
 		{
 			TexturePackSupport.FindTexturePack();
+			for (int i = 1; i < 40; i++)
+			{
+				Main.music[i] = new MusicWrapper();
+			}
 			TextureManager.Initialize();
 			try
 			{
@@ -6899,7 +_,7 @@
 				Main.waveBank = new WaveBank(Main.engine, "Content" + Path.DirectorySeparatorChar + "Wave Bank.xwb");
 				for (int i = 1; i < 40; i++)
 				{
-					Main.music[i] = Main.soundBank.GetCue("Music_" + i);
+					Main.music[i] = new MusicWrapper(Main.soundBank.GetCue("Music_" + i));
 				}
 				Main.soundMech[0] = this.OurLoad<SoundEffect>("Sounds" + Path.DirectorySeparatorChar + "Mech_0");
 				Main.soundInstanceMech[0] = Main.soundMech[0].CreateInstance();
@@ -7930,6 +_,7 @@
 					bool flag11 = false;
 					Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)Main.screenPosition.X, (int)Main.screenPosition.Y, Main.screenWidth, Main.screenHeight);
 					int num = 5000;
+					int modMusic = -1;
 					for (int k = 0; k < 200; k++)
 					{
 						if (Main.npc[k].active)
@@ -8140,7 +_,7 @@
 							{
 								num2 = 1;
 							}
-							if (num2 == 0)
+							if (num2 == 0 && (Main.npc[k].modNPC == null || Main.npc[k].modNPC.music < 0))
 							{
 								goto IL_488;
 							}
@@ -8148,6 +_,10 @@
 							if (!rectangle.Intersects(value))
 							{
 								goto IL_488;
+							}
+							if (Main.npc[k].modNPC != null && Main.npc[k].modNPC.music >= 0 && modMusic < 0)
+							{
+								modMusic = Main.npc[k].modNPC.music;
 							}
 							if (num2 == 1)
 							{
@@ -8239,6 +_,10 @@
 						if (flag7)
 						{
 							this.newMusic = 38;
+						}
+						else if (modMusic >= 0)
+						{
+							this.newMusic = modMusic;
 						}
 						else if (flag9)
 						{
@@ -8456,6 +_,7 @@
 							this.newMusic = 32;
 						}
 					}
+					ModHooks.UpdateMusic(ref this.newMusic);
 					if (Main.gameMenu || Main.musicVolume == 0f)
 					{
 						Main.musicBox2 = -1;
@@ -8618,6 +_,10 @@
 						if (Main.musicBox == 37)
 						{
 							this.newMusic = 39;
+						}
+						if (Main.musicBox >= Main.maxMusic)
+						{
+							this.newMusic = Main.musicBox;
 						}
 					}
 					Main.curMusic = this.newMusic;
@@ -8635,12 +_,12 @@
 							num8 = 0f;
 							Main.curMusic = 0;
 						}
-						if (NPC.MoonLordCountdown == 1 && Main.curMusic >= 1 && Main.curMusic < 40)
+						if (NPC.MoonLordCountdown == 1 && Main.curMusic >= 1 && Main.curMusic < Main.music.Length)
 						{
 							Main.musicFade[Main.curMusic] = 0f;
 						}
 					}
-					for (int l = 1; l < 40; l++)
+					for (int l = 1; l < Main.music.Length; l++)
 					{
 						if (l == 28)
 						{
@@ -8655,7 +_,7 @@
 								}
 								else if (!Main.music[l].IsPlaying)
 								{
-									Main.music[l] = Main.soundBank.GetCue("Music_" + l);
+									Main.music[l].cue = Main.soundBank.GetCue("Music_" + l);
 									Main.music[l].Play();
 									Main.music[l].SetVariable("Volume", Main.musicFade[l] * Main.ambientVolume);
 								}
@@ -8702,7 +_,10 @@
 						{
 							if (!Main.music[l].IsPlaying)
 							{
-								Main.music[l] = Main.soundBank.GetCue("Music_" + l);
+								if (l < Main.maxMusic)
+								{
+									Main.music[l].cue = Main.soundBank.GetCue("Music_" + l);
+								}
 								Main.music[l].Play();
 								Main.music[l].SetVariable("Volume", Main.musicFade[l] * Main.musicVolume * num8);
 							}
@@ -11159,6 +_,18 @@
 
 		protected override void Update(GameTime gameTime)
 		{
+			try
+			{
+				do_Update(gameTime);
+			}
+			catch (Exception e)
+			{
+				ErrorLogger.LogException(e);
+			}
+		}
+
+		protected void do_Update(GameTime gameTime)
+		{
 			if (!Main.GlobalTimerPaused)
 			{
 				Main.GlobalTime = (float)(gameTime.TotalGameTime.TotalSeconds % 3600.0);
@@ -11196,6 +_,7 @@
 				Main.netMode = Main._targetNetMode;
 				Main._hasPendingNetmodeChange = false;
 			}
+			Netplay.OnUpdate();
 			if (CaptureManager.Instance.IsCapturing)
 			{
 				return;
@@ -11857,6 +_,7 @@
 						Main.wallFrameCounter[144] = 0;
 					}
 				}
+				WallLoader.AnimateWalls();
 				Main.tileFrameCounter[12]++;
 				if (Main.tileFrameCounter[12] > 5)
 				{
@@ -12348,6 +_,7 @@
 						Main.tileFrame[422] = 3;
 					}
 				}
+				TileLoader.AnimateTiles();
 				Main.CritterCages();
 				Main.UpdateDrawAnimations();
 				if (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.F10) && !Main.drawingPlayerChat && !Main.editSign && !Main.editChest)
@@ -12460,6 +_,7 @@
 					Main.toggleFullscreen = true;
 				}
 				PlayerInput.UpdateInput();
+				ModLoader.ModHooks.PostUpdateInput();
 				UILinkPointNavigator.Update();
 				Main.keyState = Keyboard.GetState();
 				if (Main.editSign)
@@ -12533,6 +_,7 @@
 							Main.player[Main.myPlayer].chatOverhead.NewMessage(Main.chatText, Main.chatLength / 2);
 							Main.NewText(newText, white.R, white.G, white.B, false);
 						}
+						ModHooks.ChatInput(Main.chatText);
 						Main.chatText = "";
 						Main.drawingPlayerChat = false;
 						Main.chatRelease = false;
@@ -12541,7 +_,7 @@
 						Main.PlaySound(11, -1, -1, 1);
 					}
 				}
-				if (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Enter) && Main.netMode == 1 && !Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftAlt) && !Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.RightAlt) && Main.hasFocus)
+				if (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Enter) && !Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftAlt) && !Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.RightAlt) && Main.hasFocus)
 				{
 					if (Main.chatRelease && !Main.drawingPlayerChat && !Main.editSign && !Main.editChest && !Main.gameMenu && !Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Escape))
 					{
@@ -12654,6 +_,10 @@
 				{
 					flag = true;
 				}
+				if (!PlayerHooks.CustomBiomesMatch(Main.player[Main.myPlayer], Main.clientPlayer))
+				{
+					flag = true;
+				}
 				if (flag)
 				{
 					NetMessage.SendData(36, -1, -1, "", Main.myPlayer, 0f, 0f, 0f, 0, 0, 0);
@@ -12708,6 +_,7 @@
 				{
 					NetMessage.SendData(99, -1, -1, "", Main.myPlayer, 0f, 0f, 0f, 0, 0, 0);
 				}
+				PlayerHooks.SendClientChanges(Main.player[Main.myPlayer], Main.clientPlayer);
 			}
 			if (Main.netMode == 1)
 			{
@@ -13455,6 +_,7 @@
 				string[] array = new string[num5];
 				bool[] array2 = new bool[num5];
 				bool[] array3 = new bool[num5];
+				string[] tooltipNames = new string[num5];
 				for (int i = 0; i < num5; i++)
 				{
 					array2[i] = false;
@@ -13475,16 +_,21 @@
 							")"
 						});
 				}
+				tooltipNames[0] = "ItemName";
 				if (Main.toolTip.favorited)
 				{
 					array[num6++] = Lang.tip[56];
+					tooltipNames[num6 - 1] = "Favorite";
 					array[num6++] = Lang.tip[57];
+					tooltipNames[num6 - 1] = "FavoriteDesc";
 				}
 				if (Main.toolTip.social)
 				{
 					array[num6] = Lang.tip[0];
+					tooltipNames[num6] = "Social";
 					num6++;
 					array[num6] = Lang.tip[1];
+					tooltipNames[num6] = "SocialDesc";
 					num6++;
 				}
 				else
@@ -13493,9 +_,13 @@
 					{
 						float num7 = 5E-06f;
 						int damage = Main.toolTip.damage;
+						Player player = Main.player[Main.myPlayer];
 						if (Main.toolTip.melee)
 						{
-							array[num6] = string.Concat((int)(Main.player[Main.myPlayer].meleeDamage * (float)damage + num7));
+							int damage2 = (int)(player.meleeDamage * (float)damage + num7);
+							ItemLoader.GetWeaponDamage(Main.toolTip, player, ref damage2);
+							PlayerHooks.GetWeaponDamage(player, Main.toolTip, ref damage2);
+							array[num6] = string.Concat(damage2);
 							string[] array4;
 							IntPtr intPtr;
 							(array4 = array)[(int)(intPtr = (IntPtr)num6)] = array4[(int)intPtr] + Lang.tip[2];
@@ -13519,62 +_,82 @@
 							{
 								num8 *= Main.player[Main.myPlayer].rocketDamage;
 							}
-							array[num6] = string.Concat((int)(num8 + num7));
+							int damage2 = (int)(num8 + num7);
+							ItemLoader.GetWeaponDamage(Main.toolTip, player, ref damage2);
+							PlayerHooks.GetWeaponDamage(player, Main.toolTip, ref damage2);
+							array[num6] = string.Concat(damage2);
 							string[] array4;
 							IntPtr intPtr;
 							(array4 = array)[(int)(intPtr = (IntPtr)num6)] = array4[(int)intPtr] + Lang.tip[3];
 						}
 						else if (Main.toolTip.magic)
 						{
-							array[num6] = string.Concat((int)(Main.player[Main.myPlayer].magicDamage * (float)damage + num7));
+							int damage2 = (int)(player.magicDamage * (float)damage + num7);
+							ItemLoader.GetWeaponDamage(Main.toolTip, player, ref damage2);
+							PlayerHooks.GetWeaponDamage(player, Main.toolTip, ref damage2);
+							array[num6] = string.Concat(damage2);
 							string[] array4;
 							IntPtr intPtr;
 							(array4 = array)[(int)(intPtr = (IntPtr)num6)] = array4[(int)intPtr] + Lang.tip[4];
 						}
 						else if (Main.toolTip.thrown)
 						{
-							array[num6] = string.Concat((int)(Main.player[Main.myPlayer].thrownDamage * (float)damage + num7));
+							int damage2 = (int)(player.thrownDamage * (float)damage + num7);
+							ItemLoader.GetWeaponDamage(Main.toolTip, player, ref damage2);
+							PlayerHooks.GetWeaponDamage(player, Main.toolTip, ref damage2);
+							array[num6] = string.Concat(damage2);
 							string[] array4;
 							IntPtr intPtr;
 							(array4 = array)[(int)(intPtr = (IntPtr)num6)] = array4[(int)intPtr] + Lang.tip[58];
 						}
 						else if (Main.toolTip.summon)
 						{
-							array[num6] = string.Concat((int)(Main.player[Main.myPlayer].minionDamage * (float)damage + num7));
+							int damage2 = (int)(player.minionDamage * (float)damage + num7);
+							ItemLoader.GetWeaponDamage(Main.toolTip, player, ref damage2);
+							PlayerHooks.GetWeaponDamage(player, Main.toolTip, ref damage2);
+							array[num6] = string.Concat(damage2);
 							string[] array4;
 							IntPtr intPtr;
 							(array4 = array)[(int)(intPtr = (IntPtr)num6)] = array4[(int)intPtr] + Lang.tip[53];
 						}
 						else
 						{
-							array[num6] = string.Concat(damage);
+							int damage2 = damage;
+							ItemLoader.GetWeaponDamage(Main.toolTip, player, ref damage2);
+							PlayerHooks.GetWeaponDamage(player, Main.toolTip, ref damage2);
+							array[num6] = string.Concat(damage2);
 							string[] array4;
 							IntPtr intPtr;
 							(array4 = array)[(int)(intPtr = (IntPtr)num6)] = array4[(int)intPtr] + Lang.tip[55];
 						}
+						tooltipNames[num6] = "Damage";
 						num6++;
 						if (Main.toolTip.melee)
 						{
 							int num9 = Main.player[Main.myPlayer].meleeCrit - Main.player[Main.myPlayer].inventory[Main.player[Main.myPlayer].selectedItem].crit + Main.toolTip.crit;
 							array[num6] = num9 + Lang.tip[5];
+							tooltipNames[num6] = "CritChance";
 							num6++;
 						}
 						else if (Main.toolTip.ranged)
 						{
 							int num10 = Main.player[Main.myPlayer].rangedCrit - Main.player[Main.myPlayer].inventory[Main.player[Main.myPlayer].selectedItem].crit + Main.toolTip.crit;
 							array[num6] = num10 + Lang.tip[5];
+							tooltipNames[num6] = "CritChance";
 							num6++;
 						}
 						else if (Main.toolTip.magic)
 						{
 							int num11 = Main.player[Main.myPlayer].magicCrit - Main.player[Main.myPlayer].inventory[Main.player[Main.myPlayer].selectedItem].crit + Main.toolTip.crit;
 							array[num6] = num11 + Lang.tip[5];
+							tooltipNames[num6] = "CritChance";
 							num6++;
 						}
 						else if (Main.toolTip.thrown)
 						{
 							int num12 = Main.player[Main.myPlayer].thrownCrit - Main.player[Main.myPlayer].inventory[Main.player[Main.myPlayer].selectedItem].crit + Main.toolTip.crit;
 							array[num6] = num12 + Lang.tip[5];
+							tooltipNames[num6] = "CritChance";
 							num6++;
 						}
 						if (Main.toolTip.useStyle > 0 && !Main.toolTip.summon)
@@ -13611,6 +_,7 @@
 							{
 								array[num6] = Lang.tip[13];
 							}
+							tooltipNames[num6] = "Speed";
 							num6++;
 						}
 						float num13 = Main.toolTip.knockBack;
@@ -13626,6 +_,8 @@
 						{
 							num13 += num13 * (1f - Main.player[Main.myPlayer].stealth);
 						}
+						ItemLoader.GetWeaponKnockback(Main.toolTip, player, ref num13);
+						PlayerHooks.GetWeaponKnockback(player, Main.toolTip, ref num13);
 						if (num13 == 0f)
 						{
 							array[num6] = Lang.tip[14];
@@ -13662,58 +_,70 @@
 						{
 							array[num6] = Lang.tip[22];
 						}
+						tooltipNames[num6] = "Knockback";
 						num6++;
 					}
 					if (Main.toolTip.fishingPole > 0)
 					{
 						array[num6] = Main.toolTip.fishingPole + "% fishing power";
+						tooltipNames[num6] = "FishingPower";
 						num6++;
 						array[num6] = "Requires bait to catch fish";
+						tooltipNames[num6] = "NeedsBait";
 						num6++;
 					}
 					if (Main.toolTip.bait > 0)
 					{
 						array[num6] = Main.toolTip.bait + "% bait power";
+						tooltipNames[num6] = "BaitPower";
 						num6++;
 					}
 					if (Main.toolTip.headSlot > 0 || Main.toolTip.bodySlot > 0 || Main.toolTip.legSlot > 0 || Main.toolTip.accessory || Main.projHook[Main.toolTip.shoot] || Main.toolTip.mountType != -1 || (Main.toolTip.buffType > 0 && (Main.lightPet[Main.toolTip.buffType] || Main.vanityPet[Main.toolTip.buffType])))
 					{
 						array[num6] = Lang.tip[23];
+						tooltipNames[num6] = "Equipable";
 						num6++;
 					}
 					if (Main.toolTip.tileWand > 0)
 					{
 						array[num6] = Lang.tip[52] + Lang.itemName(Main.toolTip.tileWand, false);
+						tooltipNames[num6] = "WandConsumes";
 						num6++;
 					}
 					if (Main.toolTip.questItem)
 					{
 						array[num6] = Lang.inter[65];
+						tooltipNames[num6] = "Quest";
 						num6++;
 					}
 					if (Main.toolTip.vanity)
 					{
 						array[num6] = Lang.tip[24];
+						tooltipNames[num6] = "Vanity";
 						num6++;
 					}
 					if (Main.toolTip.defense > 0)
 					{
 						array[num6] = Main.toolTip.defense + Lang.tip[25];
+						tooltipNames[num6] = "Defense";
 						num6++;
 					}
 					if (Main.toolTip.pick > 0)
 					{
 						array[num6] = Main.toolTip.pick + Lang.tip[26];
+						tooltipNames[num6] = "PickPower";
 						num6++;
 					}
 					if (Main.toolTip.axe > 0)
 					{
 						array[num6] = Main.toolTip.axe * 5 + Lang.tip[27];
+						tooltipNames[num6] = "AxePower";
 						num6++;
 					}
 					if (Main.toolTip.hammer > 0)
 					{
 						array[num6] = Main.toolTip.hammer + Lang.tip[28];
+						tooltipNames[num6] = "HammerPower";
 						num6++;
 					}
 					if (Main.toolTip.tileBoost != 0)
@@ -13727,6 +_,7 @@
 						{
 							array[num6] = tileBoost + Lang.tip[54];
 						}
+						tooltipNames[num6] = "TileBoost";
 						num6++;
 					}
 					if (Main.toolTip.healLife > 0)
@@ -13739,6 +_,7 @@
 								" ",
 								Lang.tip[30]
 							});
+						tooltipNames[num6] = "HealLife";
 						num6++;
 					}
 					if (Main.toolTip.healMana > 0)
@@ -13751,6 +_,7 @@
 								" ",
 								Lang.tip[31]
 							});
+						tooltipNames[num6] = "HealMana";
 						num6++;
 					}
 					if (Main.toolTip.mana > 0 && (Main.toolTip.type != 127 || !Main.player[Main.myPlayer].spaceGun))
@@ -13763,6 +_,7 @@
 								" ",
 								Lang.tip[31]
 							});
+						tooltipNames[num6] = "UseMana";
 						num6++;
 					}
 					if (Main.toolTip.createWall > 0 || Main.toolTip.createTile > -1)
@@ -13770,22 +_,26 @@
 						if (Main.toolTip.type != 213 && Main.toolTip.tileWand < 1)
 						{
 							array[num6] = Lang.tip[33];
+							tooltipNames[num6] = "Placeable";
 							num6++;
 						}
 					}
 					else if (Main.toolTip.ammo > 0 && !Main.toolTip.notAmmo)
 					{
 						array[num6] = Lang.tip[34];
+						tooltipNames[num6] = "Ammo";
 						num6++;
 					}
 					else if (Main.toolTip.consumable)
 					{
 						array[num6] = Lang.tip[35];
+						tooltipNames[num6] = "Consumable";
 						num6++;
 					}
 					if (Main.toolTip.material)
 					{
 						array[num6] = Lang.tip[36];
+						tooltipNames[num6] = "Material";
 						num6++;
 					}
 					if (Main.toolTip.toolTip != null)
@@ -13798,16 +_,19 @@
 						{
 							array[num6] = this.TooltipMousetextProcessor(Main.toolTip.toolTip);
 						}
+						tooltipNames[num6] = "Tooltip";
 						num6++;
 					}
 					if (Main.toolTip.toolTip2 != null)
 					{
 						array[num6] = this.TooltipMousetextProcessor(Main.toolTip.toolTip2);
+						tooltipNames[num6] = "Tooltip2";
 						num6++;
 					}
 					if (Main.toolTip.buffType == 26 && Main.expertMode)
 					{
 						array[num6] = Lang.misc[40];
+						tooltipNames[num6] = "WellFedExpert";
 						num6++;
 					}
 					if (Main.toolTip.buffTime > 0)
@@ -13822,12 +_,14 @@
 							text = Math.Round((double)Main.toolTip.buffTime / 60.0) + Lang.tip[38];
 						}
 						array[num6] = text;
+						tooltipNames[num6] = "BuffTime";
 						num6++;
 					}
 					if (Main.toolTip.type == 3262 || Main.toolTip.type == 3282 || Main.toolTip.type == 3283 || Main.toolTip.type == 3284 || Main.toolTip.type == 3285 || Main.toolTip.type == 3286 || Main.toolTip.type == 3316 || Main.toolTip.type == 3315 || Main.toolTip.type == 3317 || Main.toolTip.type == 3389)
 					{
 						array[num6] = " ";
 						num = num6;
+						tooltipNames[num6] = "OneDropLogo";
 						num6++;
 					}
 					if (Main.toolTip.prefix > 0)
@@ -13855,6 +_,7 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixDamage";
 							num6++;
 						}
 						if (Main.cpItem.useAnimation != Main.toolTip.useAnimation)
@@ -13876,6 +_,7 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixSpeed";
 							num6++;
 						}
 						if (Main.cpItem.crit != Main.toolTip.crit)
@@ -13894,6 +_,7 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixCritChance";
 							num6++;
 						}
 						if (Main.cpItem.mana != Main.toolTip.mana)
@@ -13914,6 +_,7 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixUseMana";
 							num6++;
 						}
 						if (Main.cpItem.scale != Main.toolTip.scale)
@@ -13934,6 +_,7 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixSize";
 							num6++;
 						}
 						if (Main.cpItem.shootSpeed != Main.toolTip.shootSpeed)
@@ -13954,6 +_,7 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixShootSpeed";
 							num6++;
 						}
 						if (Main.cpItem.knockBack != knockBack)
@@ -13974,135 +_,158 @@
 								array3[num6] = true;
 							}
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixKnockback";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 62)
 						{
 							array[num6] = "+1" + Lang.tip[25];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDefense";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 63)
 						{
 							array[num6] = "+2" + Lang.tip[25];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDefense";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 64)
 						{
 							array[num6] = "+3" + Lang.tip[25];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDefense";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 65)
 						{
 							array[num6] = "+4" + Lang.tip[25];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDefense";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 66)
 						{
 							array[num6] = "+20 " + Lang.tip[31];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMaxMana";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 67)
 						{
 							array[num6] = "+2" + Lang.tip[5];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccCritChance";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 68)
 						{
 							array[num6] = "+4" + Lang.tip[5];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccCritChance";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 69)
 						{
 							array[num6] = "+1" + Lang.tip[39];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDamage";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 70)
 						{
 							array[num6] = "+2" + Lang.tip[39];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDamage";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 71)
 						{
 							array[num6] = "+3" + Lang.tip[39];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDamage";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 72)
 						{
 							array[num6] = "+4" + Lang.tip[39];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccDamage";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 73)
 						{
 							array[num6] = "+1" + Lang.tip[46];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMoveSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 74)
 						{
 							array[num6] = "+2" + Lang.tip[46];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMoveSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 75)
 						{
 							array[num6] = "+3" + Lang.tip[46];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMoveSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 76)
 						{
 							array[num6] = "+4" + Lang.tip[46];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMoveSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 77)
 						{
 							array[num6] = "+1" + Lang.tip[47];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMeleeSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 78)
 						{
 							array[num6] = "+2" + Lang.tip[47];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMeleeSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 79)
 						{
 							array[num6] = "+3" + Lang.tip[47];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMeleeSpeed";
 							num6++;
 						}
 						if (Main.toolTip.prefix == 80)
 						{
 							array[num6] = "+4" + Lang.tip[47];
 							array2[num6] = true;
+							tooltipNames[num6] = "PrefixAccMeleeSpeed";
 							num6++;
 						}
 					}
 					if (Main.toolTip.wornArmor && Main.player[Main.myPlayer].setBonus != "")
 					{
 						array[num6] = Lang.tip[48] + " " + Main.player[Main.myPlayer].setBonus;
+						tooltipNames[num6] = "SetBonus";
 						num6++;
 					}
 				}
 				if (Main.toolTip.expert)
 				{
 					array[num6] = "Expert";
+					tooltipNames[num6] = "Expert";
 					num6++;
 				}
 				num21 = (float)Main.mouseTextColor / 255f;
+				//patch file: num22
 				float num22 = num21;
 				int a = (int)Main.mouseTextColor;
 				if (Main.npcShop > 0)
@@ -14203,6 +_,7 @@
 						{
 							array[num6] = Lang.tip[50] + " " + text2;
 						}
+						tooltipNames[num6] = "Price";
 						num6++;
 						if (num23 > 0)
 						{
@@ -14224,10 +_,14 @@
 					else
 					{
 						array[num6] = Lang.tip[51];
+						tooltipNames[num6] = "Price";
 						num6++;
 						color = new Microsoft.Xna.Framework.Color((int)((byte)(120f * num22)), (int)((byte)(120f * num22)), (int)((byte)(120f * num22)), a);
 					}
 				}
+				Microsoft.Xna.Framework.Color?[] overrideColor;
+				ItemLoader.ModifyTooltips(Main.toolTip, ref num6, tooltipNames, ref array,
+					ref array2, ref array3, ref num, out overrideColor);
 				Vector2 zero = Vector2.Zero;
 				int num28 = 0;
 				for (int j = 0; j < num6; j++)
@@ -14370,6 +_,10 @@
 						else if (k == num6 - 1)
 						{
 							baseColor = color;
+						}
+						if (overrideColor[k].HasValue)
+						{
+							baseColor = overrideColor[k].Value * num22;
 						}
 						ChatManager.DrawColorCodedStringWithShadow(Main.spriteBatch, Main.fontMouseText, array[k], new Vector2((float)num2, (float)(num3 + num29)), baseColor, 0f, Vector2.Zero, Vector2.One, -1f, 2f);
 					}
@@ -14386,7 +_,7 @@
 				if (Main.bannerMouseOver)
 				{
 					int num34 = 0;
-					for (int m = 0; m < 251; m++)
+					for (int m = 0; m < NPCLoader.NPCCount; m++)
 					{
 						if (Item.BannerToNPC(m) != 0 && Main.player[Main.myPlayer].NPCBannerBuff[m])
 						{
@@ -14418,6 +_,7 @@
 						}
 					}
 				}
+				BuffLoader.CustomBuffTipSize(Main.buffString, list);
 				Vector2 zero2 = Vector2.Zero;
 				foreach (Vector2 current in list)
 				{
@@ -14468,7 +_,7 @@
 				if (Main.bannerMouseOver)
 				{
 					int num41 = 0;
-					for (int num42 = 0; num42 < 251; num42++)
+					for (int num42 = 0; num42 < NPCLoader.NPCCount; num42++)
 					{
 						if (Item.BannerToNPC(num42) != 0 && Main.player[Main.myPlayer].NPCBannerBuff[num42])
 						{
@@ -14520,6 +_,8 @@
 						}
 					}
 				}
+				BuffLoader.DrawCustomBuffTip(Main.buffString, Main.spriteBatch,
+					num2, num3 + (int)Main.fontMouseText.MeasureString(Main.buffString).Y);
 			}
 			if (Main.ThickMouse)
 			{
@@ -14855,6 +_,7 @@
 					{
 					}
 					Tile tile = Main.tile[j, i];
+					//patch file: j, i
 					if (tile == null)
 					{
 						tile = new Tile();
@@ -14901,6 +_,7 @@
 						{
 							effects = SpriteEffects.FlipHorizontally;
 						}
+						TileLoader.SetSpriteEffects(j, i, type, ref effects);
 						Microsoft.Xna.Framework.Color color = Lighting.GetColor(j, i);
 						int num12 = 0;
 						int num13 = 16;
@@ -15057,8 +_,10 @@
 						}
 						if (type == 227)
 						{
+							//patch file: num9, num13
 							num9 = 32;
 							num13 = 38;
+							//patch file: num12
 							if (num10 == 238)
 							{
 								num12 -= 6;
@@ -15140,6 +_,7 @@
 						{
 							num12 = 2;
 						}
+						TileLoader.SetDrawPositions(j, i, ref num9, ref num12, ref num13);
 						int num15 = 0;
 						if (tile.halfBrick())
 						{
@@ -15364,6 +_,12 @@
 							{
 								num16 += 90;
 							}
+						}
+						TileLoader.SetAnimationFrame(type, ref num16);
+						if (!TileLoader.PreDraw(j, i, type, Main.spriteBatch))
+						{
+							TileLoader.PostDraw(j, i, type, Main.spriteBatch);
+							continue;
 						}
 						if (type == 373 || type == 374 || type == 375)
 						{
@@ -15986,6 +_,7 @@
 										flag4 = (flag4 || type == 162);
 									}
 								}
+								flag4 = flag4 || TileLoader.Dangersense(j, i, type, Main.player[Main.myPlayer]);
 								if (flag4)
 								{
 									if (color.R < 255)
@@ -16673,7 +_,7 @@
 									}
 								}
 							}
-							if (type == 21)
+							if (TileLoader.IsChest(type))
 							{
 								Microsoft.Xna.Framework.Point key = new Microsoft.Xna.Framework.Point(j, i);
 								if (num10 % 36 != 0)
@@ -16918,6 +_,7 @@
 								}
 								Main.spriteBatch.Draw(Main.shroomCapTexture, new Vector2((float)(j * 16 - (int)Main.screenPosition.X - 22), (float)(i * 16 - (int)Main.screenPosition.Y - 26)) + zero, new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(num93 * 62, 0, 60, 42)), Lighting.GetColor(j, i), 0f, default(Vector2), 1f, effects, 0f);
 							}
+							TileLoader.DrawEffects(j, i, type, Main.spriteBatch, ref color);
 							if (color.R >= 1 || color.G >= 1 || color.B >= 1)
 							{
 								Tile tile2 = Main.tile[j + 1, i];
@@ -18728,6 +_,7 @@
 								int num289 = 0;
 								Main.spriteBatch.Draw(texture2D2, new Vector2((float)(j * 16 - (int)Main.screenPosition.X) - ((float)num9 - 16f) / 2f + (float)num288, (float)(i * 16 - (int)Main.screenPosition.Y + num12 + num289)) + zero, new Microsoft.Xna.Framework.Rectangle?(empty2), transparent, 0f, default(Vector2), 1f, effects, 0f);
 							}
+							TileLoader.PostDraw(j, i, type, Main.spriteBatch);
 						}
 					}
 				}
@@ -19403,7 +_,7 @@
 		{
 			for (int i = 0; i < 500; i++)
 			{
-				if (Main.gore[i].active && Main.gore[i].type > 0 && Main.gore[i].type >= 706 && Main.gore[i].type <= 717 && (Main.gore[i].frame < 7 || Main.gore[i].frame > 9))
+				if (Main.gore[i].active && Main.gore[i].type > 0 && ModGore.DrawBackGore(Main.gore[i]))
 				{
 					this.LoadGore(Main.gore[i].type);
 					if (Main.gore[i].numFrames > 1)
@@ -19428,7 +_,7 @@
 			{
 				if (Main.gore[i].active && Main.gore[i].type > 0)
 				{
-					if (Main.gore[i].type >= 706 && Main.gore[i].type <= 717 && (Main.gore[i].frame < 7 || Main.gore[i].frame > 9))
+					if (ModGore.DrawBackGore(Main.gore[i]))
 					{
 						Main.drawBackGore = true;
 					}
@@ -19452,7 +_,7 @@
 			TimeLogger.DetailedDrawTime(24);
 		}
 
-		protected void DrawHealthBar(float X, float Y, int Health, int MaxHealth, float alpha, float scale = 1f)
+		public void DrawHealthBar(float X, float Y, int Health, int MaxHealth, float alpha, float scale = 1f)
 		{
 			if (Health <= 0)
 			{
@@ -19693,6 +_,10 @@
 			else if (Main.npc[i].type == 376)
 			{
 				num = 6f;
+			}
+			else if (Main.npc[i].modNPC != null)
+			{
+				num = Main.npc[i].modNPC.drawOffsetY;
 			}
 			if (Main.npc[i].townNPC && Main.npc[i].ai[0] == 5f)
 			{
@@ -19886,16 +_,19 @@
 						{
 							flag = true;
 						}
+						//patch file: flag
 						if (player.body == 67 && player.legs == 56 && player.head >= 103 && player.head <= 105)
 						{
 							flag = true;
 						}
+						//patch file: flag2
 						if ((player.head == 78 || player.head == 79 || player.head == 80) && player.body == 51 && player.legs == 47)
 						{
 							flag2 = true;
 						}
 						if (player.head == 171 && player.body == 177 && player.legs == 112)
 						{
+							//patch file: flag3
 							flag = true;
 							flag3 = true;
 						}
@@ -19905,6 +_,7 @@
 						}
 						if (player.head == 170 && player.body == 176 && player.legs == 111)
 						{
+							//patch file: flag4
 							flag4 = true;
 							flag3 = true;
 						}
@@ -19974,6 +_,7 @@
 						{
 							flag3 = true;
 						}
+						ItemLoader.ArmorSetShadows(player, ref flag, ref flag2, ref flag3, ref flag4);
 						if (player.stoned || player.stealth != 1f)
 						{
 							flag3 = false;
@@ -20117,7 +_,7 @@
 			{
 				try
 				{
-					if (Main.npc[i].active && Main.npc[i].type > 0 && Main.npc[i].type < 540 && !Main.npc[i].hide && Main.npc[i].behindTiles == behindTiles)
+					if (Main.npc[i].active && Main.npc[i].type > 0 && !Main.npc[i].hide && Main.npc[i].behindTiles == behindTiles)
 					{
 						if (Main.npc[i].type == 125 || Main.npc[i].type == 126)
 						{
@@ -20238,7 +_,7 @@
 			}
 		}
 
-		protected void DrawNPC(int i, bool behindTiles)
+		public void DrawNPC(int i, bool behindTiles)
 		{
 			int type = Main.npc[i].type;
 			this.LoadNPC(type);
@@ -20842,6 +_,7 @@
 			}
 			if (Main.npc[i].ichor)
 			{
+				//patch file: color9
 				color9 = new Microsoft.Xna.Framework.Color(255, 255, 0, 255);
 			}
 			if (Main.npc[i].onFrostBurn)
@@ -20878,6 +_,7 @@
 				}
 				Lighting.AddLight((int)(Main.npc[i].position.X / 16f), (int)(Main.npc[i].position.Y / 16f + 1f), 1f, 0.3f, 0.1f);
 			}
+			NPCLoader.DrawEffects(Main.npc[i], ref color9);
 			if (Main.player[Main.myPlayer].detectCreature && Main.npc[i].lifeMax > 1)
 			{
 				byte b;
@@ -20907,6 +_,11 @@
 				{
 					color9.B = b3;
 				}
+			}
+			if (!NPCLoader.PreDraw(Main.npc[i], Main.spriteBatch, color9))
+			{
+				NPCLoader.PostDraw(Main.npc[i], Main.spriteBatch, color9);
+				return;
 			}
 			if (type == 50)
 			{
@@ -22911,6 +_,7 @@
 					}
 				}
 			}
+			NPCLoader.PostDraw(Main.npc[i], Main.spriteBatch, color9);
 		}
 
 		protected void DrawNPCExtras(NPC n, bool beforeDraw, float addHeight, float addY, Microsoft.Xna.Framework.Color npcColor, Vector2 halfSize, SpriteEffects npcSpriteEffect)
@@ -22984,6 +_,7 @@
 						num2 = 0.75f;
 					}
 				}
+				NPCLoader.DrawTownAttackGun(n, ref num2, ref num3, ref num4);
 				Texture2D texture2D = Main.itemTexture[num3];
 				int num5 = (int)this.DrawPlayerItemPos(1f, num3).X - num4;
 				Vector2 origin = new Vector2((float)(-(float)num5), (float)(texture2D.Height / 2));
@@ -23059,6 +_,7 @@
 						zero.Y = 12f;
 					}
 				}
+				NPCLoader.DrawTownAttackSwing(n, ref texture2D5, ref num6, ref scaleFactor, ref zero);
 				Tuple<Vector2, float> swingStats = n.GetSwingStats(NPCID.Sets.AttackTime[n.type] * 2, (int)n.ai[1], n.spriteDirection, num6, num6);
 				Vector2 vector3 = swingStats.Item1 + (swingStats.Item1 - n.Center) * scaleFactor + zero;
 				Vector2 origin3 = texture2D5.Size() * new Vector2((float)((n.spriteDirection == 1) ? 0 : 1), 1f);
@@ -23213,7 +_,11 @@
 					}
 				}
 			}
-			if (projectile.bobber && Main.player[projectile.owner].inventory[Main.player[projectile.owner].selectedItem].holdStyle > 0)
+			if (!ProjectileLoader.PreDrawExtras(projectile, Main.spriteBatch))
+			{
+				//fluff
+			}
+			else if (projectile.bobber && Main.player[projectile.owner].inventory[Main.player[projectile.owner].selectedItem].holdStyle > 0)
 			{
 				num = mountedCenter.X;
 				num2 = mountedCenter.Y;
@@ -24630,6 +_,11 @@
 			{
 				color25 = Microsoft.Xna.Framework.Color.White;
 			}
+			if (!ProjectileLoader.PreDraw(projectile, Main.spriteBatch, color25))
+			{
+				ProjectileLoader.PostDraw(projectile, Main.spriteBatch, color25);
+				return;
+			}
 			int num147 = 0;
 			int num148 = 0;
 			if (projectile.type == 175)
@@ -24650,6 +_,7 @@
 			}
 			if (projectile.type == 519)
 			{
+				//patch file: num147, num148
 				num147 = 6;
 				num148 -= 6;
 			}
@@ -24829,6 +_,7 @@
 				num147 = 4;
 				num148 = 4;
 			}
+			//patch file: num149
 			float num149 = (float)(Main.projectileTexture[projectile.type].Width - projectile.width) * 0.5f + (float)projectile.width * 0.5f;
 			if (projectile.type == 50 || projectile.type == 53 || projectile.type == 515)
 			{
@@ -24929,6 +_,7 @@
 			{
 				num147 = 8;
 			}
+			ProjectileLoader.DrawOffset(projectile, ref num147, ref num148, ref num149);
 			SpriteEffects spriteEffects = SpriteEffects.None;
 			if (projectile.spriteDirection == -1)
 			{
@@ -26708,7 +_,7 @@
 				}
 				if (projectile.bobber)
 				{
-					if (projectile.ai[1] > 0f && projectile.ai[1] < 3730f && projectile.ai[0] == 1f)
+					if (projectile.ai[1] > 0f && projectile.ai[1] < (float)ItemLoader.ItemCount && projectile.ai[0] == 1f)
 					{
 						int num277 = (int)projectile.ai[1];
 						Vector2 center = projectile.Center;
@@ -26901,6 +_,7 @@
 					}
 				}
 			}
+			ProjectileLoader.PostDraw(projectile, Main.spriteBatch, color25);
 		}
 
 		private static Microsoft.Xna.Framework.Color buffColor(Microsoft.Xna.Framework.Color newColor, float R, float G, float B, float A)
@@ -27024,6 +_,7 @@
 							this.DrawCacheProjsBehindProjectiles.Add(i);
 						}
 					}
+					ProjectileLoader.DrawBehind(Main.projectile[i], i, DrawCacheProjsBehindNPCsAndTiles, DrawCacheProjsBehindNPCs, DrawCacheProjsBehindProjectiles);
 				}
 			}
 		}
@@ -27641,6 +_,7 @@
 				result.Y += 2f * gravdir;
 			}
 			result.X = num;
+			ItemLoader.HoldoutOffset(gravdir, itemtype, ref result);
 			return result;
 		}
 
@@ -27656,6 +_,12 @@
 
 		protected void DrawPlayerHead(Player drawPlayer, float X, float Y, float Alpha = 1f, float Scale = 1f)
 		{
+			//prepare for lots of ugly code
+			PlayerHeadDrawInfo drawInfo = new PlayerHeadDrawInfo();
+			drawInfo.spriteBatch = Main.spriteBatch;
+			drawInfo.drawPlayer = drawPlayer;
+			drawInfo.alpha = Alpha;
+			drawInfo.scale = Scale;
 			int shaderId = 0;
 			int skinVariant = drawPlayer.skinVariant;
 			short num = (short)drawPlayer.hairDye;
@@ -27663,10 +_,11 @@
 			{
 				num = 1;
 			}
+			drawInfo.hairShader = num;
 			for (int i = 0; i < 16 + drawPlayer.extraAccessorySlots * 2; i++)
 			{
 				int num2 = i % 10;
-				if (drawPlayer.dye[num2] != null && drawPlayer.armor[i].type > 0 && drawPlayer.armor[i].stack > 0 && drawPlayer.armor[i].faceSlot > 0 && drawPlayer.armor[i].faceSlot < 9)
+				if (drawPlayer.dye[num2] != null && drawPlayer.armor[i].type > 0 && drawPlayer.armor[i].stack > 0 && drawPlayer.armor[i].faceSlot > 0)
 				{
 					byte arg_81_0 = drawPlayer.dye[num2].dye;
 				}
@@ -27679,18 +_,26 @@
 			{
 				shaderId = (int)drawPlayer.dye[0].dye;
 			}
+			drawInfo.armorShader = shaderId;
 			this.LoadHair(drawPlayer.hair);
 			Microsoft.Xna.Framework.Color color = this.quickAlpha(Microsoft.Xna.Framework.Color.White, Alpha);
+			drawInfo.eyeWhiteColor = color;
 			Microsoft.Xna.Framework.Color color2 = this.quickAlpha(drawPlayer.eyeColor, Alpha);
+			drawInfo.eyeColor = color2;
 			Microsoft.Xna.Framework.Color color3 = this.quickAlpha(drawPlayer.GetHairColor(false), Alpha);
+			drawInfo.hairColor = color3;
 			Microsoft.Xna.Framework.Color color4 = this.quickAlpha(drawPlayer.skinColor, Alpha);
+			drawInfo.skinColor = color4;
 			Microsoft.Xna.Framework.Color color5 = this.quickAlpha(Microsoft.Xna.Framework.Color.White, Alpha);
+			drawInfo.armorColor = color5;
 			SpriteEffects spriteEffects = SpriteEffects.None;
 			if (drawPlayer.direction < 0)
 			{
 				spriteEffects = SpriteEffects.FlipHorizontally;
 			}
+			drawInfo.spriteEffects = spriteEffects;
 			Vector2 vector = new Vector2((float)drawPlayer.legFrame.Width * 0.5f, (float)drawPlayer.legFrame.Height * 0.4f);
+			drawInfo.drawOrigin = vector;
 			Vector2 position = drawPlayer.position;
 			Microsoft.Xna.Framework.Rectangle bodyFrame = drawPlayer.bodyFrame;
 			drawPlayer.bodyFrame.Y = 0;
@@ -27719,12 +_,55 @@
 			{
 				flag2 = true;
 			}
-			if (drawPlayer.head != 38 && drawPlayer.head != 135)
+			ItemLoader.DrawHair(drawPlayer, ref flag, ref flag2);
+			drawInfo.drawHair = flag;
+			drawInfo.drawAltHair = flag2;
+			List<PlayerHeadLayer> drawLayers = PlayerHooks.GetDrawHeadLayers(drawPlayer);
+			int layerIndex = -1;
+			layerLoopContinue:
+			layerIndex++;
+			if (layerIndex >= drawLayers.Count)
+			{
+				goto postDraw;
+			}
+			if (!drawLayers[layerIndex].ShouldDraw(drawLayers))
+			{
+				goto layerLoopContinue;
+			}
+			if (drawLayers[layerIndex] == PlayerHeadLayer.Head)
+			{
+				goto headLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerHeadLayer.Hair)
+			{
+				goto hairLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerHeadLayer.AltHair)
+			{
+				goto altHairLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerHeadLayer.Armor)
+			{
+				goto armorLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerHeadLayer.FaceAcc)
+			{
+				goto faceLayer;
+			}
+			else
+			{
+				drawLayers[layerIndex].Draw(drawInfo);
+			}
+			goto layerLoopContinue;
+			headLayer:
+			if (drawPlayer.head != 38 && drawPlayer.head != 135 && ItemLoader.DrawHead(drawPlayer))
 			{
 				Main.spriteBatch.Draw(Main.playerTextures[skinVariant, 0], new Vector2(drawPlayer.position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2), drawPlayer.position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f) + drawPlayer.headPosition + vector, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color4, drawPlayer.headRotation, vector, Scale, spriteEffects, 0f);
 				Main.spriteBatch.Draw(Main.playerTextures[skinVariant, 1], new Vector2(drawPlayer.position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2), drawPlayer.position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f) + drawPlayer.headPosition + vector, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color, drawPlayer.headRotation, vector, Scale, spriteEffects, 0f);
 				Main.spriteBatch.Draw(Main.playerTextures[skinVariant, 2], new Vector2(drawPlayer.position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2), drawPlayer.position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f) + drawPlayer.headPosition + vector, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color2, drawPlayer.headRotation, vector, Scale, spriteEffects, 0f);
 			}
+			goto layerLoopContinue;
+			hairLayer:
 			if (flag)
 			{
 				DrawData value = new DrawData(Main.armorHeadTexture[drawPlayer.head], new Vector2(drawPlayer.position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2), drawPlayer.position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f) + drawPlayer.headPosition + vector, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color5, drawPlayer.headRotation, vector, Scale, spriteEffects, 0);
@@ -27745,6 +_,8 @@
 					Main.pixelShader.CurrentTechnique.Passes[0].Apply();
 				}
 			}
+			goto layerLoopContinue;
+			altHairLayer:
 			if (flag2)
 			{
 				Microsoft.Xna.Framework.Rectangle bodyFrame3 = drawPlayer.bodyFrame;
@@ -27761,6 +_,8 @@
 					Main.pixelShader.CurrentTechnique.Passes[0].Apply();
 				}
 			}
+			goto layerLoopContinue;
+			armorLayer:
 			if (drawPlayer.head == 23)
 			{
 				Microsoft.Xna.Framework.Rectangle bodyFrame4 = drawPlayer.bodyFrame;
@@ -27832,7 +_,7 @@
 				value4.Draw(Main.spriteBatch);
 				Main.pixelShader.CurrentTechnique.Passes[0].Apply();
 			}
-			else if (drawPlayer.head > 0 && drawPlayer.head < 195 && drawPlayer.head != 28)
+			else if (drawPlayer.head > 0 && drawPlayer.head != 28)
 			{
 				DrawData value5 = new DrawData(Main.armorHeadTexture[drawPlayer.head], new Vector2(drawPlayer.position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2), drawPlayer.position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f) + drawPlayer.headPosition + vector, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color5, drawPlayer.headRotation, vector, Scale, spriteEffects, 0);
 				GameShaders.Armor.Apply(shaderId, drawPlayer, new DrawData?(value5));
@@ -27852,7 +_,9 @@
 				value6.Draw(Main.spriteBatch);
 				Main.pixelShader.CurrentTechnique.Passes[0].Apply();
 			}
-			if (drawPlayer.face > 0 && drawPlayer.face < 9)
+			goto layerLoopContinue;
+			faceLayer:
+			if (drawPlayer.face > 0)
 			{
 				DrawData value7;
 				if (drawPlayer.face == 7)
@@ -27867,6 +_,8 @@
 				value7.Draw(Main.spriteBatch);
 				Main.pixelShader.CurrentTechnique.Passes[0].Apply();
 			}
+			goto layerLoopContinue;
+			postDraw:
 			drawPlayer.position = position;
 			drawPlayer.bodyFrame.Y = bodyFrame.Y;
 		}
@@ -27891,12 +_,18 @@
 
 		public void DrawPlayer(Player drawPlayer, Vector2 Position, float rotation, Vector2 rotationOrigin, float shadow = 0f)
 		{
+			//prepare for code more ugly than DrawPlayerHead
+			PlayerDrawInfo drawInfo = new PlayerDrawInfo();
+			drawInfo.drawPlayer = drawPlayer;
+			drawInfo.position = Position;
+			drawInfo.shadow = shadow;
 			DrawData value = default(DrawData);
 			int num = -1;
 			Main.playerDrawData.Clear();
 			Main.playerDrawDust.Clear();
 			Main.playerDrawGore.Clear();
 			Vector2 value2 = Position + (drawPlayer.itemLocation - drawPlayer.position);
+			drawInfo.itemLocation = value2;
 			int num2 = 0;
 			bool flag = false;
 			bool flag2 = false;
@@ -27910,6 +_,9 @@
 			{
 				flag2 = true;
 			}
+			ItemLoader.DrawHands(drawPlayer, ref flag, ref flag2);
+			drawInfo.drawHands = flag;
+			drawInfo.drawArms = flag2;
 			int num3;
 			if (drawPlayer.heldProj >= 0 && shadow == 0f)
 			{
@@ -27918,7 +_,9 @@
 				{
 					flag3 = true;
 				}
-			}
+				ProjectileLoader.DrawHeldProjInFrontOfHeldItemAndArms(Main.projectile[drawPlayer.heldProj], ref flag3);
+			}
+			drawInfo.drawHeldProjInFrontOfHeldItemAndBody = flag3;
 			bool flag4 = false;
 			if (drawPlayer.head == 10 || drawPlayer.head == 12 || drawPlayer.head == 28 || drawPlayer.head == 62 || drawPlayer.head == 97 || drawPlayer.head == 106 || drawPlayer.head == 113 || drawPlayer.head == 116 || drawPlayer.head == 119 || drawPlayer.head == 133 || drawPlayer.head == 138 || drawPlayer.head == 139 || drawPlayer.head == 163 || drawPlayer.head == 178 || drawPlayer.head == 181 || drawPlayer.head == 191)
 			{
@@ -27929,6 +_,9 @@
 			{
 				flag5 = true;
 			}
+			ItemLoader.DrawHair(drawPlayer, ref flag4, ref flag5);
+			drawInfo.drawHair = flag4;
+			drawInfo.drawAltHair = flag5;
 			bool flag6 = false;
 			if (drawPlayer.face == 4 || drawPlayer.face == 3 || drawPlayer.face == 2)
 			{
@@ -27939,18 +_,22 @@
 			{
 				num4 = 1;
 			}
+			drawInfo.hairShader = num4;
 			float num5 = (float)drawPlayer.mount.PlayerOffset;
 			Position.Y -= num5;
+			drawInfo.position = Position;
 			int num6 = 0;
 			if (drawPlayer.dye[0] != null)
 			{
 				num6 = (int)drawPlayer.dye[0].dye;
 			}
+			drawInfo.headArmorShader = num6;
 			int num7 = 0;
 			if (drawPlayer.dye[1] != null)
 			{
 				num7 = (int)drawPlayer.dye[1].dye;
 			}
+			drawInfo.bodyArmorShader = num7;
 			int shader = 0;
 			if (drawPlayer.dye[2] != null)
 			{
@@ -27960,6 +_,7 @@
 			{
 				shader = num7;
 			}
+			drawInfo.legArmorShader = shader;
 			int shader2 = 0;
 			int shader3 = 0;
 			int shader4 = 0;
@@ -27977,53 +_,65 @@
 				int num8 = i % 10;
 				if (drawPlayer.dye[num8] != null && drawPlayer.armor[i].type > 0 && drawPlayer.armor[i].stack > 0 && (i / 10 >= 1 || !drawPlayer.hideVisual[num8] || drawPlayer.armor[i].wingSlot > 0 || drawPlayer.armor[i].type == 934))
 				{
-					if (drawPlayer.armor[i].handOnSlot > 0 && drawPlayer.armor[i].handOnSlot < 19)
+					if (drawPlayer.armor[i].handOnSlot > 0)
 					{
 						shader2 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].handOffSlot > 0 && drawPlayer.armor[i].handOffSlot < 12)
+						drawInfo.handOnShader = shader2;
+					}
+					if (drawPlayer.armor[i].handOffSlot > 0)
 					{
 						shader3 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].backSlot > 0 && drawPlayer.armor[i].backSlot < 11)
+						drawInfo.handOffShader = shader3;
+					}
+					if (drawPlayer.armor[i].backSlot > 0)
 					{
 						shader4 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].frontSlot > 0 && drawPlayer.armor[i].frontSlot < 5)
+						drawInfo.backShader = shader4;
+					}
+					if (drawPlayer.armor[i].frontSlot > 0)
 					{
 						shader5 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].shoeSlot > 0 && drawPlayer.armor[i].shoeSlot < 18)
+						drawInfo.frontShader = shader5;
+					}
+					if (drawPlayer.armor[i].shoeSlot > 0)
 					{
 						shader6 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].waistSlot > 0 && drawPlayer.armor[i].waistSlot < 12)
+						drawInfo.shoeShader = shader6;
+					}
+					if (drawPlayer.armor[i].waistSlot > 0)
 					{
 						shader7 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].shieldSlot > 0 && drawPlayer.armor[i].shieldSlot < 6)
+						drawInfo.waistShader = shader7;
+					}
+					if (drawPlayer.armor[i].shieldSlot > 0)
 					{
 						shader8 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].neckSlot > 0 && drawPlayer.armor[i].neckSlot < 9)
+						drawInfo.shieldShader = shader8;
+					}
+					if (drawPlayer.armor[i].neckSlot > 0)
 					{
 						shader9 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].faceSlot > 0 && drawPlayer.armor[i].faceSlot < 9)
+						drawInfo.neckShader = shader9;
+					}
+					if (drawPlayer.armor[i].faceSlot > 0)
 					{
 						shader10 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].balloonSlot > 0 && drawPlayer.armor[i].balloonSlot < 16)
+						drawInfo.faceShader = shader10;
+					}
+					if (drawPlayer.armor[i].balloonSlot > 0)
 					{
 						shader11 = (int)drawPlayer.dye[num8].dye;
-					}
-					if (drawPlayer.armor[i].wingSlot > 0 && drawPlayer.armor[i].wingSlot < 37)
+						drawInfo.balloonShader = shader11;
+					}
+					if (drawPlayer.armor[i].wingSlot > 0)
 					{
 						shader12 = (int)drawPlayer.dye[num8].dye;
+						drawInfo.wingShader = shader12;
 					}
 					if (drawPlayer.armor[i].type == 934)
 					{
 						shader13 = (int)drawPlayer.dye[num8].dye;
+						drawInfo.carpetShader = shader13;
 					}
 				}
 			}
@@ -28038,32 +_,54 @@
 			SpriteEffects spriteEffects = SpriteEffects.None;
 			SpriteEffects effect = SpriteEffects.FlipHorizontally;
 			Microsoft.Xna.Framework.Color color = drawPlayer.GetImmuneAlpha(drawPlayer.GetHairColor(true), shadow);
+			drawInfo.hairColor = color;
 			Microsoft.Xna.Framework.Color color2 = drawPlayer.GetImmuneAlpha(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.25) / 16.0), Microsoft.Xna.Framework.Color.White), shadow);
+			drawInfo.eyeWhiteColor = color2;
 			Microsoft.Xna.Framework.Color color3 = drawPlayer.GetImmuneAlpha(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.25) / 16.0), drawPlayer.eyeColor), shadow);
+			drawInfo.eyeColor = color3;
 			Microsoft.Xna.Framework.Color color4 = drawPlayer.GetImmuneAlpha(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.25) / 16.0), drawPlayer.skinColor), shadow);
+			drawInfo.faceColor = color4;
 			Microsoft.Xna.Framework.Color color5 = drawPlayer.GetImmuneAlpha(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.5) / 16.0), drawPlayer.skinColor), shadow);
+			drawInfo.bodyColor = color5;
 			Microsoft.Xna.Framework.Color color6 = drawPlayer.GetImmuneAlpha(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.75) / 16.0), drawPlayer.skinColor), shadow);
+			drawInfo.legColor = color6;
 			Microsoft.Xna.Framework.Color color7 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.5) / 16.0), drawPlayer.shirtColor), shadow);
+			drawInfo.shirtColor = color7;
 			Microsoft.Xna.Framework.Color color8 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.5) / 16.0), drawPlayer.underShirtColor), shadow);
+			drawInfo.underShirtColor = color8;
 			Microsoft.Xna.Framework.Color color9 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.75) / 16.0), drawPlayer.pantsColor), shadow);
+			drawInfo.pantsColor = color9;
 			Microsoft.Xna.Framework.Color color10 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.75) / 16.0), drawPlayer.shoeColor), shadow);
+			drawInfo.shoeColor = color10;
 			Microsoft.Xna.Framework.Color color11 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)((double)Position.Y + (double)drawPlayer.height * 0.25) / 16, Microsoft.Xna.Framework.Color.White), shadow);
+			drawInfo.upperArmorColor = color11;
 			Microsoft.Xna.Framework.Color color12 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)((double)Position.Y + (double)drawPlayer.height * 0.5) / 16, Microsoft.Xna.Framework.Color.White), shadow);
+			drawInfo.middleArmorColor = color12;
 			Microsoft.Xna.Framework.Color color13 = color12;
+			drawInfo.mountColor = color13;
 			Microsoft.Xna.Framework.Color color14 = drawPlayer.GetImmuneAlphaPure(Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)((double)Position.Y + (double)drawPlayer.height * 0.75) / 16, Microsoft.Xna.Framework.Color.White), shadow);
+			drawInfo.lowerArmorColor = color14;
 			Microsoft.Xna.Framework.Color color15 = new Microsoft.Xna.Framework.Color(255, 255, 255, 100);
 			int num9 = 0;
 			int num10 = 0;
 			int num11 = 0;
 			int num12 = 0;
 			int num13 = -1;
+			drawInfo.headGlowMask = num13;
 			int num14 = -1;
+			drawInfo.bodyGlowMask = num14;
 			int num15 = -1;
+			drawInfo.armGlowMask = num15;
 			int num16 = -1;
+			drawInfo.legGlowMask = num16;
 			Microsoft.Xna.Framework.Color color16 = Microsoft.Xna.Framework.Color.Transparent;
+			drawInfo.headGlowMaskColor = color16;
 			Microsoft.Xna.Framework.Color color17 = Microsoft.Xna.Framework.Color.Transparent;
+			drawInfo.bodyGlowMaskColor = color17;
 			Microsoft.Xna.Framework.Color color18 = Microsoft.Xna.Framework.Color.Transparent;
+			drawInfo.armGlowMaskColor = color18;
 			Microsoft.Xna.Framework.Color color19 = Microsoft.Xna.Framework.Color.Transparent;
+			drawInfo.legGlowMaskColor = color19;
 			num3 = drawPlayer.head;
 			switch (num3)
 			{
@@ -28123,6 +_,7 @@
 			}
 			if (drawPlayer.head == 169)
 			{
+				//patch file: num13, color16
 				num13 = 15;
 				byte b = (byte)(62.5f * (float)(1 + num9));
 				color16 = new Microsoft.Xna.Framework.Color((int)b, (int)b, (int)b, 0);
@@ -28167,14 +_,17 @@
 			}
 			if (drawPlayer.body == 175)
 			{
+				//patch file: num14
 				if (drawPlayer.Male)
 				{
 					num14 = 13;
 				}
+				//patch file
 				else
 				{
 					num14 = 18;
 				}
+				//patch file: color17
 				byte b5 = (byte)(62.5f * (float)(1 + num9));
 				color17 = new Microsoft.Xna.Framework.Color((int)b5, (int)b5, (int)b5, 0);
 			}
@@ -28189,6 +_,7 @@
 					num14 = 186;
 				}
 				num15 = 188;
+				//patch file: num15, color18
 				byte b6 = (byte)(62.5f * (float)(1 + num12));
 				color17 = new Microsoft.Xna.Framework.Color((int)b6, (int)b6, (int)b6, 0);
 				color18 = new Microsoft.Xna.Framework.Color((int)b6, (int)b6, (int)b6, 0);
@@ -28237,6 +_,7 @@
 			}
 			if (drawPlayer.legs == 111)
 			{
+				//patch file: num16, color19
 				num16 = 17;
 				byte b9 = (byte)(62.5f * (float)(1 + num10));
 				color19 = new Microsoft.Xna.Framework.Color((int)b9, (int)b9, (int)b9, 0);
@@ -28264,6 +_,10 @@
 				color19 = new Microsoft.Xna.Framework.Color((int)b12, (int)b12, (int)b12, 0);
 				color14 = drawPlayer.GetImmuneAlphaPure(new Microsoft.Xna.Framework.Color((int)b12, (int)b12, (int)b12, 255), shadow);
 			}
+			ItemLoader.DrawArmorColor(EquipType.Head, drawPlayer.head, drawPlayer, shadow, ref color11, ref num13, ref color16);
+			ItemLoader.DrawArmorColor(EquipType.Body, drawPlayer.body, drawPlayer, shadow, ref color12, ref num14, ref color17);
+			ItemLoader.ArmorArmGlowMask(drawPlayer.body, drawPlayer, shadow, ref num15, ref color18);
+			ItemLoader.DrawArmorColor(EquipType.Legs, drawPlayer.legs, drawPlayer, shadow, ref color14, ref num16, ref color19);
 			color16 = drawPlayer.GetImmuneAlphaPure(color16, shadow);
 			color17 = drawPlayer.GetImmuneAlphaPure(color17, shadow);
 			color18 = drawPlayer.GetImmuneAlphaPure(color18, shadow);
@@ -28681,9 +_,11 @@
 					goto IL_2A63;
 				}
 			}
+			bool fullBright = false;
+			PlayerHooks.DrawEffects(drawInfo, ref num19, ref num20, ref num21, ref num22, ref fullBright);
 			if (num19 != 1f || num20 != 1f || num21 != 1f || num22 != 1f)
 			{
-				if (drawPlayer.onFire || drawPlayer.onFire2 || drawPlayer.onFrostBurn)
+				if (drawPlayer.onFire || drawPlayer.onFire2 || drawPlayer.onFrostBurn || fullBright)
 				{
 					color2 = drawPlayer.GetImmuneAlpha(Microsoft.Xna.Framework.Color.White, shadow);
 					color3 = drawPlayer.GetImmuneAlpha(drawPlayer.eyeColor, shadow);
@@ -28867,6 +_,27 @@
 				color18 = Microsoft.Xna.Framework.Color.Multiply(color18, num48);
 				color19 = Microsoft.Xna.Framework.Color.Multiply(color19, num48);
 			}
+			drawInfo.hairColor = color;
+			drawInfo.eyeWhiteColor = color2;
+			drawInfo.eyeColor = color3;
+			drawInfo.faceColor = color4;
+			drawInfo.bodyColor = color5;
+			drawInfo.legColor = color6;
+			drawInfo.shirtColor = color7;
+			drawInfo.underShirtColor = color8;
+			drawInfo.pantsColor = color9;
+			drawInfo.shoeColor = color10;
+			drawInfo.upperArmorColor = color11;
+			drawInfo.middleArmorColor = color12;
+			drawInfo.lowerArmorColor = color14;
+			drawInfo.headGlowMask = num13;
+			drawInfo.bodyGlowMask = num14;
+			drawInfo.armGlowMask = num15;
+			drawInfo.legGlowMask = num16;
+			drawInfo.headGlowMaskColor = color16;
+			drawInfo.bodyGlowMaskColor = color17;
+			drawInfo.armGlowMaskColor = color18;
+			drawInfo.legGlowMaskColor = color19;
 			if (drawPlayer.gravDir == 1f)
 			{
 				if (drawPlayer.direction == 1)
@@ -28905,9 +_,13 @@
 					drawPlayer.bodyPosition.Y = 6f;
 				}
 			}
+			drawInfo.spriteEffects = spriteEffects;
 			Vector2 vector2 = new Vector2((float)drawPlayer.legFrame.Width * 0.5f, (float)drawPlayer.legFrame.Height * 0.75f);
+			drawInfo.legOrigin = vector2;
 			Vector2 origin = new Vector2((float)drawPlayer.legFrame.Width * 0.5f, (float)drawPlayer.legFrame.Height * 0.5f);
+			drawInfo.bodyOrigin = origin;
 			Vector2 vector3 = new Vector2((float)drawPlayer.legFrame.Width * 0.5f, (float)drawPlayer.legFrame.Height * 0.4f);
+			drawInfo.headOrigin = vector3;
 			if ((drawPlayer.merman || drawPlayer.forceMerman) && !drawPlayer.hideMerman)
 			{
 				drawPlayer.headRotation = drawPlayer.velocity.Y * (float)drawPlayer.direction * 0.1f;
@@ -28937,6 +_,185 @@
 			{
 				flag7 = true;
 			}
+			goto heldItemColor;
+			postSetupVars:
+			PlayerHooks.ModifyDrawInfo(ref drawInfo);
+			Position = drawInfo.position;
+			shadow = drawInfo.shadow;
+			value2 = drawInfo.itemLocation;
+			flag = drawInfo.drawHands;
+			flag2 = drawInfo.drawArms;
+			flag3 = drawInfo.drawHeldProjInFrontOfHeldItemAndBody;
+			flag4 = drawInfo.drawHair;
+			flag5 = drawInfo.drawAltHair;
+			num4 = drawInfo.hairShader;
+			num6 = drawInfo.headArmorShader;
+			num7 = drawInfo.bodyArmorShader;
+			shader = drawInfo.legArmorShader;
+			shader2 = drawInfo.handOnShader;
+			shader3 = drawInfo.handOffShader;
+			shader4 = drawInfo.backShader;
+			shader5 = drawInfo.frontShader;
+			shader6 = drawInfo.shoeShader;
+			shader7 = drawInfo.waistShader;
+			shader8 = drawInfo.shieldShader;
+			shader9 = drawInfo.neckShader;
+			shader10 = drawInfo.faceShader;
+			shader11 = drawInfo.balloonShader;
+			shader12 = drawInfo.wingShader;
+			shader13 = drawInfo.carpetShader;
+			color = drawInfo.hairColor;
+			color2 = drawInfo.eyeWhiteColor;
+			color3 = drawInfo.eyeColor;
+			color4 = drawInfo.faceColor;
+			color5 = drawInfo.bodyColor;
+			color6 = drawInfo.legColor;
+			color7 = drawInfo.shirtColor;
+			color8 = drawInfo.underShirtColor;
+			color9 = drawInfo.pantsColor;
+			color10 = drawInfo.shoeColor;
+			color11 = drawInfo.upperArmorColor;
+			color12 = drawInfo.middleArmorColor;
+			color13 = drawInfo.mountColor;
+			color14 = drawInfo.lowerArmorColor;
+			num13 = drawInfo.headGlowMask;
+			num14 = drawInfo.bodyGlowMask;
+			num15 = drawInfo.armGlowMask;
+			num16 = drawInfo.legGlowMask;
+			color16 = drawInfo.headGlowMaskColor;
+			color17 = drawInfo.bodyGlowMaskColor;
+			color18 = drawInfo.armGlowMaskColor;
+			color19 = drawInfo.legGlowMaskColor;
+			spriteEffects = drawInfo.spriteEffects;
+			vector2 = drawInfo.legOrigin;
+			origin = drawInfo.bodyOrigin;
+			vector3 = drawInfo.headOrigin;
+			List<PlayerLayer> drawLayers = PlayerHooks.GetDrawLayers(drawPlayer);
+			int layerIndex = -1;
+			layerLoopContinue:
+			layerIndex++;
+			if (layerIndex >= drawLayers.Count)
+			{
+				goto postDraw;
+			}
+			if (!drawLayers[layerIndex].ShouldDraw(drawLayers))
+			{
+				goto layerLoopContinue;
+			}
+			if (drawLayers[layerIndex] == PlayerLayer.HairBack)
+			{
+				goto hairBackLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.MountBack)
+			{
+				goto mountBackLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.MiscEffectsBack)
+			{
+				goto miscEffectsBackLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.BackAcc)
+			{
+				goto backAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Wings)
+			{
+				goto wingsLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.BalloonAcc)
+			{
+				goto balloonAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Skin)
+			{
+				goto skinLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Legs)
+			{
+				goto legsLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.ShoeAcc)
+			{
+				goto shoeAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Body)
+			{
+				goto bodyLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.HandOffAcc)
+			{
+				goto handOffAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.WaistAcc)
+			{
+				goto waistAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.NeckAcc)
+			{
+				goto neckAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Face)
+			{
+				goto faceLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Hair)
+			{
+				goto hairLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Head)
+			{
+				goto headLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.FaceAcc)
+			{
+				goto faceAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.MountFront)
+			{
+				goto mountFrontLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.ShieldAcc)
+			{
+				goto shieldAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.SolarShield)
+			{
+				goto solarShieldLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.HeldProjBack)
+			{
+				goto heldProjBackLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.HeldItem)
+			{
+				goto heldItemLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.Arms)
+			{
+				goto armsLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.HandOnAcc)
+			{
+				goto handOnAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.HeldProjFront)
+			{
+				goto heldProjFrontLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.FrontAcc)
+			{
+				goto frontAccLayer;
+			}
+			else if (drawLayers[layerIndex] == PlayerLayer.MiscEffectsFront)
+			{
+				goto miscEffectsFrontLayer;
+			}
+			else
+			{
+				drawLayers[layerIndex].Draw(drawInfo);
+			}
+			goto layerLoopContinue;
+			hairBackLayer:
 			if (flag6)
 			{
 				bodyFrame.Height = 0;
@@ -28960,6 +_,8 @@
 					bodyFrame.Height = height;
 				}
 			}
+			goto layerLoopContinue;
+			mountBackLayer:
 			if (drawPlayer.mount.Active)
 			{
 				drawPlayer.mount.Draw(Main.playerDrawData, 0, drawPlayer, Position, color13, spriteEffects, shadow);
@@ -28977,6 +_,8 @@
 				value.shader = shader13;
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
+			miscEffectsBackLayer:
 			if (drawPlayer.electrified && shadow == 0f)
 			{
 				Texture2D texture2D = Main.glowMaskTexture[25];
@@ -28999,6 +_,8 @@
 				value = new DrawData(texture2D2, new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), null, color21, drawPlayer.bodyRotation, texture2D2.Size() / 2f, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
+			backAccLayer:
 			bool flag8 = false;
 			if ((drawPlayer.wings == 0 || drawPlayer.velocity.Y == 0f) && (drawPlayer.inventory[drawPlayer.selectedItem].type == 1178 || drawPlayer.inventory[drawPlayer.selectedItem].type == 779 || drawPlayer.inventory[drawPlayer.selectedItem].type == 1295 || drawPlayer.inventory[drawPlayer.selectedItem].type == 1910 || drawPlayer.turtleArmor || drawPlayer.body == 106 || drawPlayer.body == 170))
 			{
@@ -29058,9 +_,9 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
-			if (!flag8 && drawPlayer.back > 0 && drawPlayer.back < 11 && !drawPlayer.mount.Active)
-			{
-				if (drawPlayer.front >= 1 && drawPlayer.front <= 4)
+			if (!flag8 && drawPlayer.back > 0 && !drawPlayer.mount.Active)
+			{
+				if (drawPlayer.front >= 1)
 				{
 					int num54 = drawPlayer.bodyFrame.Y / 56;
 					if (num54 < 1 || num54 > 5)
@@ -29091,6 +_,9 @@
 				value.shader = shader4;
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
+			wingsLayer:
+			flag8 = (drawPlayer.wings == 0 || drawPlayer.velocity.Y == 0f) && (drawPlayer.inventory[drawPlayer.selectedItem].type == 1178 || drawPlayer.inventory[drawPlayer.selectedItem].type == 779 || drawPlayer.inventory[drawPlayer.selectedItem].type == 1295 || drawPlayer.inventory[drawPlayer.selectedItem].type == 1910 || drawPlayer.turtleArmor || drawPlayer.body == 106 || drawPlayer.body == 170);
 			Position.Y += (float)((int)num5 / 2);
 			if (!flag8 && drawPlayer.wings > 0)
 			{
@@ -29268,6 +_,10 @@
 					}
 				}
 			}
+			Position.Y -= (float)((int)num5 / 2);
+			goto layerLoopContinue;
+			balloonAccLayer:
+			Position.Y += (float)((int)num5 / 2);
 			if (drawPlayer.balloon > 0)
 			{
 				int num60 = DateTime.Now.Millisecond % 800 / 200;
@@ -29285,22 +_,26 @@
 				Main.playerDrawData.Add(value);
 			}
 			Position.Y -= (float)((int)num5 / 2);
-			if (drawPlayer.body != 83 && drawPlayer.body != 82 && drawPlayer.body != 93)
+			goto layerLoopContinue;
+			skinLayer:
+			if (drawPlayer.body != 83 && drawPlayer.body != 82 && drawPlayer.body != 93 && ItemLoader.DrawBody(drawPlayer))
 			{
 				value = new DrawData(Main.playerTextures[skinVariant, 3], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color5, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
-				if (drawPlayer.legs != 67 && drawPlayer.legs != 106 && drawPlayer.shoe != 15)
+				if (drawPlayer.legs != 67 && drawPlayer.legs != 106 && drawPlayer.shoe != 15 && ItemLoader.DrawLegs(drawPlayer))
 				{
 					value = new DrawData(Main.playerTextures[skinVariant, 10], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.legFrame), color6, drawPlayer.legRotation, origin, 1f, spriteEffects, 0);
 					Main.playerDrawData.Add(value);
 				}
 			}
+			goto layerLoopContinue;
 			if (drawPlayer.wearsRobe)
 			{
 				goto IL_5CC2;
 			}
 			IL_598C:
-			if (drawPlayer.legs > 0 && drawPlayer.legs < 138 && (drawPlayer.shoe != 15 || drawPlayer.wearsRobe))
+			legsLayer:
+			if (drawPlayer.legs > 0 && (drawPlayer.shoe != 15 || drawPlayer.wearsRobe))
 			{
 				if (!drawPlayer.invis)
 				{
@@ -29322,29 +_,33 @@
 				value = new DrawData(Main.playerTextures[skinVariant, 12], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.legFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.legFrame.Height + 4f))) + drawPlayer.legPosition + vector2, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.legFrame), color10, drawPlayer.legRotation, vector2, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
 			if (drawPlayer.wearsRobe)
 			{
 				goto IL_5D9D;
 			}
 			IL_5CC2:
-			if (drawPlayer.shoe > 0 && drawPlayer.shoe < 18)
+			shoeAccLayer:
+			if (drawPlayer.shoe > 0)
 			{
 				value = new DrawData(Main.accShoesTexture[(int)drawPlayer.shoe], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.legFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.legFrame.Height + 4f))) + drawPlayer.legPosition + vector2, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.legFrame), color14, drawPlayer.legRotation, vector2, 1f, spriteEffects, 0);
 				value.shader = shader6;
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
 			if (drawPlayer.wearsRobe)
 			{
 				goto IL_598C;
 			}
 			IL_5D9D:
+			bodyLayer:
 			bool flag9 = skinVariant == 3 || skinVariant == 8 || skinVariant == 7;
-			if (flag9 && (drawPlayer.body <= 0 || drawPlayer.body >= 195) && !drawPlayer.invis)
+			if (flag9 && drawPlayer.body <= 0 && !drawPlayer.invis)
 			{
 				value = new DrawData(Main.playerTextures[skinVariant, 14], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.legFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.legFrame.Height + 4f))) + drawPlayer.legPosition + vector2, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.legFrame), color7, drawPlayer.legRotation, vector2, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
 			}
-			if (drawPlayer.body > 0 && drawPlayer.body < 195)
+			if (drawPlayer.body > 0)
 			{
 				Microsoft.Xna.Framework.Rectangle bodyFrame2 = drawPlayer.bodyFrame;
 				int num61 = num2;
@@ -29400,13 +_,17 @@
 				value = new DrawData(Main.playerTextures[skinVariant, 5], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color5, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
 			}
-			if (drawPlayer.handoff > 0 && drawPlayer.handoff < 12)
+			goto layerLoopContinue;
+			handOffAccLayer:
+			if (drawPlayer.handoff > 0)
 			{
 				value = new DrawData(Main.accHandsOffTexture[(int)drawPlayer.handoff], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color12, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				value.shader = shader3;
 				Main.playerDrawData.Add(value);
 			}
-			if (drawPlayer.waist > 0 && drawPlayer.waist < 12)
+			goto layerLoopContinue;
+			waistAccLayer:
+			if (drawPlayer.waist > 0)
 			{
 				Microsoft.Xna.Framework.Rectangle legFrame = drawPlayer.legFrame;
 				if (legFrame.Y >= 1064)
@@ -29417,13 +_,17 @@
 				value.shader = shader7;
 				Main.playerDrawData.Add(value);
 			}
-			if (drawPlayer.neck > 0 && drawPlayer.neck < 9)
+			goto layerLoopContinue;
+			neckAccLayer:
+			if (drawPlayer.neck > 0)
 			{
 				value = new DrawData(Main.accNeckTexture[(int)drawPlayer.neck], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color12, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				value.shader = shader9;
 				Main.playerDrawData.Add(value);
 			}
-			if (!drawPlayer.invis && drawPlayer.head != 38 && drawPlayer.head != 135)
+			goto layerLoopContinue;
+			faceLayer:
+			if (!drawPlayer.invis && drawPlayer.head != 38 && drawPlayer.head != 135 && ItemLoader.DrawHead(drawPlayer))
 			{
 				value = new DrawData(Main.playerTextures[skinVariant, 0], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.headPosition + vector3, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color4, drawPlayer.headRotation, vector3, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
@@ -29437,6 +_,8 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
+			goto layerLoopContinue;
+			hairLayer:
 			if (flag4)
 			{
 				value = new DrawData(Main.armorHeadTexture[drawPlayer.head], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.headPosition + vector3, new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color11, drawPlayer.headRotation, vector3, 1f, spriteEffects, 0);
@@ -29455,6 +_,8 @@
 				value.shader = -num4;
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
+			headLayer:
 			if (drawPlayer.head == 23)
 			{
 				if (!drawPlayer.invis)
@@ -29490,7 +_,7 @@
 				value.shader = num6;
 				Main.playerDrawData.Add(value);
 			}
-			else if (drawPlayer.head > 0 && drawPlayer.head < 195 && drawPlayer.head != 28)
+			else if (drawPlayer.head > 0 && drawPlayer.head != 28)
 			{
 				if (!drawPlayer.invis || (drawPlayer.head != 39 && drawPlayer.head != 38))
 				{
@@ -29552,7 +_,9 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
-			if (drawPlayer.face > 0 && drawPlayer.face < 9)
+			goto layerLoopContinue;
+			faceAccLayer:
+			if (drawPlayer.face > 0)
 			{
 				if (drawPlayer.face == 7)
 				{
@@ -29567,6 +_,8 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
+			goto layerLoopContinue;
+			mountFrontLayer:
 			if (drawPlayer.mount.Active)
 			{
 				drawPlayer.mount.Draw(Main.playerDrawData, 2, drawPlayer, Position, color13, spriteEffects, shadow);
@@ -29591,16 +_,20 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
-			if (drawPlayer.shield > 0 && drawPlayer.shield < 6)
+			goto layerLoopContinue;
+			shieldAccLayer:
+			if (drawPlayer.shield > 0)
 			{
 				value = new DrawData(Main.accShieldTexture[(int)drawPlayer.shield], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color12, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				value.shader = shader8;
 				Main.playerDrawData.Add(value);
+				goto layerLoopContinue;
 				if (drawPlayer.mount.Cart)
 				{
 					Main.playerDrawData.Reverse(Main.playerDrawData.Count - 2, 2);
 				}
 			}
+			solarShieldLayer:
 			Position.Y += (float)((int)num5 / 2);
 			if (drawPlayer.solarShields > 0 && shadow == 0f && !drawPlayer.dead)
 			{
@@ -29617,10 +_,14 @@
 				Main.playerDrawData.Add(value);
 			}
 			Position.Y -= (float)((int)num5 / 2);
+			goto layerLoopContinue;
+			heldProjBackLayer:
 			if (drawPlayer.heldProj >= 0 && shadow == 0f && !flag3)
 			{
 				num = Main.playerDrawData.Count;
 			}
+			goto layerLoopContinue;
+			heldItemColor:
 			Microsoft.Xna.Framework.Color color28 = Lighting.GetColor((int)((double)Position.X + (double)drawPlayer.width * 0.5) / 16, (int)(((double)Position.Y + (double)drawPlayer.height * 0.5) / 16.0));
 			if (drawPlayer.inventory[drawPlayer.selectedItem].type == 678)
 			{
@@ -29646,6 +_,8 @@
 				float arg_7F5B_0 = (1f + num76 * 10f) / 11f;
 				color28 = color28.MultiplyRGBA(new Microsoft.Xna.Framework.Color(Vector4.Lerp(Vector4.One, new Vector4(0f, 0.12f, 0.16f, 0f), 1f - num76)));
 			}
+			goto postSetupVars;
+			heldItemLayer:
 			if (shadow == 0f && !drawPlayer.frozen && ((drawPlayer.itemAnimation > 0 && drawPlayer.inventory[drawPlayer.selectedItem].useStyle != 0) || (drawPlayer.inventory[drawPlayer.selectedItem].holdStyle > 0 && !drawPlayer.pulley)) && drawPlayer.inventory[drawPlayer.selectedItem].type > 0 && !drawPlayer.dead && !drawPlayer.inventory[drawPlayer.selectedItem].noUseGraphic && (!drawPlayer.wet || !drawPlayer.inventory[drawPlayer.selectedItem].noWet))
 			{
 				string arg_804B_0 = drawPlayer.name;
@@ -29695,6 +_,7 @@
 							zero = new Vector2((float)Main.itemTexture[drawPlayer.inventory[drawPlayer.selectedItem].type].Width, (float)Main.itemTexture[drawPlayer.inventory[drawPlayer.selectedItem].type].Height);
 							num78 -= Main.itemTexture[drawPlayer.inventory[drawPlayer.selectedItem].type].Width;
 						}
+						ItemLoader.HoldoutOrigin(drawPlayer, ref zero);
 						value = new DrawData(Main.itemTexture[drawPlayer.inventory[drawPlayer.selectedItem].type], new Vector2((float)((int)(value2.X - Main.screenPosition.X + zero.X + (float)num78)), (float)((int)(value2.Y - Main.screenPosition.Y + (float)num79))), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 0, Main.itemTexture[drawPlayer.inventory[drawPlayer.selectedItem].type].Width, Main.itemTexture[drawPlayer.inventory[drawPlayer.selectedItem].type].Height)), drawPlayer.inventory[drawPlayer.selectedItem].GetAlpha(color28), num77, zero, drawPlayer.inventory[drawPlayer.selectedItem].scale, effect, 0);
 						Main.playerDrawData.Add(value);
 					}
@@ -29802,7 +_,9 @@
 					}
 				}
 			}
-			if (drawPlayer.body > 0 && drawPlayer.body < 195)
+			goto layerLoopContinue;
+			armsLayer:
+			if (drawPlayer.body > 0)
 			{
 				Microsoft.Xna.Framework.Rectangle bodyFrame4 = drawPlayer.bodyFrame;
 				int num82 = num2;
@@ -29817,6 +_,7 @@
 					if (flag && !drawPlayer.invis)
 					{
 						int arg_91B9_0 = drawPlayer.body;
+						//patch file: flag, flag2
 						if (flag2)
 						{
 							value = new DrawData(Main.playerTextures[skinVariant, 7], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color5, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
@@ -29845,7 +_,9 @@
 				value = new DrawData(Main.playerTextures[skinVariant, 13], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color7, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				Main.playerDrawData.Add(value);
 			}
-			if (drawPlayer.handon > 0 && drawPlayer.handon < 19)
+			goto layerLoopContinue;
+			handOnAccLayer:
+			if (drawPlayer.handon > 0)
 			{
 				value = new DrawData(Main.accHandsOnTexture[(int)drawPlayer.handon], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color12, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				value.shader = shader2;
@@ -29865,16 +_,23 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
+			goto layerLoopContinue;
+			heldProjFrontLayer:
 			if (drawPlayer.heldProj >= 0 && shadow == 0f && flag3)
 			{
 				num = Main.playerDrawData.Count;
 			}
-			if (!flag8 && drawPlayer.front > 0 && drawPlayer.front < 5 && !drawPlayer.mount.Active)
+			goto layerLoopContinue;
+			frontAccLayer:
+			flag8 = (drawPlayer.wings == 0 || drawPlayer.velocity.Y == 0f) && (drawPlayer.inventory[drawPlayer.selectedItem].type == 1178 || drawPlayer.inventory[drawPlayer.selectedItem].type == 779 || drawPlayer.inventory[drawPlayer.selectedItem].type == 1295 || drawPlayer.inventory[drawPlayer.selectedItem].type == 1910 || drawPlayer.turtleArmor || drawPlayer.body == 106 || drawPlayer.body == 170);
+			if (!flag8 && drawPlayer.front > 0 && !drawPlayer.mount.Active)
 			{
 				value = new DrawData(Main.accFrontTexture[(int)drawPlayer.front], new Vector2((float)((int)(Position.X - Main.screenPosition.X - (float)(drawPlayer.bodyFrame.Width / 2) + (float)(drawPlayer.width / 2))), (float)((int)(Position.Y - Main.screenPosition.Y + (float)drawPlayer.height - (float)drawPlayer.bodyFrame.Height + 4f))) + drawPlayer.bodyPosition + new Vector2((float)(drawPlayer.bodyFrame.Width / 2), (float)(drawPlayer.bodyFrame.Height / 2)), new Microsoft.Xna.Framework.Rectangle?(drawPlayer.bodyFrame), color12, drawPlayer.bodyRotation, origin, 1f, spriteEffects, 0);
 				value.shader = shader5;
 				Main.playerDrawData.Add(value);
 			}
+			goto layerLoopContinue;
+			miscEffectsFrontLayer:
 			if (drawPlayer.frozen && shadow == 0f)
 			{
 				Microsoft.Xna.Framework.Color color30 = color12;
@@ -30009,6 +_,8 @@
 					Main.playerDrawData.Add(value);
 				}
 			}
+			goto layerLoopContinue;
+			postDraw:
 			if (rotation != 0f)
 			{
 				Vector2 value13 = Position - Main.screenPosition + rotationOrigin;
@@ -30101,7 +_,7 @@
 			}
 		}
 
-		protected void DrawItem(Item item, int whoami)
+		public void DrawItem(Item item, int whoami)
 		{
 			int arg_22_0 = (int)((double)item.position.X + (double)item.width * 0.5) / 16;
 			int arg_28_0 = Lighting.offScreenTiles;
@@ -30128,6 +_,11 @@
 			float scale = 1f;
 			Microsoft.Xna.Framework.Color alpha = item.GetAlpha(color);
 			ItemSlot.GetItemLight(ref alpha, ref scale, item, false);
+			if (!ItemLoader.PreDrawInWorld(item, Main.spriteBatch, color, alpha, ref num4, ref scale))
+			{
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
+				return;
+			}
 			float num5 = (float)(item.height - Main.itemTexture[item.type].Height);
 			float num6 = (float)(item.width / 2 - Main.itemTexture[item.type].Width / 2);
 			if (item.type >= 71 && item.type <= 74)
@@ -30147,6 +_,7 @@
 				int num8 = Main.coinTexture[num7].Height / 8;
 				num6 = (float)(item.width / 2 - Main.coinTexture[num7].Width / 2);
 				Main.spriteBatch.Draw(Main.coinTexture[num7], new Vector2(item.position.X - Main.screenPosition.X + (float)(width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(num8 / 2) + num5), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, Main.itemFrame[whoami] * num8 + 1, Main.itemTexture[item.type].Width, num8)), alpha, num4, new Vector2((float)(width / 2), (float)(num8 / 2)), scale, SpriteEffects.None, 0f);
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
 				return;
 			}
 			if (ItemID.Sets.NebulaPickup[item.type])
@@ -30165,6 +_,7 @@
 				num6 = (float)(item.width / 2 - rectangle.Width / 2);
 				num5 = (float)(item.height - rectangle.Height);
 				Main.spriteBatch.Draw(Main.itemTexture[item.type], new Vector2(item.position.X - Main.screenPosition.X + (float)(rectangle.Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(rectangle.Height / 2) + num5), new Microsoft.Xna.Framework.Rectangle?(rectangle), alpha, num4, rectangle.Size() / 2f, scale, SpriteEffects.None, 0f);
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
 				return;
 			}
 			if (ItemID.Sets.AnimatesAsSoul[item.type])
@@ -30183,6 +_,7 @@
 				num6 = (float)(item.width / 2 - rectangle2.Width / 2);
 				num5 = (float)(item.height - rectangle2.Height);
 				Main.spriteBatch.Draw(Main.itemTexture[item.type], new Vector2(item.position.X - Main.screenPosition.X + (float)(rectangle2.Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(rectangle2.Height / 2) + num5), new Microsoft.Xna.Framework.Rectangle?(rectangle2), alpha, num4, rectangle2.Size() / 2f, scale, SpriteEffects.None, 0f);
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
 				return;
 			}
 			if (ItemID.Sets.TrapSigned[item.type])
@@ -30197,11 +_,19 @@
 					Main.spriteBatch.Draw(Main.glowMaskTexture[(int)item.glowMask], new Vector2(item.position.X - Main.screenPosition.X + (float)(Main.itemTexture[item.type].Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(Main.itemTexture[item.type].Height / 2) + num5 + 2f), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 0, Main.itemTexture[item.type].Width, Main.itemTexture[item.type].Height)), new Microsoft.Xna.Framework.Color(250, 250, 250, item.alpha), num4, new Vector2((float)(Main.itemTexture[item.type].Width / 2), (float)(Main.itemTexture[item.type].Height / 2)), scale, SpriteEffects.None, 0f);
 				}
 				Main.spriteBatch.Draw(Main.wireTexture, new Vector2(item.position.X - Main.screenPosition.X + (float)(Main.itemTexture[item.type].Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(Main.itemTexture[item.type].Height / 2) + num5 + 2f) + Main.itemTexture[item.type].Size().RotatedBy((double)num4, default(Vector2)) * 0.45f * item.scale, new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(4, 58, 8, 8)), alpha, 0f, new Vector2(4f), 1f, SpriteEffects.None, 0f);
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
 				return;
 			}
 			if ((item.type >= 1522 && item.type <= 1527) || item.type == 3643)
 			{
 				Main.spriteBatch.Draw(Main.itemTexture[item.type], new Vector2(item.position.X - Main.screenPosition.X + (float)(Main.itemTexture[item.type].Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(Main.itemTexture[item.type].Height / 2) + num5 + 2f), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 0, Main.itemTexture[item.type].Width, Main.itemTexture[item.type].Height)), new Microsoft.Xna.Framework.Color(250, 250, 250, (int)(Main.mouseTextColor / 2)), num4, new Vector2((float)(Main.itemTexture[item.type].Width / 2), (float)(Main.itemTexture[item.type].Height / 2)), (float)Main.mouseTextColor / 1000f + 0.8f, SpriteEffects.None, 0f);
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
+				return;
+			}
+			if (ItemLoader.animations.Contains(item.type))
+			{
+				ItemLoader.DrawAnimatedItem(item, whoami, color, alpha, num4, scale);
+				ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
 				return;
 			}
 			Main.spriteBatch.Draw(Main.itemTexture[item.type], new Vector2(item.position.X - Main.screenPosition.X + (float)(Main.itemTexture[item.type].Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(Main.itemTexture[item.type].Height / 2) + num5 + 2f), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 0, Main.itemTexture[item.type].Width, Main.itemTexture[item.type].Height)), alpha, num4, new Vector2((float)(Main.itemTexture[item.type].Width / 2), (float)(Main.itemTexture[item.type].Height / 2)), scale, SpriteEffects.None, 0f);
@@ -30213,6 +_,7 @@
 			{
 				Main.spriteBatch.Draw(Main.glowMaskTexture[(int)item.glowMask], new Vector2(item.position.X - Main.screenPosition.X + (float)(Main.itemTexture[item.type].Width / 2) + num6, item.position.Y - Main.screenPosition.Y + (float)(Main.itemTexture[item.type].Height / 2) + num5 + 2f), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 0, Main.itemTexture[item.type].Width, Main.itemTexture[item.type].Height)), new Microsoft.Xna.Framework.Color(250, 250, 250, item.alpha), num4, new Vector2((float)(Main.itemTexture[item.type].Width / 2), (float)(Main.itemTexture[item.type].Height / 2)), scale, SpriteEffects.None, 0f);
 			}
+			ItemLoader.PostDrawInWorld(item, Main.spriteBatch, color, alpha, num4, scale);
 		}
 
 		protected void DrawRain()
@@ -30358,7 +_,7 @@
 							}
 						}
 						Microsoft.Xna.Framework.Color color5 = Lighting.GetColor((int)((double)dust.position.X + 4.0) / 16, (int)((double)dust.position.Y + 4.0) / 16);
-						if (dust.type == 6 || dust.type == 15 || (dust.noLight && dust.type < 86 && dust.type > 91) || (dust.type >= 59 && dust.type <= 64))
+						if (dust.type == 6 || dust.type == 15 || (dust.noLight && (dust.type < 86 || dust.type > 91)) || (dust.type >= 59 && dust.type <= 64))
 						{
 							color5 = Microsoft.Xna.Framework.Color.White;
 						}
@@ -30366,6 +_,12 @@
 						if (dust.type == 213)
 						{
 							scale = 1f;
+						}
+						ModDust modDust = ModDust.GetDust(dust.type);
+						if (modDust != null)
+						{
+							modDust.Draw(dust, color5, scale);
+							continue;
 						}
 						Main.spriteBatch.Draw(Main.dustTexture, dust.position - Main.screenPosition, new Microsoft.Xna.Framework.Rectangle?(dust.frame), color5, dust.rotation, new Vector2(4f, 4f), scale, SpriteEffects.None, 0f);
 						if (dust.color != default(Microsoft.Xna.Framework.Color))
@@ -30964,7 +_,7 @@
 			for (int j = 0; j < 22; j++)
 			{
 				int num6 = Main.player[Main.myPlayer].buffType[j];
-				if (Main.debuff[num6] && Main.player[Main.myPlayer].buffTime[j] > 5 && num6 != 28 && num6 != 34 && num6 != 87 && num6 != 89 && num6 != 21 && num6 != 86)
+				if (Main.debuff[num6] && Main.player[Main.myPlayer].buffTime[j] > 5 && BuffLoader.CanBeCleared(num6))
 				{
 					num5 += 1000;
 				}
@@ -31256,6 +_,7 @@
 					text = Lang.inter[54] + " (" + text4 + ")";
 				}
 			}
+			NPCLoader.SetChatButtons(ref text, ref text2);
 			if (!flag)
 			{
 				int num19 = 180 + (Main.screenWidth - 800) / 2;
@@ -31710,7 +_,7 @@
 										for (int l = 0; l < 22; l++)
 										{
 											int num27 = Main.player[Main.myPlayer].buffType[l];
-											if (Main.debuff[num27] && Main.player[Main.myPlayer].buffTime[l] > 0 && num27 != 28 && num27 != 34 && num27 != 87 && num27 != 89 && num27 != 21 && num27 != 86)
+											if (Main.debuff[num27] && Main.player[Main.myPlayer].buffTime[l] > 0 && BuffLoader.CanBeCleared(num27))
 											{
 												Main.player[Main.myPlayer].DelBuff(l);
 												l = -1;
@@ -31757,6 +_,7 @@
 									}
 								}
 							}
+							NPCLoader.OnChatButtonClicked(true);
 						}
 					}
 					else if (Main.npcChatFocus3 && Main.player[Main.myPlayer].talkNPC >= 0)
@@ -31809,6 +_,7 @@
 							}
 							Main.npcChatText = Lang.DyeTraderQuestChat(gotDye);
 						}
+						NPCLoader.OnChatButtonClicked(false);
 					}
 				}
 			}
@@ -32566,14 +_,13 @@
 							int num31 = (int)(Main.player[Main.myPlayer].manaSickReduction * 100f) + 1;
 							Main.buffString = Main.buffString + num31 + "%";
 						}
+						int rare = 0;
 						if (Main.meleeBuff[num30])
 						{
-							this.MouseText(Main.buffName[num30], -10, 0);
-						}
-						else
-						{
-							this.MouseText(Main.buffName[num30], 0, 0);
-						}
+							rare = -10;
+						}
+						BuffLoader.ModifyBuffTip(num30, ref Main.buffString, ref rare);
+						this.MouseText(Main.buffName[num30], rare, 0);
 					}
 				}
 			}
@@ -33073,11 +_,13 @@
 							if (Main.mouseLeftRelease && Main.mouseLeft && Main.player[Main.myPlayer].BuyItem(num62))
 							{
 								bool favorited = Main.reforgeItem.favorited;
+								ItemLoader.PreReforge(Main.reforgeItem);
 								Main.reforgeItem.netDefaults(Main.reforgeItem.netID);
 								Main.reforgeItem.Prefix(-2);
 								Main.reforgeItem.position.X = Main.player[Main.myPlayer].position.X + (float)(Main.player[Main.myPlayer].width / 2) - (float)(Main.reforgeItem.width / 2);
 								Main.reforgeItem.position.Y = Main.player[Main.myPlayer].position.Y + (float)(Main.player[Main.myPlayer].height / 2) - (float)(Main.reforgeItem.height / 2);
 								Main.reforgeItem.favorited = favorited;
+								ItemLoader.PostReforge(Main.reforgeItem);
 								ItemText.NewText(Main.reforgeItem, Main.reforgeItem.stack, true, false);
 								Main.PlaySound(2, -1, -1, 37);
 							}
@@ -33146,7 +_,7 @@
 							else
 							{
 								num73++;
-								Main.spriteBatch.DrawString(Main.fontMouseText, Lang.mapLegend[MapHelper.TileToLookup(Main.recipe[Main.availableRecipe[num72]].requiredTile[num74], 0)], new Vector2((float)num70, (float)(num71 + 118 + num75)), color3, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
+								Main.spriteBatch.DrawString(Main.fontMouseText, Lang.mapLegend.FromType(Main.recipe[Main.availableRecipe[num72]].requiredTile[num74]), new Vector2((float)num70, (float)(num71 + 118 + num75)), color3, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
 								num74++;
 							}
 						}
@@ -33778,6 +_,8 @@
 			r.Create();
 			if (Main.mouseItem.type > 0 || r.createItem.type > 0)
 			{
+				RecipeHooks.OnCraft(Main.mouseItem, r);
+				ItemLoader.OnCraft(Main.mouseItem, r);
 				Main.PlaySound(7, -1, -1, 1);
 			}
 		}
@@ -34385,6 +_,7 @@
 					if (num16 > 0)
 					{
 						Main.buffString = Main.buffTip[num16];
+						int rare = 0;
 						if (num16 == 26 && Main.expertMode)
 						{
 							Main.buffString += Lang.misc[39];
@@ -34400,10 +_,10 @@
 						}
 						if (Main.meleeBuff[num16])
 						{
-							this.MouseText(Main.buffName[num16], -10, 0);
-							return;
-						}
-						this.MouseText(Main.buffName[num16], 0, 0);
+							rare = -10;
+						}
+						BuffLoader.ModifyBuffTip(num16, ref Main.buffString, ref rare);
+						this.MouseText(Main.buffName[num16], rare, 0);
 					}
 				}
 			}
@@ -35948,6 +_,10 @@
 							if (type == 439 || type == 370)
 							{
 								scale4 = 1.5f;
+							}
+							if (!NPCLoader.DrawHealthBar(Main.npc[m], ref scale4))
+							{
+								continue;
 							}
 							if ((!Main.expertMode || type != 266) && ((type != 439 && type != 440) || Main.npc[m].ai[0] != 5f))
 							{
@@ -36763,6 +_,7 @@
 			this.DrawBuilderAccToggles(new Vector2(10f, 77f));
 			ItemSlot.DrawRadialCircular(Main.spriteBatch, new Vector2((float)Main.screenWidth, (float)Main.screenHeight) / 2f);
 			ItemSlot.DrawRadialQuicks(Main.spriteBatch, new Vector2((float)Main.screenWidth, (float)Main.screenHeight) / 2f);
+			ModLoader.ModHooks.PostDrawInterface(Main.spriteBatch);
 			if (Main.mouseItem.stack <= 0)
 			{
 				Main.mouseItem.type = 0;
@@ -37424,7 +_,7 @@
 						}
 						else
 						{
-							text2 = Lang.mapLegend[MapHelper.TileToLookup(Main.player[Main.myPlayer].bestOre, 0)] + " detected nearby!";
+							text2 = Lang.mapLegend.FromType(Main.player[Main.myPlayer].bestOre) + " detected nearby!";
 						}
 						flag10 = true;
 					}
@@ -39115,7 +_,7 @@
 			}
 			else
 			{
-				if (Main.netMode == 1 || Main.menuMode == 14)
+				if (Main.netMode == 1 && menuMode < 10000 && menuMode != 888 || Main.menuMode == 14)
 				{
 					num5 = 2;
 					array9[0] = Main.statusText;
@@ -39253,7 +_,7 @@
 						{
 							text = text + " -world \"" + Main.worldPathName + "\"";
 						}
-						this.tServer.StartInfo.FileName = "TerrariaServer.exe";
+						this.tServer.StartInfo.FileName = "tModLoaderServer.exe";
 						this.tServer.StartInfo.Arguments = text;
 						if (Main.libPath != "")
 						{
@@ -39382,17 +_,26 @@
 				{
 					num5 = 3;
 					array9[0] = Lang.menu[9];
+					if (WorldIO.customDataFail != null)
+					{
+						array9[0] = WorldIO.customDataFail.modName + " " + array9[0];
+					}
 					array[0] = true;
 					num2 -= 30;
 					array4[1] = 70;
 					array4[2] = 50;
 					array9[1] = Lang.menu[10];
 					array9[2] = Lang.menu[6];
+					if (WorldIO.customDataFail != null)
+					{
+						array9[2] = "View Error";
+					}
 					if (this.selectedMenu == 1)
 					{
 						if (FileUtilities.Exists(Main.worldPathName + ".bak", Main.ActiveWorldFileData.IsCloudSave))
 						{
 							FileUtilities.Move(Main.worldPathName + ".bak", Main.worldPathName, Main.ActiveWorldFileData.IsCloudSave, true);
+							WorldIO.LoadBackup(Main.worldPathName, Main.ActiveWorldFileData.IsCloudSave);
 							Main.PlaySound(10, -1, -1, 1);
 							WorldGen.playWorld();
 							Main.menuMode = 10;
@@ -39408,7 +_,14 @@
 					{
 						flag5 = false;
 						Main.PlaySound(11, -1, -1, 1);
-						Main.menuMode = 0;
+						if (WorldIO.customDataFail == null)
+						{
+							Main.menuMode = 0;
+						}
+						else
+						{
+							ErrorLogger.LogException(WorldIO.customDataFail.InnerException);
+						}
 						Main.netMode = 0;
 					}
 				}
@@ -39416,6 +_,10 @@
 				{
 					num5 = 3;
 					array9[0] = Lang.menu[9];
+					if (WorldIO.customDataFail != null)
+					{
+						array9[0] = WorldIO.customDataFail.modName + " " + array9[0];
+					}
 					array[0] = true;
 					array[1] = true;
 					num2 -= 30;
@@ -39423,11 +_,22 @@
 					array4[2] = 50;
 					array9[1] = Lang.menu[11];
 					array9[2] = Lang.menu[5];
+					if (WorldIO.customDataFail != null)
+					{
+						array9[2] = "View Error";
+					}
 					if (this.selectedMenu == 2 || flag5)
 					{
 						flag5 = false;
 						Main.PlaySound(11, -1, -1, 1);
-						Main.menuMode = 0;
+						if (WorldIO.customDataFail == null)
+						{
+							Main.menuMode = 0;
+						}
+						else
+						{
+							ErrorLogger.LogException(WorldIO.customDataFail.InnerException);
+						}
 						Main.netMode = 0;
 					}
 				}
@@ -39510,6 +_,8 @@
 					{
 						SkyManager.Instance["Slime"].Deactivate(new object[0]);
 					}
+					Filters.Scene.DeactivateAll();
+					SkyManager.Instance.DeactivateAll();
 					int num10 = 0;
 					num5 = 5;
 					num4 = 60;
@@ -39535,6 +_,7 @@
 						Main.menuMode = 888;
 					}
 					num10++;
+					Interface.AddMenuButtons(this, this.selectedMenu, array9, array7, ref num2, ref num4, ref num10, ref num5);
 					array9[num10] = Lang.menu[14];
 					if (this.selectedMenu == num10)
 					{
@@ -41325,6 +_,10 @@
 							WorldGen.setWorldSize();
 						}
 					}
+					else
+					{
+						Interface.ModLoaderMenus(this, this.selectedMenu, array9, array7, array4, ref num2, ref num4, ref num5);
+					}
 				}
 			}
 			IL_46DD:
@@ -41910,6 +_,7 @@
 			}
 			for (int num90 = 0; num90 < num5; num90++)
 			{
+				//patch file: num5, array9, num90
 				if (array9[num90] != null)
 				{
 					Vector2 origin = Main.fontDeathText.MeasureString(array9[num90]);
@@ -42019,6 +_,7 @@
 						num99 *= array7[num90];
 						if (!array8[num90])
 						{
+							//patch file: array9, array7, array4, num2, num4
 							Main.spriteBatch.DrawString(Main.fontDeathText, array9[num90], new Vector2((float)(num3 + num97 + array5[num90]), (float)(num2 + num4 * num90 + num98) + origin.Y * array7[num90] + (float)array4[num90]), color10, 0f, origin, num99, SpriteEffects.None, 0f);
 						}
 						else
@@ -42186,10 +_,11 @@
 				{
 					num107 = 2;
 				}
-				Vector2 origin3 = Main.fontMouseText.MeasureString(Main.versionNumber);
+				string drawVersion = Main.versionNumber + Environment.NewLine + ModLoader.ModLoader.versionedName;
+				Vector2 origin3 = Main.fontMouseText.MeasureString(drawVersion);
 				origin3.X *= 0.5f;
 				origin3.Y *= 0.5f;
-				Main.spriteBatch.DrawString(Main.fontMouseText, Main.versionNumber, new Vector2(origin3.X + (float)num106 + 10f, (float)Main.screenHeight - origin3.Y + (float)num107 - 2f), color12, 0f, origin3, 1f, SpriteEffects.None, 0f);
+				Main.spriteBatch.DrawString(Main.fontMouseText, drawVersion, new Vector2(origin3.X + (float)num106 + 10f, (float)Main.screenHeight - origin3.Y + (float)num107 - 2f), color12, 0f, origin3, 1f, SpriteEffects.None, 0f);
 			}
 			Vector2 bonus = Main.DrawThickCursor(false);
 			Main.DrawCursor(bonus, false);
@@ -45240,7 +_,12 @@
 				Main.spriteBatch.End();
 				Main.spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise);
 				flag = true;
-				if (Main.screenPosition.Y > (float)((Main.maxTilesY - 232) * 16))
+				Texture2D modTexture = PlayerHooks.GetMapBackgroundImage(Main.player[Main.myPlayer]);
+				if (modTexture != null)
+				{
+					Main.spriteBatch.Draw(modTexture, new Microsoft.Xna.Framework.Rectangle(0, 0, Main.screenWidth, Main.screenHeight), Microsoft.Xna.Framework.Color.White);
+				}
+				else if (Main.screenPosition.Y > (float)((Main.maxTilesY - 232) * 16))
 				{
 					Main.spriteBatch.Draw(this.mapBG3Texture, new Microsoft.Xna.Framework.Rectangle(0, 0, Main.screenWidth, Main.screenHeight), Microsoft.Xna.Framework.Color.White);
 				}
@@ -45876,6 +_,7 @@
 					}
 					else if (type >= num96 && type < num96 + num97)
 					{
+						//patch file: num91, num92
 						Tile tile3 = Main.tile[num91, num92];
 						if (tile3 == null)
 						{
@@ -45905,7 +_,7 @@
 					}
 					else
 					{
-						text = Lang.mapLegend[type];
+						text = Lang.mapLegend.FromTile(Main.Map[num91, num92], num91, num92);
 					}
 				}
 				float num106 = (num16 * 0.25f * 2f + 1f) / 3f;
@@ -46114,6 +_,7 @@
 					}
 				}
 				Main.spriteBatch.Draw(Main.mapIconTexture[num139], new Vector2((float)num137, (float)num138), new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 0, Main.mapIconTexture[num139].Width, Main.mapIconTexture[num139].Height)), new Microsoft.Xna.Framework.Color(num140, num140, num140, num140), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
+				ModLoader.ModHooks.PostDrawFullscreenMap(ref text);
 				Vector2 bonus = Main.DrawThickCursor(false);
 				Main.DrawCursor(bonus, false);
 			}
@@ -48425,7 +_,7 @@
 						tile = new Tile();
 						Main.tile[j, i] = tile;
 					}
-					byte wall = tile.wall;
+					ushort wall = tile.wall;
 					if (wall > 0 && !this.FullTile(j, i))
 					{
 						Microsoft.Xna.Framework.Color color = Lighting.GetColor(j, i);
@@ -48433,6 +_,11 @@
 						{
 							this.LoadWall((int)wall);
 							int num9 = (int)(Main.wallFrame[(int)wall] * 180);
+							if (!WallLoader.PreDraw(j, i, wall, Main.spriteBatch))
+							{
+								WallLoader.PostDraw(j, i, wall, Main.spriteBatch);
+								continue;
+							}
 							if (Lighting.lightMode < 2 && !Main.wallLight[(int)wall] && (tile.wall < 88 || tile.wall > 93) && !WorldGen.SolidTile(tile))
 							{
 								Texture2D texture;
@@ -48504,6 +_,7 @@
 									Main.spriteBatch.Draw(Main.wallOutlineTexture, new Vector2((float)(j * 16 - (int)Main.screenPosition.X), (float)(i * 16 - (int)Main.screenPosition.Y + 14)) + zero, new Microsoft.Xna.Framework.Rectangle?(new Microsoft.Xna.Framework.Rectangle(0, 14, 16, 2)), color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
 								}
 							}
+							WallLoader.PostDraw(j, i, wall, Main.spriteBatch);
 						}
 					}
 				}
@@ -50133,7 +_,7 @@
 			}
 		}
 
-		protected void LoadNPC(int i)
+		public void LoadNPC(int i)
 		{
 			if (!Main.NPCLoaded[i] || Main.npcTexture[i] == null)
 			{
@@ -50148,7 +_,7 @@
 			}
 		}
 
-		protected void LoadProjectile(int i)
+		public void LoadProjectile(int i)
 		{
 			if (!Main.projectileLoaded[i])
 			{
@@ -50163,7 +_,7 @@
 			}
 		}
 
-		protected void LoadGore(int i)
+		public void LoadGore(int i)
 		{
 			if (!Main.goreLoaded[i])
 			{
@@ -50178,7 +_,7 @@
 			}
 		}
 
-		protected void LoadWall(int i)
+		public void LoadWall(int i)
 		{
 			if (!Main.wallLoaded[i])
 			{
@@ -50193,7 +_,7 @@
 			}
 		}
 
-		protected void LoadTiles(int i)
+		public void LoadTiles(int i)
 		{
 			if (!Main.tileSetsLoaded[i])
 			{
@@ -51902,6 +_,19 @@
 
 		protected override void Draw(GameTime gameTime)
 		{
+			try
+			{
+				do_Draw(gameTime);
+			}
+			catch (Exception e)
+			{
+				ErrorLogger.LogException(e);
+				throw;
+			}
+		}
+
+		protected void do_Draw(GameTime gameTime)
+		{
 			if (Main._drawCycleCounter == 0uL)
 			{
 				Main._tileFrameSeed = Utils.RandomNextSeed(Main._tileFrameSeed);
@@ -52065,6 +_,7 @@
 							{
 								num6 = 0.5f;
 							}
+							PlayerHooks.ModifyZoom(Main.player[Main.myPlayer], ref num6);
 							Vector2 vector2 = (Main.MouseScreen - new Vector2((float)Main.screenWidth, (float)Main.screenHeight) / 2f) / (new Vector2((float)Main.screenWidth, (float)Main.screenHeight) / 2f);
 							Vector2 vector3 = vector2;
 							num5 = 48f;
@@ -52097,8 +_,10 @@
 						{
 							num8 = 0;
 						}
-						num3 = (float)(num7 - Main.screenWidth / 2) / 1.25f;
-						num4 = (float)(num8 - Main.screenHeight / 2) / 1.25f;
+						float zoom = .8f;
+						PlayerHooks.ModifyZoom(Main.player[Main.myPlayer], ref zoom);
+						num3 = (float)(num7 - Main.screenWidth / 2) * zoom;
+						num4 = (float)(num8 - Main.screenHeight / 2) * zoom;
 					}
 					else if (Main.player[Main.myPlayer].inventory[Main.player[Main.myPlayer].selectedItem].type == 1254 && Main.mouseRight)
 					{
@@ -52120,8 +_,10 @@
 						{
 							num10 = 0;
 						}
-						num3 = (float)(num9 - Main.screenWidth / 2) / 1.5f;
-						num4 = (float)(num10 - Main.screenHeight / 2) / 1.5f;
+						float zoom = 0.6666667f;
+						PlayerHooks.ModifyZoom(Main.player[Main.myPlayer], ref zoom);
+						num3 = (float)(num9 - Main.screenWidth / 2) * zoom;
+						num4 = (float)(num10 - Main.screenHeight / 2) * zoom;
 					}
 					else if (Main.player[Main.myPlayer].inventory[Main.player[Main.myPlayer].selectedItem].type == 1299 && Main.player[Main.myPlayer].selectedItem != 58)
 					{
@@ -52143,8 +_,10 @@
 						{
 							num12 = 0;
 						}
-						num3 = (float)(num11 - Main.screenWidth / 2) / 1.5f;
-						num4 = (float)(num12 - Main.screenHeight / 2) / 1.5f;
+						float zoom = 0.6666667f;
+						PlayerHooks.ModifyZoom(Main.player[Main.myPlayer], ref zoom);
+						num3 = (float)(num11 - Main.screenWidth / 2) * zoom;
+						num4 = (float)(num12 - Main.screenHeight / 2) * zoom;
 					}
 					else if (Main.player[Main.myPlayer].scope && Main.mouseRight)
 					{
@@ -52166,8 +_,38 @@
 						{
 							num14 = 0;
 						}
-						num3 = (float)(num13 - Main.screenWidth / 2) / 2f;
-						num4 = (float)(num14 - Main.screenHeight / 2) / 2f;
+						float zoom = 0.5f;
+						PlayerHooks.ModifyZoom(Main.player[Main.myPlayer], ref zoom);
+						num3 = (float)(num13 - Main.screenWidth / 2) * zoom;
+						num4 = (float)(num14 - Main.screenHeight / 2) * zoom;
+					}
+					else
+					{
+						int mouseXClamped = Main.mouseX;
+						int mouseYClamped = Main.mouseY;
+						if (mouseXClamped > Main.screenWidth)
+						{
+							mouseXClamped = Main.screenWidth;
+						}
+						if (mouseXClamped < 0)
+						{
+							mouseXClamped = 0;
+						}
+						if (mouseYClamped > Main.screenHeight)
+						{
+							mouseYClamped = Main.screenHeight;
+						}
+						if (mouseYClamped < 0)
+						{
+							mouseYClamped = 0;
+						}
+						float zoom = -1f;
+						PlayerHooks.ModifyZoom(Main.player[Main.myPlayer], ref zoom);
+						if (zoom != -1f)
+						{
+							num3 = (float)(mouseXClamped - Main.screenWidth / 2) * zoom;
+							num4 = (float)(mouseYClamped - Main.screenHeight / 2) * zoom;
+						}
 					}
 				}
 				if (float.IsNaN(Main.zoomX))
@@ -52212,6 +_,7 @@
 				}
 				Main.screenPosition.X = (float)((int)Main.screenPosition.X);
 				Main.screenPosition.Y = (float)((int)Main.screenPosition.Y);
+				PlayerHooks.ModifyScreenPosition(Main.player[Main.myPlayer]);
 			}
 			if (!Main.gameMenu && Main.netMode != 2)
 			{
@@ -53016,6 +_,7 @@
 				this.Transform = Matrix.CreateScale(value.X, -value.Y, value.Z) * Matrix.CreateRotationZ(0f) * Matrix.CreateTranslation(new Vector3(0f, (float)Main.screenHeight, 0f));
 				this.Rasterizer = RasterizerState.CullClockwise;
 			}
+			Transform = ModHooks.ModifyTransformMatrix(Transform);
 			bool flag = !Main.drawToScreen && Main.netMode != 2 && !Main.gameMenu && !Main.mapFullscreen && Filters.Scene.HasActiveFilter();
 			if (flag)
 			{
@@ -55355,7 +_,7 @@
 								num14++;
 							}
 						}
-						for (int num16 = 0; num16 < 540; num16++)
+						for (int num16 = 0; num16 < Main.nextNPC.Length; num16++)
 						{
 							Main.nextNPC[num16] = false;
 						}
@@ -55484,6 +_,7 @@
 								if (Main.npc[num41].type == 441)
 								{
 									num39++;
+									//patch file: num40
 								}
 								num40++;
 							}
@@ -55507,6 +_,7 @@
 										{
 											if (num42 < 2000000000)
 											{
+												//patch file: num42
 												if (Main.player[num44].inventory[num45].type == 71)
 												{
 													num42 += Main.player[num44].inventory[num45].stack;
@@ -55748,6 +_,7 @@
 							{
 								WorldGen.spawnNPC = 142;
 							}
+							NPCLoader.CanTownNPCSpawn(num40, num42);
 						}
 					}
 				}
@@ -55797,11 +_,12 @@
 		public static void PlaySound(int type, int x = -1, int y = -1, int Style = 1)
 		{
 			int num = Style;
+			//patch file: num
 			try
 			{
 				if (!Main.dedServ)
 				{
-					if (Main.soundVolume != 0f || (type >= 30 && type <= 35 && type != 39))
+					if ((Main.soundVolume != 0f && !(type >= 30 && type <= 35 && type != 39)) || (Main.ambientVolume != 0f && type >= 30 && type <= 35 && type != 39))
 					{
 						bool flag = false;
 						float num2 = 1f;
@@ -55832,6 +_,7 @@
 								num3 = ((float)x - vector.X) / ((float)Main.screenWidth * 0.5f);
 								float num4 = Math.Abs((float)x - vector.X);
 								float num5 = Math.Abs((float)y - vector.Y);
+								//patch file: num2, num3
 								float num6 = (float)Math.Sqrt((double)(num4 * num4 + num5 * num5));
 								num2 = 1f - num6 / ((float)Main.screenWidth * 1.5f);
 							}
@@ -55866,6 +_,10 @@
 								}
 								if (num2 > 0f || (type >= 30 && type <= 35) || type == 39)
 								{
+									if (SoundLoader.PlayModSound(type, num, num2, num3))
+									{
+										return;
+									}
 									if (type == 0)
 									{
 										int num7 = Main.rand.Next(3);
@@ -56449,14 +_,54 @@
 										Main.soundInstanceMoonlordCry.Pitch = (float)Main.rand.Next(-10, 11) * 0.01f;
 										Main.PlaySoundInstance(Main.soundInstanceMoonlordCry);
 									}
-								}
-							}
+									else if (type == SoundLoader.customSoundType)
+									{
+										SoundLoader.customSoundInstances[num].Stop();
+										SoundLoader.customSoundInstances[num] = SoundLoader.customSounds[num].CreateInstance();
+										SoundLoader.customSoundInstances[num].Volume = num2;
+										SoundLoader.customSoundInstances[num].Pan = num3;
+										Main.PlaySoundInstance(SoundLoader.customSoundInstances[num]);
+									}
+								}
+							}
+						}
+					}
+					if (type >= 30 && type <= 35 && type != 39)
+					{
+						if (Main.ambientError > 0)
+						{
+							Main.ambientError--;
+						}
+					}
+					else
+					{
+						if (Main.soundError > 0)
+						{
+							Main.soundError--;
 						}
 					}
 				}
 			}
 			catch
 			{
+				if (type >= 30 && type <= 35 && type != 39)
+				{
+					Main.ambientError++;
+					if (Main.ambientError >= 100)
+					{
+						Main.ambientError = 0;
+						Main.ambientVolume = 0f;
+					}
+				}
+				else
+				{
+					Main.soundError++;
+					if (Main.soundError >= 100)
+					{
+						Main.soundError = 0;
+						Main.soundVolume = 0f;
+					}
+				}
 			}
 		}
 

