--- src/Terraria/Terraria/Main.cs
+++ src/tModLoader/Terraria/Main.cs
@@ -3,6 +_,7 @@
 using Microsoft.Xna.Framework.Content;
 using Microsoft.Xna.Framework.Graphics;
 using Microsoft.Xna.Framework.Input;
+using Newtonsoft.Json;
 using ReLogic.Content;
 using ReLogic.Content.Sources;
 #if MAC
@@ -19,7 +_,7 @@
 using System.Collections.Generic;
 using System.Diagnostics;
 #if WINDOWS
-using System.Drawing;
+using Size = System.Drawing.Size;
 #endif
 using System.IO;
 using System.Linq;
@@ -35,6 +_,7 @@
 #if WINDOWS
 using System.Windows.Forms;
 #endif
+using Steamworks;
 using Terraria.Achievements;
 using Terraria.Audio;
 using Terraria.Chat;
@@ -72,9 +_,16 @@
 using Terraria.IO;
 using Terraria.Localization;
 using Terraria.Map;
+using Terraria.ModLoader;
+using Terraria.ModLoader.Core;
+using Terraria.ModLoader.Default;
+using Terraria.ModLoader.Engine;
+using Terraria.ModLoader.IO;
+using Terraria.ModLoader.UI;
 using Terraria.Net;
 using Terraria.ObjectData;
 using Terraria.Social;
+using Terraria.Social.Steam;
 using Terraria.UI;
 using Terraria.UI.Chat;
 using Terraria.UI.Gamepad;
@@ -87,9 +_,9 @@
 namespace Terraria
 {
 #if SERVER
-	public class Main : Terraria.Server.Game
+	public partial class Main : Terraria.Server.Game
 #else
-	public class Main : Game
+	public partial class Main : Game
 #endif
 	{
 		public delegate void OnPlayerSelected(PlayerFileData player);
@@ -241,7 +_,7 @@
 		public static List<TitleLinkButton> TitleLinks = new List<TitleLinkButton>();
 		public static string versionNumber = "v1.4.3.2";
 		public static string versionNumber2 = "v1.4.3.2";
-		public static string SavePath = Program.LaunchParameters.ContainsKey("-savedirectory") ? Program.LaunchParameters["-savedirectory"] : Platform.Get<IPathService>().GetStoragePath("Terraria");
+		public static string SavePath = Program.SavePath;
 		public static bool AnnouncementBoxDisabled;
 		public static int AnnouncementBoxRange = -1;
 		public static string AutogenSeedName;
@@ -260,7 +_,7 @@
 		public static bool notTheBeesWorld = false;
 		public static Vector2 destroyerHB = new Vector2(0f, 0f);
 		public static FavoritesFile LocalFavoriteData = new FavoritesFile(SavePath + "/favorites.json", isCloud: false);
-		public static FavoritesFile CloudFavoritesData = new FavoritesFile("favorites.json", isCloud: true);
+		public static FavoritesFile CloudFavoritesData = new FavoritesFile("ModLoader/favorites.json", true);
 		public static FileMetadata WorldFileMetadata;
 		public static FileMetadata MapFileMetadata;
 		public static PingMapLayer Pings = new PingMapLayer();
@@ -513,12 +_,12 @@
 		public static bool showSplash = true;
 		public static bool ignoreErrors = true;
 		public static string defaultIP = "";
-		public static int dayRate = 1;
+		public static double dayRate = 1;
-		public static int desiredWorldTilesUpdateRate = 1;
+		public static double desiredWorldTilesUpdateRate = 1;
 		public static int maxScreenW = 1920;
 		public static int maxScreenH = 1200;
 		public static int minScreenW = 800;
-		public static int minScreenH = 600;
+		public static int minScreenH = 720; // Used to be '600'
 		public static float iS = 1f;
 		public static bool render;
 		public static int qaStyle;
@@ -545,7 +_,7 @@
 		public static int instantBGTransitionCounter = 2;
 		public static int bgDelay;
 		public static int bgStyle;
-		private const int BG_STYLES_COUNT = 14;
+		internal const int BG_STYLES_COUNT = 14;
 		public static float[] bgAlphaFrontLayer = new float[14];
 		public static float[] bgAlphaFarBackLayer = new float[14];
 		public static int[] bgFrame = new int[14];
@@ -559,13 +_,13 @@
 		public static int wofDrawAreaBottom;
 		public static int wofDrawFrameIndex;
 		public static int offScreenRange = 200;
-		private RenderTarget2D backWaterTarget;
+		public RenderTarget2D backWaterTarget;
 		public static RenderTarget2D waterTarget;
-		private RenderTarget2D tileTarget;
+		public RenderTarget2D tileTarget;
-		private RenderTarget2D blackTarget;
+		public RenderTarget2D blackTarget;
-		private RenderTarget2D tile2Target;
+		public RenderTarget2D tile2Target;
-		private RenderTarget2D wallTarget;
+		public RenderTarget2D wallTarget;
-		private RenderTarget2D backgroundTarget;
+		public RenderTarget2D backgroundTarget;
 		public static RenderTarget2D screenTarget;
 		public static RenderTarget2D screenTargetSwap;
 		public static int maxMapUpdates = 250000;
@@ -586,8 +_,8 @@
 		public static bool clearMap;
 		public static int mapTargetX = 5;
 		public static int mapTargetY = 2;
-		private RenderTarget2D[,] mapTarget = new RenderTarget2D[mapTargetX, mapTargetY];
+		public RenderTarget2D[,] mapTarget = new RenderTarget2D[mapTargetX, mapTargetY];
-		private RenderTarget2D mapSectionTexture;
+		public RenderTarget2D mapSectionTexture;
 		public static bool[,] initMap = new bool[mapTargetX, mapTargetY];
 		public static bool[,] mapWasContentLost = new bool[mapTargetX, mapTargetY];
 		public const int numInfoIcons = 13;
@@ -618,12 +_,12 @@
 		private int lastTileX;
 		private int firstTileY;
 		private int lastTileY;
-		private double bgParallax;
+		internal double bgParallax;
-		private int bgStartX;
+		internal int bgStartX;
-		private int bgLoops;
+		internal int bgLoops;
 		private int bgStartY;
 		private int bgLoopsY;
-		private int bgTopY;
+		internal int bgTopY;
 		public static int renderCount = 99;
 		private const int MF_BYPOSITION = 1024;
 		public static GraphicsDeviceManager graphics;
@@ -708,7 +_,7 @@
 		public const int maxItems = 400;
 		public const int maxProjectiles = 1000;
 		public const int maxNPCs = 200;
-		private static UICharacterSelect _characterSelectMenu = new UICharacterSelect();
+		internal static UICharacterSelect _characterSelectMenu = new UICharacterSelect();
 		private static UIWorldSelect _worldSelectMenu = new UIWorldSelect();
 		public static UIManageControls ManageControlsMenu = new UIManageControls();
 		public static UIAchievementsMenu AchievementsMenu = new UIAchievementsMenu();
@@ -763,7 +_,15 @@
 		public static int LogoA = 255;
 		public static int LogoB;
 		public static bool LogoT;
-		public static string statusText = "";
+		private static string _statusText = "";
+		public static string statusText {
+			get => _statusText;
+			set {
+				Logging.LogStatusChange(_statusText, value);
+
+				_statusText = value;
+			}
+		}
 		public static string worldName = "";
 		public static int worldID;
 		public static int background;
@@ -788,7 +_,7 @@
 		public static float cloudAlpha;
 		public static float maxRaining;
 		public static float oldMaxRaining;
-		public static int rainTime;
+		public static double rainTime;
 		public static bool raining;
 		public static bool eclipse;
 		public static float eclipseLight;
@@ -829,7 +_,11 @@
 		public static float invAlpha = 1f;
 		public static float invDir = 1f;
 		[ThreadStatic]
-		public static UnifiedRandom rand;
+		public static UnifiedRandom _rand;
+		public static UnifiedRandom rand {
+			get => _rand ??= new UnifiedRandom();
+			set => _rand = value;
+		}
 		public static bool allChestStackHover;
 		public static bool inventorySortMouseOver;
 		public static float GraveyardVisualIntensity;
@@ -1161,9 +_,9 @@
 		public static List<WorldFileData> WorldList = new List<WorldFileData>();
 		public static WorldFileData ActiveWorldFileData = new WorldFileData();
 		public static string WorldPath = Path.Combine(SavePath, "Worlds");
-		public static string CloudWorldPath = "worlds";
+		public static string CloudWorldPath = "ModLoader/worlds";
 		public static string PlayerPath = Path.Combine(SavePath, "Players");
-		public static string CloudPlayerPath = "players";
+		public static string CloudPlayerPath = "ModLoader/players";
 		public static Preferences Configuration = new Preferences(SavePath + Path.DirectorySeparatorChar + "config.json");
 		public static Preferences InputProfiles = new Preferences(SavePath + Path.DirectorySeparatorChar + "input profiles.json");
 		public static KeyboardState inputText;
@@ -1864,7 +_,7 @@
 		public static float exitScale = 0.8f;
 		public static bool mouseReforge;
 		public static float reforgeScale = 0.8f;
-		public static Player clientPlayer = new Player();
+		public static Player clientPlayer = new Player(); // setup inventory is unnecessary
 		public static string getIP = defaultIP;
 		public static string getPort = Convert.ToString(Netplay.ListenPort);
 		public static bool menuMultiplayer;
@@ -1971,7 +_,7 @@
 		public static bool _shouldUseWindyDayMusic = false;
 		public static bool _shouldUseStormMusic = false;
 		private int lastMusicPlayed = -1;
-		private bool playOldTile;
+		public bool playOldTile;
 		private static float _minWind = 0.34f;
 		private static float _maxWind = 0.4f;
 		private static float _minRain = 0.4f;
@@ -2008,16 +_,16 @@
 		private int selectedMenu2 = -1;
 		public static int selectedPlayer = 0;
 		public static int selectedWorld;
-		public static int menuMode;
+		public static int menuMode = Interface.loadModsID;
 		public static int menuSkip;
 		private static bool _needsLanguageSelect = true;
-		private static Item tooltipPrefixComparisonItem = new Item();
+		public static Item tooltipPrefixComparisonItem = new Item();
 		private MouseTextCache _mouseTextCache;
 		public int textBlinkerCount;
 		public int textBlinkerState;
 		public static string newWorldName = "";
-		private static int[] specX = new int[1000];
+		public static int[] specX = new int[1000];
-		private static int[] specY = new int[1000];
+		public static int[] specY = new int[1000];
 		public TilePaintSystemV2 TilePaintSystem;
 		public TileDrawing TilesRenderer;
 		public WallDrawing WallsRenderer;
@@ -2032,7 +_,7 @@
 		private List<int> _npcsWithBannersToDraw = new List<int>();
 		private bool _imeToggle;
 		private List<int> _npcTypesThatAlreadyDrewAHead = new List<int>();
-		private int[] _npcIndexWhoHoldsHeadIndex = new int[46];
+		internal int[] _npcIndexWhoHoldsHeadIndex = new int[46];
 		private static List<string> _requiredObjecsForCraftingText = new List<string>();
 		private static bool _preventCraftingBecauseClickWasUsedToChangeFocusedRecipe;
 		private static int _currentRecipeBeingCrafted = -1;
@@ -2042,7 +_,7 @@
 		public static Microsoft.Xna.Framework.Color inventoryBack = new Microsoft.Xna.Framework.Color(220, 220, 220, 220);
 		public static bool mouseText;
 		private static int mH;
-		private static int rare;
+		public static int rare;
 		public static int hairStart;
 		private static int oldHairStyle;
 		private static Microsoft.Xna.Framework.Color oldHairColor;
@@ -2054,7 +_,7 @@
 		public static Player dresserInterfaceDummy;
 		private bool _needToSetupDrawInterfaceLayers = true;
 		private List<GameInterfaceLayer> _gameInterfaceLayers;
-		private static GameTime _drawInterfaceGameTime;
+		public static GameTime _drawInterfaceGameTime;
 		private static bool _settingsButtonIsPushedToSide;
 		private static bool _MouseOversCanClear;
 		private static Vector2 _itemIconCacheScreenPosition;
@@ -2110,20 +_,20 @@
 		};
 		private static float backgroundLayerTransitionSpeed = 0.05f;
 		public static float atmo;
-		private static float bgScale = 1f;
+		internal static float bgScale = 1f;
-		private static int bgWidthScaled = (int)(1024f * bgScale);
+		internal static int bgWidthScaled = (int)(1024f * bgScale);
 		public static Microsoft.Xna.Framework.Color ColorOfTheSkies;
-		private static Microsoft.Xna.Framework.Color ColorOfSurfaceBackgroundsBase = Microsoft.Xna.Framework.Color.White;
+		internal static Microsoft.Xna.Framework.Color ColorOfSurfaceBackgroundsBase = Microsoft.Xna.Framework.Color.White;
-		private static Microsoft.Xna.Framework.Color ColorOfSurfaceBackgroundsModified = Microsoft.Xna.Framework.Color.White;
+		internal static Microsoft.Xna.Framework.Color ColorOfSurfaceBackgroundsModified = Microsoft.Xna.Framework.Color.White;
-		private float screenOff;
+		internal float screenOff;
-		private float scAdj;
+		internal float scAdj;
 		private float cTop;
 		private bool _isDrawingOrUpdating;
 		public static List<INeedRenderTargetContent> ContentThatNeedsRenderTargets = new List<INeedRenderTargetContent>();
 		public CameraModifierStack CameraModifiers = new CameraModifierStack();
 		private static string _oldNetplayStatusText;
 		private static TextSnippet[] _netplayStatusTextSnippets;
-		public static int ladyBugRainBoost = 0;
+		public static double ladyBugRainBoost = 0;
 		private static bool _canShowMeteorFall;
 		private static bool _isResizingAndRemakingTargets = false;
 
@@ -2281,7 +_,7 @@
 
 		public static int npcShop {
 			get;
-			private set;
+			internal set;
 		}
 
 		public static string playerPathName => ActivePlayerFileData.Path;
@@ -2764,6 +_,7 @@
 			}
 
 			result.X = num;
+			ItemLoader.HoldoutOffset(gravdir, itemtype, ref result);
 			return result;
 		}
 
@@ -2780,6 +_,12 @@
 			}
 		}
 
+		/// <summary>
+		/// Registers an animation for an item type to draw inside UI (not world or held item on player).
+		/// To enable its animation in the world, use ItemID.Sets.AnimatesAsSoul in conjunction with this
+		/// </summary>
+		/// <param name="index">Item type</param>
+		/// <param name="animation">Draw animation</param>
 		public static void RegisterItemAnimation(int index, DrawAnimation animation) {
 			if (!itemAnimationsRegistered.Contains(index))
 				itemAnimationsRegistered.Add(index);
@@ -2826,11 +_,13 @@
 			}
 		}
 
-		public static void SetGraphicsProfile(GraphicsProfile profile, bool forceSet) {
+		private static bool SetGraphicsProfile(GraphicsProfile profile, bool forceSet) {
 			if (_currentGraphicsProfile != profile || forceSet) {
 				_selectedGraphicsProfile = profile;
 				SetGraphicsProfileInternal();
+				return graphics.GraphicsDevice.GraphicsProfile == profile;
 			}
+			return false;
 		}
 
 		private static void SetGraphicsProfileInternal() {
@@ -2838,10 +_,14 @@
 			graphics.GraphicsProfile = _selectedGraphicsProfile;
 			switch (_selectedGraphicsProfile) {
 				case GraphicsProfile.HiDef:
+					// update resolution related variables alongside TrySupporting8K
+					Configuration.Get("Support8K", ref Support8K);
+					int hiRes = Support8K ? 8192 : 4096;
-					maxScreenW = 4096;
+					maxScreenW = hiRes;
-					maxScreenH = 4096;
+					maxScreenH = hiRes;
-					_renderTargetMaxSize = 4096;
+					_renderTargetMaxSize = hiRes;
+					if (Support8K)
-					TrySupporting8K();
+						TrySupporting8K();
 					break;
 				case GraphicsProfile.Reach:
 					maxScreenW = 1920;
@@ -2859,8 +_,8 @@
 					SetGraphicsProfileInternal();
 				}
 			}
-
-			instance.EnsureRenderTargetContent();
+			// Seems unnecessary as graphics profile is only changed very early on, before the first frame is rendered
+			// Main.instance.EnsureRenderTargetContent();
 		}
 
 		private static void TrySupporting8K() {
@@ -2889,6 +_,7 @@
 				flag2 = false;
 				anglerQuest = rand.Next(anglerQuestItemNetIDs.Length);
 				int num = anglerQuestItemNetIDs[anglerQuest];
+				//patch file: num, flag2
 				if (num == 2454 && (!hardMode || WorldGen.crimson))
 					flag2 = true;
 
@@ -2930,6 +_,8 @@
 
 				if ((num == 2476 || num == 2453 || num == 2473) && !flag)
 					flag2 = true;
+
+				ItemLoader.IsAnglerQuestAvailable(num, ref flag2);
 			}
 
 			NetMessage.SendAnglerQuest(-1);
@@ -3068,7 +_,8 @@
 		public static void SaveRecent() {
 			Utils.TryCreatingDirectory(SavePath);
 			try {
+				if (File.Exists(SavePath + Path.DirectorySeparatorChar + "servers.dat"))
-				File.SetAttributes(SavePath + Path.DirectorySeparatorChar + "servers.dat", FileAttributes.Normal);
+					File.SetAttributes(SavePath + Path.DirectorySeparatorChar + "servers.dat", FileAttributes.Normal);
 			}
 			catch {
 			}
@@ -3153,6 +_,7 @@
 			Configuration.Put("UseHeatDistortion", UseHeatDistortion);
 			Configuration.Put("WaveQuality", WaveQuality);
 			Configuration.Put("Support4K", Support4K);
+			Configuration.Put("Support8K", Support8K);
 			Configuration.Put("MouseColor", new Dictionary<string, byte> {
 				{ "R", mouseColor.R },
 				{ "G", mouseColor.G },
@@ -3179,6 +_,7 @@
 			Configuration.Put("HoverControlMode", Player.Settings.HoverControl);
 			Configuration.Put("WaterfallDrawLimit", instance.waterfallManager.maxWaterfallCount);
 			Configuration.Put("DisableIntenseVisualEffects", DisableIntenseVisualEffects);
+			ModLoader.ModLoader.SaveConfiguration();
 			if (Configuration.Save())
 				return PlayerInput.Save();
 
@@ -3261,7 +_,15 @@
 					screenBorderlessPendingResizes = 1;
 
 				SetDisplayMode(currentValue2, currentValue3, fullscreen: false);
-				TryPickingDefaultUIScale(currentValue3);
+			}
+			else {
+				FullscreenStartup();
+			}
+			TryPickingDefaultUIScale(graphics.GraphicsDevice.Adapter.CurrentDisplayMode.Height);
+
+			if (Main.dedServ) {
+				ModLoader.ModLoader.LoadConfiguration();
+				return;
 			}
 
 			Configuration.Get("SmartCursorToggle", ref cSmartCursorModeIsToggleAndNotHold);
@@ -3549,6 +_,7 @@
 				};
 			}
 
+			ModLoader.ModLoader.LoadConfiguration();
 			PlayerInput.Load();
 			if (currentValue < 165) {
 				try {
@@ -3561,8 +_,10 @@
 			mouseColorSlider.SetHSL(mouseColor);
 			mouseBorderColorSlider.SetHSL(MouseBorderColor);
 			mouseBorderColorSlider.Alpha = (float)(int)MouseBorderColor.A / 255f;
-			if (currentValue != 244)
+			if (currentValue != Main.curRelease || ModLoader.ModLoader.LastLaunchedTModLoaderVersion != BuildInfo.tMLVersion || (BuildInfo.Purpose == BuildInfo.BuildPurpose.Alpha && ModLoader.ModLoader.LastLaunchedTModLoaderAlphaSha != BuildInfo.CommitSHA)) {
+				ModLoader.ModLoader.MigrateSettings();
 				SaveSettings();
+			}
 
 			IsInTheMiddleOfLoadingSettings = false;
 		}
@@ -3690,9 +_,11 @@
 				FileUtilities.Delete(PlayerList[i].Path, PlayerList[i].IsCloudSave);
 				FileUtilities.Delete(PlayerList[i].Path + ".bak", PlayerList[i].IsCloudSave);
 			}
+			//patch context
 			catch {
 			}
 
+			PlayerIO.ErasePlayer(PlayerList[i].Path, PlayerList[i].IsCloudSave);
 			try {
 				string text = PlayerList[i].Path.Substring(0, PlayerList[i].Path.Length - 4);
 				if (text.Substring(text.Length - 1) != "." && text.Substring(text.Length - 1) != "\\" && Directory.Exists(text))
@@ -3722,6 +_,7 @@
 					SocialAPI.Cloud.Delete(WorldList[i].Path);
 				}
 
+				WorldIO.EraseWorld(WorldList[i].Path, WorldList[i].IsCloudSave);
 				LoadWorlds();
 			}
 			catch {
@@ -3910,6 +_,12 @@
 						if (text.Length >= 10 && text.Substring(0, 10).ToLower() == "worldname=")
 							worldName = text.Substring(10);
 
+						if (text.Length >= 8 && text.Substring(0, 8).ToLower() == "modpath=")
+							ModOrganizer.modPath = text.Substring(8);
+
+						if (text.Length >= 8 && text.Substring(0, 8).ToLower() == "modpack=")
+							ModOrganizer.commandLineModPack = text.Substring(8);
+
 						if (text.Length >= 5 && text.Substring(0, 5).ToLower() == "seed=")
 							AutogenSeedName = text.Substring(5);
 
@@ -4019,6 +_,8 @@
 		}
 
 		public void YouCanSleepNow() {
+			if (!dedServ && audioSystem == null) //supress extra exceptions from audio engine failing to load
+				return;
 #if WINDOWS
 			if (previousExecutionState != 0)
 				NativeMethods.SetThreadExecutionState(previousExecutionState);
@@ -4029,7 +_,7 @@
 		public void DedServ() {
 			NeverSleep();
 			rand = new UnifiedRandom();
-			if (autoShutdown) {
+			if (autoShutdown && !showServerConsole) {
 				string lpWindowName = Console.Title = "terraria" + rand.Next(int.MaxValue);
 #if WINDOWS
 				IntPtr intPtr = FindWindow(null, lpWindowName);
@@ -4038,17 +_,30 @@
 #endif
 			}
 			else {
-				Console.Title = "Terraria Server " + versionNumber2;
+				Console.Title = "Terraria Server " + versionNumber2 + " - " + ModLoader.ModLoader.versionedName;
 			}
 
 			dedServ = true;
 			showSplash = false;
 			Initialize();
+
+			bool reloadMods;
+
+			do {
+				ModLoader.ModLoader.Reload();
+				DedServ_PostModLoad(out reloadMods);
+			}
+			while (reloadMods);
+		}
+		//The split and the boolean shenanigans are here to allow mods to hook into this method with MonoMod correctly. At any load-time.
+		private void DedServ_PostModLoad(out bool reloadMods) {
+			reloadMods = false;
+
 			while (worldPathName == null || worldPathName == "") {
 				bool flag = true;
 				while (flag) {
 					LoadWorlds();
-					Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+					Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 					Console.WriteLine("");
 					for (int i = 0; i < WorldList.Count; i++) {
 						Console.WriteLine(i + 1 + "\t\t" + WorldList[i].Name);
@@ -4061,6 +_,8 @@
 					textValue2 = textValue2 + new string('\t', num - textValue2.Length / 8) + Language.GetTextValue("CLI.DeleteWorld_Description");
 					Console.WriteLine(textValue);
 					Console.WriteLine(textValue2);
+					Console.WriteLine("m\t\tMods Menu");
+					Console.WriteLine("b\t\tMod Browser");
 					Console.WriteLine("");
 					Console.Write(Language.GetTextValue("CLI.ChooseWorld"));
 					string text2 = Console.ReadLine();
@@ -4078,7 +_,7 @@
 							int length = Language.GetTextValue("CLI.DeleteWorld_Command").Length;
 							int num2 = Convert.ToInt32(text2.Substring(length + 1)) - 1;
 							if (num2 < WorldList.Count) {
-								Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+								Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 								Console.WriteLine("");
 								Console.WriteLine(Language.GetTextValue("CLI.DeleteConfirmation", WorldList[num2].Name));
 								Console.Write("({0}/{1}): ", Language.GetTextValue("CLI.ShortYes"), Language.GetTextValue("CLI.ShortNo"));
@@ -4101,7 +_,7 @@
 					if (text2 == "n" || text2 == "N") {
 						bool flag2 = true;
 						while (flag2) {
-							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 							Console.WriteLine("");
 							Console.WriteLine("1\t" + Language.GetTextValue("UI.WorldSizeSmall"));
 							Console.WriteLine("2\t" + Language.GetTextValue("UI.WorldSizeMedium"));
@@ -4140,7 +_,7 @@
 
 						flag2 = true;
 						while (flag2) {
-							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 							Console.WriteLine("");
 							Console.WriteLine("1\t" + Language.GetTextValue("UI.Normal"));
 							Console.WriteLine("2\t" + Language.GetTextValue("UI.Expert"));
@@ -4182,7 +_,7 @@
 						if (SettingsUnlock_WorldEvil) {
 							flag2 = true;
 							while (flag2) {
-								Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+								Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 								Console.WriteLine("");
 								Console.WriteLine("1\t" + Language.GetTextValue("CLI.Random"));
 								Console.WriteLine("2\t" + Language.GetTextValue("CLI.Corrupt"));
@@ -4218,7 +_,7 @@
 						}
 
 						flag2 = true;
-						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 						while (flag2) {
 							Console.WriteLine("");
 							Console.Write(Language.GetTextValue("CLI.EnterWorldName"));
@@ -4250,7 +_,7 @@
 
 						string text3 = "";
 						flag2 = true;
-						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 						while (flag2) {
 							Console.WriteLine("");
 							Console.Write(Language.GetTextValue("CLI.EnterSeed"));
@@ -4314,6 +_,19 @@
 
 						continue;
 					}
+					else if (text2 == "m" || text2 == "M") {
+						Interface.ServerModMenu(out reloadMods);
+
+						if (reloadMods) {
+							return;
+						}
+
+						continue;
+					}
+					else if (text2 == "b" || text2 == "b") {
+						Interface.ServerModBrowserMenu();
+						continue;
+					}
 
 					try {
 						int num3 = Convert.ToInt32(text2);
@@ -4323,7 +_,7 @@
 
 						bool flag3 = true;
 						while (flag3) {
-							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 							Console.WriteLine("");
 							Console.Write(Language.GetTextValue("CLI.SetInitialMaxPlayers"));
 							string text4 = Console.ReadLine();
@@ -4351,7 +_,7 @@
 
 						flag3 = true;
 						while (flag3) {
-							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 							Console.WriteLine("");
 							Console.Write(Language.GetTextValue("CLI.SetInitialPort"));
 							string text5 = Console.ReadLine();
@@ -4377,7 +_,7 @@
 
 						flag3 = true;
 						while (flag3) {
-							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+							Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 							Console.WriteLine("");
 							Console.Write(Language.GetTextValue("CLI.AutomaticPortForward", Language.GetTextValue("CLI.ShortYes"), Language.GetTextValue("CLI.ShortNo")));
 							string text6 = Console.ReadLine();
@@ -4401,7 +_,7 @@
 							}
 						}
 
-						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
+						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2) + " - " + ModLoader.ModLoader.versionedName);
 						Console.WriteLine("");
 						Console.Write(Language.GetTextValue("CLI.EnterServerPassword"));
 						Netplay.ServerPassword = Console.ReadLine();
@@ -4424,6 +_,7 @@
 			catch {
 			}
 
+			myPlayer = 255;
 			Task task2 = WorldGen.serverLoadWorld();
 			Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber));
 			Console.WriteLine("");
@@ -4446,39 +_,38 @@
 			catch {
 			}
 
+			//run one tick to JIT all the game content now rather than when a player connects
+			Logging.ServerConsoleLine("Running one update...");
+			Logging.tML.Info($"Server starting with AllowVanillaClients set to {ModNet.AllowVanillaClients}");
+			Update(new GameTime());
 			if (WorldGen.loadFailed || !WorldGen.loadSuccess) {
 				WriteFancyWorldLoadErrorToConsole();
 				if (!autoShutdown)
 					Console.ReadKey();
 
+				Logging.ResetPastExceptions(); // "Running one update..." above.
 				YouCanSleepNow();
 				return;
 			}
 
 			Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber));
 			Console.WriteLine("");
-			Console.WriteLine(Language.GetTextValue("CLI.ListeningOnPort", Netplay.ListenPort));
+			Logging.ServerConsoleLine(Language.GetTextValue("CLI.ListeningOnPort", Netplay.ListenPort));
 			Console.WriteLine(Language.GetTextValue("CLI.HelpHint"));
 			Console.WriteLine("");
 			Console.Title = "Terraria Server: " + worldName;
 			Stopwatch stopwatch = new Stopwatch();
-			if (!autoShutdown)
+			if (!autoShutdown || showServerConsole)
 				startDedInput();
 
 			stopwatch.Start();
-			double num6 = 16.666666666666668;
-			double num7 = 0.0;
-			int num8 = 0;
-			new Stopwatch().Start();
 			Netplay.StartServer();
 			gameMenu = false;
+			double delta = 1000 / 60D;
+			double target = delta;
 			while (!Netplay.Disconnect) {
-				double totalMilliseconds = stopwatch.Elapsed.TotalMilliseconds;
-				if (totalMilliseconds + num7 >= num6) {
-					num8++;
-					num7 += totalMilliseconds - num6;
-					stopwatch.Reset();
-					stopwatch.Start();
+				ServerHangWatchdog.Checkin();
+				{
 					if (oldStatusText != statusText) {
 						oldStatusText = statusText;
 						Console.WriteLine(statusText);
@@ -4492,20 +_,14 @@
 					if (Main.OnTickForThirdPartySoftwareOnly != null)
 						Main.OnTickForThirdPartySoftwareOnly();
 
-					double num9 = stopwatch.Elapsed.TotalMilliseconds + num7;
-					if (num9 < num6) {
-						int num10 = (int)(num6 - num9) - 1;
-						if (num10 > 1) {
-							Thread.Sleep(num10 - 1);
-							if (!Netplay.HasClients) {
-								num7 = 0.0;
-								Thread.Sleep(10);
-							}
-						}
-					}
-				}
+					double now = stopwatch.ElapsedMilliseconds;
+					double remaining = target - now;
+					target += delta; //new target
+					if (target < now) //can't catch up, reset target
+						target = now + delta;
 
-				Thread.Sleep(0);
+					Thread.Sleep(Math.Max((int)remaining, 0));
+				}
 			}
 
 			YouCanSleepNow();
@@ -4525,8 +_,14 @@
 
 		public static void startDedInputCallBack() {
 			while (!Netplay.Disconnect) {
-				Console.Write(": ");
 				string text = Console.ReadLine();
+				ExecuteCommand(text, new ConsoleCommandCaller());
+			}
+		}
+
+		public static void ExecuteCommand(string text, CommandCaller commandCaller) {
+			do { // use a do {...} while (false); loop so we don't have to change all the continue; statements to return; when moving the loop body into a separate function
+				Console.Write(": ");
 				string text2 = text;
 				text = text.ToLower();
 				try {
@@ -4566,12 +_,21 @@
 								num = text3.Length;
 						}
 
+						var modHelpList = CommandLoader.GetHelp(CommandType.Console);
+						foreach (var entry in modHelpList)
+							if (entry.Item1.Length > num)
+								num = entry.Item1.Length;
+
 						int num2 = (num + 1) / 8;
 						for (int j = 0; j < list.Count; j++) {
 							string text4 = Language.Exists("CLI." + list[j] + "_Example") ? Language.GetTextValue("CLI." + list[j] + "_Example") : Language.GetTextValue("CLI." + list[j] + "_Command");
 							Console.WriteLine(text4 + new string('\t', num2 - text4.Length / 8) + Language.GetTextValue("CLI." + list[j] + "_Description"));
 						}
+
+						foreach (var entry in modHelpList)
+							Console.WriteLine(entry.Item1 + new string('\t', num2 - entry.Item1.Length / 8) + entry.Item2);
 					}
+					else if (CommandLoader.HandleCommand(text, commandCaller)) { }
 					else if (text == Language.GetTextValue("CLI.Settle_Command")) {
 						if (!Liquid.panicMode)
 							Liquid.StartPanic();
@@ -4603,6 +_,8 @@
 					}
 					else if (text == Language.GetTextValue("CLI.Exit_Command")) {
 						WorldFile.SaveWorld();
+						SystemLoader.OnWorldUnload();
+						TileIO.PostExitWorldCleanup();
 						Netplay.Disconnect = true;
 						SocialAPI.Shutdown();
 					}
@@ -4657,11 +_,12 @@
 						Console.WriteLine(Language.GetTextValue("CLI.Port", Netplay.ListenPort));
 					}
 					else if (text == Language.GetTextValue("CLI.Version_Command")) {
-						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber));
+						Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber) + " - " + ModLoader.ModLoader.versionedName);
 					}
 					else if (text == Language.GetTextValue("CLI.Clear_Command")) {
 						try {
 							Console.Clear();
+							Logging.ResetPastExceptions(); // "CLI.Clear_Command" above.
 						}
 						catch {
 						}
@@ -4783,7 +_,7 @@
 				catch {
 					Console.WriteLine(Language.GetTextValue("CLI.InvalidCommand"));
 				}
-			}
+			} while (false);
 		}
 
 		public static void Sundialing() {
@@ -4803,7 +_,8 @@
 			if (fastForwardTime) {
 				dayRate = 60;
 				desiredWorldTilesUpdateRate = 1;
-				return;
+				desiredWorldEventsUpdateRate = 60;
+				goto endVanillaMethod;
 			}
 
 			bool enabled = CreativePowerManager.Instance.GetPower<CreativePowers.FreezeTime>().Enabled;
@@ -4818,10 +_,17 @@
 
 			dayRate = num;
 			desiredWorldTilesUpdateRate = num;
+			desiredWorldEventsUpdateRate = num;
 			if (gameMenu) {
 				dayRate = 1;
 				desiredWorldTilesUpdateRate = 1;
+				desiredWorldEventsUpdateRate = 1;
 			}
+
+			endVanillaMethod:
+			SystemLoader.ModifyTimeRate(ref dayRate, ref desiredWorldTilesUpdateRate, ref desiredWorldEventsUpdateRate);
+			if (dayRate > 86400)
+				dayRate = 86400;
 		}
 
 		public Main() : base(dedServ) {
@@ -4833,7 +_,7 @@
 
 			Configuration.Load();
 			graphics = new GraphicsDeviceManager(this as Game);
-			base.Content.RootDirectory = "Content";
+			GraphicsChangeTracker.Init();
 		}
 
 		private void Main_Exiting(object sender, EventArgs e) {
@@ -4842,6 +_,7 @@
 
 		private static void TryDisposingEverything() {
 			ChromaInitializer.DisableAllDeviceGroups();
+			WorkshopHelper.OnGameExitCleanup();
 			if (Assets != null) {
 				Assets.TransferCompletedAssets();
 				Assets.Dispose();
@@ -4869,6 +_,7 @@
 
 			_cachedTitle = Lang.GetRandomGameTitle();
 			Platform.Get<IWindowService>().SetUnicodeTitle(base.Window, _cachedTitle);
+			Platform.Get<IWindowService>().SetIcon(base.Window);
 		}
 
 		private static void SetTileValue() {
@@ -4907,8 +_,15 @@
 		}
 
 		protected override void Initialize() {
+			DateTime date = DateTime.Now;
+			if (date.Month == 5 && date.Day == 17 || date.Month == 7 && date.Day == 8 || date.Month == 10 && date.Day == 24
+				|| date.Month == 6 && date.Day == 1 || date.Month == 4 || date.Day == 1 || new Random().Next(100) == 0) {
+				OurFavoriteColor.R = OurFavoriteColor.B;
+				OurFavoriteColor.B = 255;
+			}
+
 			if(dedServ)
-			netMode = 2;
+				netMode = 2;
 
 			musicFade[50] = 1f;
 			for (int i = 0; i < 10; i++) {
@@ -5116,7 +_,7 @@
 			}
 
 			for (int m = 0; m < 256; m++) {
-				player[m] = new Player();
+				player[m] = new Player(); // setup inventory is unnecessary
 			}
 
 			for (int n = 0; n < 1001; n++) {
@@ -8403,11 +_,17 @@
 		public static void LoadTestLog(string logname) {
 		}
 
-		private void OnceFailedLoadingAnAsset(string assetPath, Exception e) {
+		internal static void OnceFailedLoadingAnAsset(string assetPath, Exception e) {
+			Logging.Terraria.Error($"Failed to load asset: \"{assetPath}\"", e);
 			FancyErrorPrinter.ShowFailedToLoadAssetError(e, assetPath);
 		}
 
 		protected override void LoadContent() {
+			//Added by TML.
+			Asset<Texture2D>.DefaultValue = new Texture2D(base.GraphicsDevice, 1, 1) {
+				Name = "Asynchronously-loaded Asset Dummy Texture (do not dispose or modify!)"
+			};
+
 			SoundEngine.Initialize();
 			if (base.Services.Get<IAssetRepository>() == null)
 				AssetInitializer.CreateAssetServices(base.Services);
@@ -8431,7 +_,7 @@
 				audioSystem = new DisabledAudioSystem();
 
 			AssetSourceController = new AssetSourceController(Assets, new IContentSource[1] {
-				new XnaContentSource(base.Content.RootDirectory)
+				new XnaDirectContentSource(base.Content.RootDirectory)
 			});
 
 			VanillaContentValidator.Instance = new VanillaContentValidator("Terraria.IO.Data.ResourcePacksDefaultInfo.tsv");
@@ -8442,6 +_,8 @@
 			AssetInitializer.LoadSplashAssets(asyncLoadForSounds: true);
 			ChromaInitializer.Load();
 			_gameContentLoadProcess = LoadContent_Deferred();
+
+			ModLoader.ModLoader.PrepareAssets();
 		}
 
 		private void LoadContent_TryEnteringHiDef() {
@@ -8923,6 +_,8 @@
 
 					if (SceneMetrics.ActiveMusicBox == 86)
 						newMusic = 90;
+					if (SceneMetrics.ActiveMusicBox >= maxMusic)
+						newMusic = SceneMetrics.ActiveMusicBox;
 				}
 
 				if (gameMenu || musicVolume == 0f) {
@@ -8948,12 +_,12 @@
 						curMusic = 0;
 					}
 
-					if (NPC.MoonLordCountdown == 1 && curMusic >= 1 && curMusic < 91)
+					if (NPC.MoonLordCountdown == 1 && curMusic >= 1 && curMusic < musicFade.Length)
 						musicFade[curMusic] = 0f;
 				}
 
 				bool isMainTrackAudible = musicFade[curMusic] > 0.25f;
-				for (int i = 1; i < 91; i++) {
+				for (int i = 1; i < musicFade.Length; i++) {
 					float num2 = musicFade[i] * musicVolume * num;
 					if (i >= 62 && i <= 88) {
 						num2 *= 0.9f;
@@ -9160,17 +_,22 @@
 							break;
 					}
 
-					if (NPCID.Sets.BelongsToInvasionOldOnesArmy[npc[i].type])
+					if (npc[i].type < NPCID.Sets.BelongsToInvasionOldOnesArmy.Length && NPCID.Sets.BelongsToInvasionOldOnesArmy[npc[i].type])
 						num2 = 12;
 
 					if (num2 == 0 && npc[i].boss)
 						num2 = 1;
 
-					if (num2 == 0)
+					if (num2 == 0 && (npc[i].ModNPC == null || npc[i].ModNPC.Music < 0))
 						continue;
 
 					Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)(npc[i].position.X + (float)(npc[i].width / 2)) - num, (int)(npc[i].position.Y + (float)(npc[i].height / 2)) - num, num * 2, num * 2);
 					if (rectangle.Intersects(value)) {
+						//TODO: Implement modMusic and modPriority
+						//if (npc[i].modNPC != null && npc[i].modNPC.music >= 0 && (modMusic < 0 || npc[i].modNPC.SceneEffectPriority > modPriority)) {
+						//	modMusic = npc[i].modNPC.music;
+						//	modPriority = npc[i].modNPC.SceneEffectPriority;
+						//}
 						switch (num2) {
 							case 1:
 								flag = true;
@@ -9428,6 +_,9 @@
 			if (lastMusicPlayed == 50)
 				musicNoCrossFade[51] = true;
 
+			int modMusic = -1;
+			ModLoader.SceneEffectPriority modPriority = ModLoader.SceneEffectPriority.None;
+
 			if (!showSplash) {
 				Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X, (int)screenPosition.Y, screenWidth, screenHeight);
 				int num2 = 5000;
@@ -9539,6 +_,11 @@
 
 					Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)(npc[j].position.X + (float)(npc[j].width / 2)) - num2, (int)(npc[j].position.Y + (float)(npc[j].height / 2)) - num2, num2 * 2, num2 * 2);
 					if (rectangle.Intersects(value)) {
+						//TODO: Should this be wrapped inside the new SceneEffect stuff? Not at this time, left for legacy.
+						if (npc[j].ModNPC != null && npc[j].ModNPC.Music >= 0 && (modMusic < 0 || npc[j].ModNPC.SceneEffectPriority > modPriority)) {
+							modMusic = npc[j].ModNPC.Music;
+							modPriority = npc[j].ModNPC.SceneEffectPriority;
+						}
 						switch (num3) {
 							case 1:
 								flag = true;
@@ -9593,6 +_,8 @@
 						break;
 					}
 				}
+
+				LoaderManager.Get<SceneEffectLoader>().UpdateMusic(ref modMusic, ref modPriority);
 			}
 
 			_ = (screenPosition.X + (float)(screenWidth / 2)) / 16f;
@@ -9609,13 +_,11 @@
 					else if (menuMode == 3000) {
 						newMusic = 89;
 					}
-					else if (playOldTile) {
-						newMusic = 6;
-					}
-					else if (!_isAsyncLoadComplete) {
-						newMusic = 50;
-					}
-					else if (!audioSystem.IsTrackPlaying(50)) {
+					else {
+						newMusic = MenuLoader.CurrentMenu.Music; // TODO: Music loader to make music function properly.
+					}
+
+					if (_isAsyncLoadComplete && newMusic == 50 && !audioSystem.IsTrackPlaying(50)) {
 						newMusic = 51;
 						if (musicNoCrossFade[51])
 							musicFade[51] = 1f;
@@ -9634,12 +_,18 @@
 			if (CreditsRollEvent.IsEventOngoing) {
 				newMusic = 89;
 			}
+			else if (modPriority >= SceneEffectPriority.BossHigh) { //Should this be before credits or nah?
+				newMusic = modMusic;
+			}
 			else if (player[myPlayer].happyFunTorchTime) {
 				newMusic = 13;
 			}
 			else if (flag8) {
 				newMusic = 38;
 			}
+			else if (modPriority >= SceneEffectPriority.BossMedium) {
+				newMusic = modMusic;
+			}
 			else if (flag10) {
 				newMusic = 37;
 			}
@@ -9649,6 +_,9 @@
 			else if (flag7) {
 				newMusic = 24;
 			}
+			else if (modPriority >= SceneEffectPriority.BossLow) {
+				newMusic = modMusic;
+			}
 			else if (flag15) {
 				newMusic = 57;
 			}
@@ -9670,6 +_,9 @@
 			else if (flag6) {
 				newMusic = 25;
 			}
+			else if (modPriority >= SceneEffectPriority.Event) {
+				newMusic = modMusic;
+			}
 			else if (flag14) {
 				newMusic = 56;
 			}
@@ -9685,6 +_,9 @@
 			else if (flag13) {
 				newMusic = 41;
 			}
+			else if (modPriority >= SceneEffectPriority.Environment) {
+				newMusic = modMusic;
+			}
 			else if (eclipse && (double)player[myPlayer].position.Y < worldSurface * 16.0 + (double)(screenHeight / 2)) {
 				newMusic = 27;
 			}
@@ -9706,6 +_,9 @@
 			else if (num5 < 1f) {
 				newMusic = (dayTime ? 42 : 15);
 			}
+			else if (modPriority >= SceneEffectPriority.BiomeHigh) {
+				newMusic = modMusic;
+			}
 			else if (tile[(int)(player[myPlayer].Center.X / 16f), (int)(player[myPlayer].Center.Y / 16f)].wall == 87) {
 				newMusic = 26;
 			}
@@ -9735,6 +_,9 @@
 				else
 					newMusic = 16;
 			}
+			else if (modPriority >= SceneEffectPriority.BiomeMedium) {
+				newMusic = modMusic;
+			}
 			else if (player[myPlayer].ZoneMeteor) {
 				newMusic = 2;
 			}
@@ -9759,6 +_,9 @@
 				else
 					newMusic = 14;
 			}
+			else if (modPriority >= SceneEffectPriority.BiomeLow) {
+				newMusic = modMusic;
+			}
 			else if ((double)player[myPlayer].position.Y >= worldSurface * 16.0 + (double)(screenHeight / 2) && !WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16)) {
 				if (player[myPlayer].ZoneHallow) {
 					newMusic = 11;
@@ -10010,12 +_,12 @@
 			float num3 = Math.Max(1f, 1f + 4f * cloudAlpha);
 			if (cloudBGActive > 0f) {
 				if (cloudBGActive > 1f)
-					cloudBGActive -= (float)dayRate / num3;
+					cloudBGActive -= (float)desiredWorldEventsUpdateRate / num3;
 
 				if (cloudBGActive < 1f)
 					cloudBGActive = 1f;
 
-				if (cloudBGActive == 1f && rand.Next((int)((float)(num2 * 2 / Math.Max(dayRate, 1)) * num3)) == 0) {
+				if (cloudBGActive == 1f && rand.NextDouble() <= desiredWorldEventsUpdateRate / (num2 * 2 * num3)) {
 					cloudBGActive = -rand.Next(num2 * 4, num * 4);
 					if (netMode == 2)
 						NetMessage.SendData(7);
@@ -10025,15 +_,15 @@
 			}
 
 			if (cloudBGActive < 0f) {
-				cloudBGActive += (float)dayRate * num3;
+				cloudBGActive += (float)desiredWorldEventsUpdateRate * num3;
 				if (raining)
-					cloudBGActive += (float)(2 * dayRate) * num3;
+					cloudBGActive += (float)(2 * desiredWorldEventsUpdateRate) * num3;
 			}
 
 			if (cloudBGActive > 0f)
 				cloudBGActive = 0f;
 
-			if (cloudBGActive == 0f && rand.Next((int)((float)(num2 * 12 / ((dayRate == 0) ? 1 : dayRate)) / num3)) == 0) {
+			if (cloudBGActive == 0f && rand.NextDouble() <= num3 * desiredWorldEventsUpdateRate / (num2 * 12)) {
 				cloudBGActive = rand.Next(num2 * 3, num * 2);
 				if (netMode == 2)
 					NetMessage.SendData(7);
@@ -12386,11 +_,16 @@
 		}
 
 		public static void DoUpdate_AnimateItemIcons() {
+			//Lock the collection to avoid race conditions during mod loading & unloading.
+			Monitor.Enter(itemAnimationsRegistered);
+
 			for (int i = 0; i < itemAnimationsRegistered.Count; i++) {
 				int num = itemAnimationsRegistered[i];
 				if (itemAnimations[num] != null)
 					itemAnimations[num].Update();
 			}
+
+			Monitor.Exit(itemAnimationsRegistered);
 		}
 
 		public static void QueueMainThreadAction(Action action) {
@@ -12413,7 +_,14 @@
 
 			if (!_isDrawingOrUpdating) {
 				_isDrawingOrUpdating = true;
+
+				try {
-				DoUpdate(ref gameTime);
+					DoUpdate(ref gameTime);
+				}
+				catch (Exception e) {
+					Logging.Terraria.Error(e);
+				}
+
 				CinematicManager.Instance.Update(gameTime);
 				if (netMode == 2) {
 					for (int i = 0; i < 256; i++) {
@@ -12557,6 +_,10 @@
 			}
 
 			DoUpdate_AutoSave();
+
+			if (Main.OnTickForInternalCodeOnly != null)
+				Main.OnTickForInternalCodeOnly();
+
 			if (!dedServ) {
 				ChromaInitializer.UpdateEvents();
 				Chroma.Update(GlobalTimeWrappedHourly);
@@ -12730,6 +_,9 @@
 
 					mouseLeftRelease = false;
 					mouseRightRelease = false;
+					mouseMiddleRelease = false;
+					mouseXButton1Release = false;
+					mouseXButton2Release = false;
 					if (gameMenu)
 						UpdateMenu();
 
@@ -12788,13 +_,13 @@
 
 			if (CanPauseGame()) {
 				DoUpdate_WhilePaused();
+				PlayerLoader.UpdateAutopause(player[myPlayer]);
+
 				gamePaused = true;
 				return;
 			}
 
 			gamePaused = false;
-			if (Main.OnTickForInternalCodeOnly != null)
-				Main.OnTickForInternalCodeOnly();
 
 			if ((dedServ || netMode != 1 && !gameMenu && !gamePaused) && AmbienceServer != null)
 				AmbienceServer.Update();
@@ -12809,10 +_,16 @@
 			if (netMode != 1)
 				updateCloudLayer();
 
+			if (desiredWorldEventsUpdateRate <= 0)
+				goto skipWeatherUpdates;
+
+			timePass += desiredWorldEventsUpdateRate;
-			for (int i = 0; i < dayRate; i++) {
+			for (int i = 1; i <= (int)timePass; i++) {
 				UpdateWeather(gameTime);
 			}
+			timePass %= 1.0;
 
+			skipWeatherUpdates:
 			if ((timeForVisualEffects += 1.0) >= 216000.0)
 				timeForVisualEffects = 0.0;
 
@@ -12830,6 +_,7 @@
 				Sandstorm.EmitDust();
 			}
 
+			SystemLoader.PreUpdateEntities();
 			if (!dedServ && (double)screenPosition.Y < worldSurface * 16.0 + 16.0 && netMode != 2) {
 				Star.UpdateStars();
 				Cloud.UpdateClouds();
@@ -12892,6 +_,10 @@
 
 			if (playerInventory) {
 				Recipe.GetThroughDelayedFindRecipes();
+
+				if (PlayerInput.MouseInModdedUI.Count != 0)
+					goto noScrollOnLocked;
+
 				int num = PlayerInput.ScrollWheelDelta / 120;
 				bool flag = true;
 				if (recBigList) {
@@ -12932,6 +_,9 @@
 						focusRecipe = 0;
 				}
 
+			noScrollOnLocked:
+				PlayerInput.MouseInModdedUI.Clear();
+
 				Main.player[myPlayer].dropItemCheck();
 			}
 
@@ -12975,7 +_,13 @@
 				InGameUI.Update(gameTime);
 
 			CreativeMenu.Update(gameTime);
+			SystemLoader.UpdateUI(gameTime);
+			PlayerInput.ScrollWheelDeltaForUI = 0; //TODO: Should this be before PlayerInput.ResetInputsOnActiveStateChange()?
+
+			BossBarLoader.HandleStyle(); //Has to be outside of the !gameMenu check because it deals with switching and saving the boss style in menus, including the main menu
+
+			if (!gameMenu) //Don't update IBigProgressBars in the main menu to avoid IOOB during unload when modded NPCs were alive --direwolf420
-			BigBossProgressBar.Update();
+				BigBossProgressBar.Update();
 		}
 
 		private void DoDebugFunctions() {
@@ -13096,6 +_,9 @@
 			if ((byte)Main.player[myPlayer].zone4 != (byte)player.zone4)
 				flag2 = true;
 
+			if (!BiomeLoader.CustomBiomesMatch(Main.player[myPlayer], player))
+				flag2 = true;
+
 			if (flag2)
 				NetMessage.SendData(36, -1, -1, null, myPlayer);
 
@@ -13124,7 +_,7 @@
 			}
 
 			bool flag3 = false;
-			for (int num4 = 0; num4 < 22; num4++) {
+			for (int num4 = 0; num4 < Player.MaxBuffs; num4++) {
 				if (Main.player[myPlayer].buffType[num4] != player.buffType[num4])
 					flag3 = true;
 			}
@@ -13154,6 +_,8 @@
 			if (flag)
 				NetMessage.SendData(138);
 
+			PlayerLoader.SendClientChanges(Main.player[myPlayer], clientPlayer);
+
 			clientPlayer = (Player)Main.player[myPlayer].clientClone();
 		}
 
@@ -13162,6 +_,9 @@
 		private void DoUpdateInWorld(Stopwatch sw) {
 			UpdateParticleSystems();
 			tileSolid[379] = false;
+
+			SystemLoader.PreUpdatePlayers();
+
 			int num = 0;
 			int num2 = 0;
 			sittingManager.ClearPlayerAnchors();
@@ -13195,7 +_,12 @@
 				}
 			}
 
+			SystemLoader.PostUpdatePlayers();
+
 			_gameUpdateCount++;
+
+			SystemLoader.PreUpdateNPCs();
+
 			NPC.RevengeManager.Update();
 			if (netMode != 1) {
 				try {
@@ -13244,6 +_,10 @@
 			}
 
 			CurrentFrameFlags.AnyActiveBossNPC = anyActiveBossNPC;
+
+			SystemLoader.PostUpdateNPCs();
+			SystemLoader.PreUpdateGores();
+
 			for (int l = 0; l < 600; l++) {
 				if (ignoreErrors) {
 					try {
@@ -13258,6 +_,9 @@
 				}
 			}
 
+			SystemLoader.PostUpdateGores();
+			SystemLoader.PreUpdateProjectiles();
+
 			LockOnHelper.SetUP();
 			CurrentFrameFlags.HadAnActiveInteractibleProjectile = false;
 			PreUpdateAllProjectiles();
@@ -13279,6 +_,10 @@
 			ProjectileUpdateLoopIndex = -1;
 			PostUpdateAllProjectiles();
 			LockOnHelper.SetDOWN();
+
+			SystemLoader.PostUpdateProjectiles();
+			SystemLoader.PreUpdateItems();
+
 			Item.numberOfNewItems = 0;
 			for (int n = 0; n < 400; n++) {
 				if (ignoreErrors) {
@@ -13294,6 +_,9 @@
 				}
 			}
 
+			SystemLoader.PostUpdateItems();
+			SystemLoader.PreUpdateDusts();
+
 			if (ignoreErrors) {
 				try {
 					Dust.UpdateDust();
@@ -13309,11 +_,15 @@
 				Dust.UpdateDust();
 			}
 
+			SystemLoader.PostUpdateDusts();
+
 			if (netMode != 2) {
 				CombatText.UpdateCombatText();
 				PopupText.UpdateItemText();
 			}
 
+			SystemLoader.PreUpdateTime();
+
 			if (ignoreErrors) {
 				try {
 					UpdateTime();
@@ -13326,6 +_,8 @@
 				UpdateTime();
 			}
 
+			SystemLoader.PostUpdateTime();
+
 			tileSolid[379] = true;
 			if (gameMenu && netMode != 2)
 				return;
@@ -13366,6 +_,7 @@
 					UpdateClient();
 			}
 
+			SystemLoader.PostUpdateEverything();
 			chatMonitor.Update();
 			upTimer = (float)sw.Elapsed.TotalMilliseconds;
 			if (upTimerMaxDelay > 0f)
@@ -13546,7 +_,8 @@
 			if (!inputTextEnter || !chatRelease)
 				return;
 
-			if (chatText != "") {
+			var handled = chatText.Length > 0 && chatText[0] == '/' && CommandLoader.HandleCommand(chatText, new ChatCommandCaller());
+			if (chatText != "" && !handled) {
 				ChatMessage message = ChatManager.Commands.CreateOutgoingMessage(chatText);
 				if (netMode == 1)
 					ChatHelper.SendChatMessageFromClient(message);
@@ -13562,6 +_,7 @@
 
 		private void DoUpdate_HandleInput() {
 			PlayerInput.UpdateInput();
+			SystemLoader.PostUpdateInput();
 			UpdateViewZoomKeys();
 			PlayerInput.SetZoom_Unscaled();
 			UILinkPointNavigator.Update();
@@ -14210,6 +_,7 @@
 			if (tileFrameCounter[493] < 0)
 				tileFrameCounter[493] += 120;
 
+			TileLoader.AnimateTiles();
 			AnimateTiles_CritterCages();
 		}
 
@@ -14308,6 +_,8 @@
 			if (++wallFrameCounter[243] >= num2 * 8)
 				wallFrameCounter[243] = 0;
 
+			WallLoader.AnimateWalls();
+
 			wallFrameCounter[144]++;
 			int num3 = 5;
 			int num4 = 10;
@@ -14882,15 +_,15 @@
 				X += 34;
 
 			new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
+			Vector2 vector = FontAssets.MouseText.Value.MeasureString(cursorText);
 			if (HoverItem.type > 0) {
 				MouseText_DrawItemTooltip(info, num, diff, X, Y);
 				return;
 			}
 
 			if (info.buffTooltip != null && info.buffTooltip != "")
-				MouseText_DrawBuffTooltip(info.buffTooltip, ref X, ref Y);
+				MouseText_DrawBuffTooltip(info.buffTooltip, ref X, ref Y, (int)vector.Y);
 
-			Vector2 vector = FontAssets.MouseText.Value.MeasureString(cursorText);
 			if (hackedScreenHeight != -1 && hackedScreenWidth != -1) {
 				if ((float)X + vector.X + 4f > (float)hackedScreenWidth)
 					X = (int)((float)hackedScreenWidth - vector.X - 4f);
@@ -14908,9 +_,6 @@
 
 			float num2 = (float)(int)mouseTextColor / 255f;
 			Microsoft.Xna.Framework.Color baseColor = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
-			if (num == -13)
-				baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num2), (byte)(masterColor * 200f * num2), 0, mouseTextColor);
-
 			if (num == -11)
 				baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num2), (byte)(175f * num2), (byte)(0f * num2), mouseTextColor);
 
@@ -14950,12 +_,18 @@
 			if (num == 10)
 				baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num2), (byte)(40f * num2), (byte)(100f * num2), mouseTextColor);
 
-			if (num >= 11)
+			if (num == 11)
 				baseColor = new Microsoft.Xna.Framework.Color((byte)(180f * num2), (byte)(40f * num2), (byte)(255f * num2), mouseTextColor);
 
+			if (num > 11)
+				baseColor = RarityLoader.GetRarity(num).RarityColor * num2;
+
-			if (HoverItem.expert || num == -12)
+			if (HoverItem.expert || num == ItemRarityID.Expert)
 				baseColor = new Microsoft.Xna.Framework.Color((byte)((float)DiscoR * num2), (byte)((float)DiscoG * num2), (byte)((float)DiscoB * num2), mouseTextColor);
 
+			if (HoverItem.master || num == ItemRarityID.Master)
+				baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num2), (byte)(masterColor * 200f * num2), 0, mouseTextColor);
+
 			if (diff == 1)
 				baseColor = new Microsoft.Xna.Framework.Color((byte)((float)(int)mcColor.R * num2), (byte)((float)(int)mcColor.G * num2), (byte)((float)(int)mcColor.B * num2), mouseTextColor);
 
@@ -14995,8 +_,9 @@
 				array2[i] = false;
 				array3[i] = false;
 			}
+			string[] tooltipNames = new string[num2];
 
-			MouseText_DrawItemTooltip_GetLinesInfo(HoverItem, ref yoyoLogo, ref researchLine, knockBack, ref numLines, array, array2, array3);
+			MouseText_DrawItemTooltip_GetLinesInfo(HoverItem, ref yoyoLogo, ref researchLine, knockBack, ref numLines, array, array2, array3, tooltipNames);
 			float num3 = (float)(int)mouseTextColor / 255f;
 			float num4 = num3;
 			int a = mouseTextColor;
@@ -15004,6 +_,7 @@
 				LocalPlayer.GetItemExpectedPrice(hoverItem, out int calcForSelling, out int calcForBuying);
 				int num5 = (hoverItem.isAShopItem || hoverItem.buyOnce) ? calcForBuying : calcForSelling;
 				if (hoverItem.shopSpecialCurrency != -1) {
+					tooltipNames[numLines] = "SpecialPrice";
 					CustomCurrencyManager.GetPriceText(hoverItem.shopSpecialCurrency, array, ref numLines, num5);
 					color = new Microsoft.Xna.Framework.Color((byte)(255f * num4), (byte)(255f * num4), (byte)(255f * num4), a);
 				}
@@ -15064,6 +_,7 @@
 					else
 						array[numLines] = Lang.tip[50].Value + " " + text;
 
+					tooltipNames[numLines] = "Price";
 					numLines++;
 					if (num6 > 0)
 						color = new Microsoft.Xna.Framework.Color((byte)(220f * num4), (byte)(220f * num4), (byte)(198f * num4), a);
@@ -15076,12 +_,15 @@
 				}
 				else if (hoverItem.type != 3817) {
 					array[numLines] = Lang.tip[51].Value;
+					tooltipNames[numLines] = "Price";
 					numLines++;
 					color = new Microsoft.Xna.Framework.Color((byte)(120f * num4), (byte)(120f * num4), (byte)(120f * num4), a);
 				}
 			}
 
 			Vector2 zero = Vector2.Zero;
+			List<TooltipLine> lines = ItemLoader.ModifyTooltips(HoverItem, ref numLines, tooltipNames, ref array, ref array2, ref array3, ref yoyoLogo, out Color?[] overrideColor);
+			List<DrawableTooltipLine> drawableLines = lines.Select((TooltipLine x, int i) => new DrawableTooltipLine(x, i, 0, 0, Color.White)).ToList();
 			int num12 = 0;
 			for (int j = 0; j < numLines; j++) {
 				Vector2 stringSize = ChatManager.GetStringSize(FontAssets.MouseText.Value, array[j], Vector2.One);
@@ -15120,11 +_,17 @@
 				Utils.DrawInvBG(spriteBatch, new Microsoft.Xna.Framework.Rectangle(X - num17, Y - num18, (int)zero.X + num17 * 2, (int)zero.Y + num18 + num18 / 2), new Microsoft.Xna.Framework.Color(23, 25, 81, 255) * 0.925f);
 			}
 
+			bool globalCanDraw = ItemLoader.PreDrawTooltip(HoverItem, lines.AsReadOnly(), ref X, ref Y);
 			for (int k = 0; k < numLines; k++) {
-				if (k == yoyoLogo) {
-					float num19 = 1f;
-					int num20 = (int)((float)(int)mouseTextColor * num19);
-					Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Black;
+				drawableLines[k].OriginalX = X;
+				drawableLines[k].OriginalY = Y;
+				if (drawableLines[k].mod == "Terraria" && drawableLines[k].Name == "OneDropLogo") {
+					int num20 = (int)((float)(int)mouseTextColor * 1f);
+					Color color2 = Color.Black;
+					drawableLines[k].Color = new Color(num20, num20, num20, num20);
+					if (!ItemLoader.PreDrawTooltipLine(HoverItem, drawableLines[k], ref num12) || !globalCanDraw)
+						goto PostDraw;
+
 					for (int l = 0; l < 5; l++) {
 						int num21 = X;
 						int num22 = Y + num16;
@@ -15145,17 +_,14 @@
 								num22++;
 								break;
 						}
-
-						spriteBatch.Draw(TextureAssets.OneDropLogo.Value, new Vector2(num21, num22), null, color2, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
+						Color drawColor2 = drawableLines[k].overrideColor ?? drawableLines[k].Color;
+						spriteBatch.Draw(TextureAssets.OneDropLogo.Value, new Vector2(num21, num22), null, (l != 4) ? color2 : drawColor2, drawableLines[k].rotation, drawableLines[k].origin, (drawableLines[k].baseScale.X + drawableLines[k].baseScale.Y) / 2f, SpriteEffects.None, 0f);
 					}
 				}
 				else {
 					Microsoft.Xna.Framework.Color black = Microsoft.Xna.Framework.Color.Black;
 					black = new Microsoft.Xna.Framework.Color(num4, num4, num4, num4);
-					if (k == 0) {
-						if (rare == -13)
-							black = new Microsoft.Xna.Framework.Color((byte)(255f * num4), (byte)(masterColor * 200f * num4), 0, a);
-
+					if (drawableLines[k].mod == "Terraria" && drawableLines[k].Name == "ItemName") {
 						if (rare == -11)
 							black = new Microsoft.Xna.Framework.Color((byte)(255f * num4), (byte)(175f * num4), (byte)(0f * num4), a);
 
@@ -15192,9 +_,12 @@
 						if (rare == 10)
 							black = new Microsoft.Xna.Framework.Color((byte)(255f * num4), (byte)(40f * num4), (byte)(100f * num4), a);
 
-						if (rare >= 11)
+						if (rare == 11)
 							black = new Microsoft.Xna.Framework.Color((byte)(180f * num4), (byte)(40f * num4), (byte)(255f * num4), a);
 
+						if (rare > 11)
+							black = RarityLoader.GetRarity(rare).RarityColor * num4;
+
 						if (diff == 1)
 							black = new Microsoft.Xna.Framework.Color((byte)((float)(int)mcColor.R * num4), (byte)((float)(int)mcColor.G * num4), (byte)((float)(int)mcColor.B * num4), a);
 
@@ -15203,47 +_,80 @@
 
 						if (hoverItem.expert || rare == -12)
 							black = new Microsoft.Xna.Framework.Color((byte)((float)DiscoR * num4), (byte)((float)DiscoG * num4), (byte)((float)DiscoB * num4), a);
+
+						if (hoverItem.master || rare == -13)
+							black = new Microsoft.Xna.Framework.Color((byte)(255f * num4), (byte)(masterColor * 200f * num4), 0, a);
 					}
 					else if (array2[k]) {
 						black = (array3[k] ? new Microsoft.Xna.Framework.Color((byte)(190f * num4), (byte)(120f * num4), (byte)(120f * num4), a) : new Microsoft.Xna.Framework.Color((byte)(120f * num4), (byte)(190f * num4), (byte)(120f * num4), a));
 					}
-					else if (k == numLines - 1) {
+					else if (drawableLines[k].mod == "Terraria" && drawableLines[k].Name == "Price") {
 						black = color;
 					}
 
-					if (k == researchLine)
+					if (drawableLines[k].mod == "Terraria" && drawableLines[k].Name == "JourneyResearch")
 						black = Colors.JourneyMode;
 
+					drawableLines[k].Color = black;
+					Color realLineColor = black;
+
+					if (overrideColor[k].HasValue) {
+						realLineColor = overrideColor[k].Value * num4;
+						drawableLines[k].overrideColor = realLineColor;
+					}
+
+					if (!ItemLoader.PreDrawTooltipLine(HoverItem, drawableLines[k], ref num12) || !globalCanDraw)
+						goto PostDraw;
+
-					ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, array[k], new Vector2(X, Y + num16), black, 0f, Vector2.Zero, Vector2.One);
+					ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, array[k], new Vector2(X, Y + num16), realLineColor, 0f, Vector2.Zero, Vector2.One);
 				}
+
+				PostDraw:
+				ItemLoader.PostDrawTooltipLine(HoverItem, drawableLines[k]);
 
 				num16 += (int)(FontAssets.MouseText.Value.MeasureString(array[k]).Y + (float)num12);
 			}
+
+			ItemLoader.PostDrawTooltip(HoverItem, drawableLines.AsReadOnly());
 		}
 
-		public static void MouseText_DrawItemTooltip_GetLinesInfo(Item item, ref int yoyoLogo, ref int researchLine, float oldKB, ref int numLines, string[] toolTipLine, bool[] preFixLine, bool[] badPreFixLine) {
+		public static void MouseText_DrawItemTooltip_GetLinesInfo(Item item, ref int yoyoLogo, ref int researchLine, float oldKB, ref int numLines, string[] toolTipLine, bool[] preFixLine, bool[] badPreFixLine, string[] toolTipNames) {
 			toolTipLine[0] = item.HoverName;
+			toolTipNames[0] = "ItemName";
 			if (item.favorited) {
 				toolTipLine[numLines++] = Lang.tip[56].Value;
+				toolTipNames[numLines - 1] = "Favorite";
 				toolTipLine[numLines++] = Lang.tip[57].Value;
+				toolTipNames[numLines - 1] = "FavoriteDesc";
 				if (LocalPlayer.chest != -1) {
 					ChestUI.GetContainerUsageInfo(out bool _, out Item[] chestinv);
-					if (ChestUI.IsBlockedFromTransferIntoChest(item, chestinv))
+					if (ChestUI.IsBlockedFromTransferIntoChest(item, chestinv)) {
 						toolTipLine[numLines++] = Language.GetTextValue("UI.ItemCannotBePlacedInsideItself");
+						toolTipNames[numLines - 1] = "NoTransfer";
+					}
 				}
 			}
 
 			if (item.social) {
 				toolTipLine[numLines] = Lang.tip[0].Value;
+				toolTipNames[numLines] = "Social";
 				numLines++;
 				toolTipLine[numLines] = Lang.tip[1].Value;
+				toolTipNames[numLines] = "SocialDesc";
 				numLines++;
 			}
 			else {
 				if (item.damage > 0 && (!item.notAmmo || item.useStyle != 0) && (item.type < 71 || item.type > 74 || player[myPlayer].HasItem(905))) {
-					float num = 5E-06f;
-					int damage = item.damage;
+					LocalizedText tip;
+					if (item.DamageType != null) {
+						tip = new LocalizedText("", " "+item.DamageType.DisplayName);
+					}
+					else {
+						tip = Lang.tip[55]; // No damage class
+					}
+					int damage = player[myPlayer].GetWeaponDamage(item);
 					damage = (int)((float)damage * ItemID.Sets.ToolTipDamageMultiplier[item.type]);
+					/*
 					if (item.melee) {
 						toolTipLine[numLines] = (((int)(player[myPlayer].meleeDamage * (float)damage + num)).ToString() ?? "");
 						toolTipLine[numLines] += Lang.tip[2].Value;
@@ -15277,8 +_,12 @@
 						toolTipLine[numLines] = (damage.ToString() ?? "");
 						toolTipLine[numLines] += Lang.tip[55].Value;
 					}
+					*/
+					toolTipLine[numLines] = damage + tip.Value;
+					toolTipNames[numLines] = "Damage";
 
 					numLines++;
+					/*
 					if (item.melee) {
 						int num3 = player[myPlayer].meleeCrit - player[myPlayer].inventory[player[myPlayer].selectedItem].crit + item.crit;
 						toolTipLine[numLines] = num3 + Lang.tip[5].Value;
@@ -15294,6 +_,14 @@
 						toolTipLine[numLines] = num5 + Lang.tip[5].Value;
 						numLines++;
 					}
+					*/
+					// TODO: make this not inherently exclude summons. minions should be allowed to crit in the right circumstances, too
+					if (!item.summon) {
+						int crit = player[myPlayer].GetWeaponCrit(item);
+						toolTipLine[numLines] = crit + Lang.tip[5].Value;
+						toolTipNames[numLines] = "CritChance";
+						numLines++;
+					}
 
 					if (item.useStyle != 0 && !item.summon) {
 						if (item.useAnimation <= 8)
@@ -15313,10 +_,13 @@
 						else
 							toolTipLine[numLines] = Lang.tip[13].Value;
 
+						toolTipNames[numLines] = "Speed";
 						numLines++;
 					}
 
 					float num6 = item.knockBack;
+					num6 = player[myPlayer].GetWeaponKnockback(item, num6);
+					/*
 					if (item.summon)
 						num6 += player[myPlayer].minionKB;
 
@@ -15326,6 +_,9 @@
 					if (player[myPlayer].inventory[player[myPlayer].selectedItem].type == 3106 && item.type == 3106)
 						num6 += num6 * (1f - player[myPlayer].stealth);
 
+					ItemLoader.GetWeaponKnockback(item, player[myPlayer], ref num6);
+					PlayerLoader.GetWeaponKnockback(player[myPlayer], item, ref num6);
+					*/
 					if (num6 == 0f)
 						toolTipLine[numLines] = Lang.tip[14].Value;
 					else if ((double)num6 <= 1.5)
@@ -15345,67 +_,80 @@
 					else
 						toolTipLine[numLines] = Lang.tip[22].Value;
 
+					toolTipNames[numLines] = "Knockback";
 					numLines++;
 				}
 
 				if (item.fishingPole > 0) {
 					toolTipLine[numLines] = Language.GetTextValue("GameUI.PrecentFishingPower", item.fishingPole);
+					toolTipNames[numLines] = "FishingPower";
 					numLines++;
 					toolTipLine[numLines] = Language.GetTextValue("GameUI.BaitRequired");
+					toolTipNames[numLines] = "NeedsBait";
 					numLines++;
 				}
 
 				if (item.bait > 0) {
 					toolTipLine[numLines] = Language.GetTextValue("GameUI.BaitPower", item.bait);
+					toolTipNames[numLines] = "BaitPower";
 					numLines++;
 				}
 
 				if (item.headSlot > 0 || item.bodySlot > 0 || item.legSlot > 0 || item.accessory || projHook[item.shoot] || item.mountType != -1 || (item.buffType > 0 && (lightPet[item.buffType] || vanityPet[item.buffType]))) {
 					if ((item.type == 854 || item.type == 3035) && npcShop > 0)
 						toolTipLine[numLines] = Lang.tip[60].Value;
-					else
+					else {
 						toolTipLine[numLines] = Lang.tip[23].Value;
-
+						toolTipNames[numLines] = "Equipable";
+					}
 					numLines++;
 				}
 
 				if (item.tileWand > 0) {
 					toolTipLine[numLines] = Lang.tip[52].Value + Lang.GetItemNameValue(item.tileWand);
+					toolTipNames[numLines] = "WandConsumes";
 					numLines++;
 				}
 
 				if (item.questItem) {
 					toolTipLine[numLines] = Lang.inter[65].Value;
+					toolTipNames[numLines] = "Quest";
 					numLines++;
 				}
 
 				if (item.vanity) {
 					toolTipLine[numLines] = Lang.tip[24].Value;
+					toolTipNames[numLines] = "Vanity";
 					numLines++;
 				}
 
 				if (!item.vanity && item.FitsAccessoryVanitySlot) {
 					toolTipLine[numLines] = Language.GetText("Misc.CanBePlacedInVanity").Value;
+					toolTipNames[numLines] = "VanityLegal";
 					numLines++;
 				}
 
 				if (item.defense > 0) {
 					toolTipLine[numLines] = item.defense + Lang.tip[25].Value;
+					toolTipNames[numLines] = "Defense";
 					numLines++;
 				}
 
 				if (item.pick > 0) {
 					toolTipLine[numLines] = item.pick + Lang.tip[26].Value;
+					toolTipNames[numLines] = "PickPower";
 					numLines++;
 				}
 
 				if (item.axe > 0) {
 					toolTipLine[numLines] = item.axe * 5 + Lang.tip[27].Value;
+					toolTipNames[numLines] = "AxePower";
 					numLines++;
 				}
 
 				if (item.hammer > 0) {
 					toolTipLine[numLines] = item.hammer + Lang.tip[28].Value;
+					toolTipNames[numLines] = "HammerPower";
 					numLines++;
 				}
 
@@ -15416,41 +_,49 @@
 					else
 						toolTipLine[numLines] = tileBoost + Lang.tip[54].Value;
 
+					toolTipNames[numLines] = "TileBoost";
 					numLines++;
 				}
 
 				if (item.healLife > 0) {
 					toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.RestoresLife", item.healLife);
+					toolTipNames[numLines] = "HealLife";
 					numLines++;
 				}
 
 				if (item.healMana > 0) {
 					toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.RestoresMana", item.healMana);
+					toolTipNames[numLines] = "HealMana";
 					numLines++;
 				}
 
 				if (item.mana > 0 && (item.type != 127 || !player[myPlayer].spaceGun)) {
 					toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.UsesMana", (int)((float)item.mana * player[myPlayer].manaCost));
+					toolTipNames[numLines] = "UseMana";
 					numLines++;
 				}
 
 				if (item.createWall > 0 || item.createTile > -1) {
 					if (item.type != 213 && item.tileWand < 1) {
 						toolTipLine[numLines] = Lang.tip[33].Value;
+						toolTipNames[numLines] = "Placeable";
 						numLines++;
 					}
 				}
 				else if (item.ammo > 0 && !item.notAmmo) {
 					toolTipLine[numLines] = Lang.tip[34].Value;
+					toolTipNames[numLines] = "Ammo";
 					numLines++;
 				}
 				else if (item.consumable) {
 					toolTipLine[numLines] = Lang.tip[35].Value;
+					toolTipNames[numLines] = "Consumable";
 					numLines++;
 				}
 
 				if (item.material) {
 					toolTipLine[numLines] = Lang.tip[36].Value;
+					toolTipNames[numLines] = "Material";
 					numLines++;
 				}
 
@@ -15458,10 +_,12 @@
 					for (int i = 0; i < item.ToolTip.Lines; i++) {
 						if (i == 0 && ItemID.Sets.UsesCursedByPlanteraTooltip[item.type] && !NPC.downedPlantBoss) {
 							toolTipLine[numLines] = Lang.tip[59].Value;
+							toolTipNames[numLines] = "Tooltip" + i.ToString();
 							numLines++;
 						}
 						else {
 							toolTipLine[numLines] = item.ToolTip.GetLine(i);
+							toolTipNames[numLines] = "Tooltip" + i.ToString();
 							numLines++;
 						}
 					}
@@ -15474,16 +_,19 @@
 
 				if ((item.type == 3818 || item.type == 3819 || item.type == 3820 || item.type == 3824 || item.type == 3825 || item.type == 3826 || item.type == 3829 || item.type == 3830 || item.type == 3831 || item.type == 3832 || item.type == 3833 || item.type == 3834) && !player[myPlayer].downedDD2EventAnyDifficulty) {
 					toolTipLine[numLines] = Lang.misc[104].Value;
+					toolTipNames[numLines] = "EtherianManaWarning";
 					numLines++;
 				}
 
 				if (item.buffType > 0 && BuffID.Sets.IsWellFed[item.buffType] && expertMode) {
 					toolTipLine[numLines] = Lang.misc[40].Value;
+					toolTipNames[numLines] = "WellFedExpert";
 					numLines++;
 				}
 
 				if (item.buffTime > 0) {
 					string text = (item.buffTime / 60 < 60) ? Language.GetTextValue("CommonItemTooltip.SecondDuration", Math.Round((double)item.buffTime / 60.0)) : Language.GetTextValue("CommonItemTooltip.MinuteDuration", Math.Round((double)(item.buffTime / 60) / 60.0));
+					toolTipNames[numLines] = "BuffTime";
 					toolTipLine[numLines] = text;
 					numLines++;
 				}
@@ -15491,6 +_,7 @@
 				if (item.type == 3262 || item.type == 3282 || item.type == 3283 || item.type == 3284 || item.type == 3285 || item.type == 3286 || item.type == 3316 || item.type == 3315 || item.type == 3317 || item.type == 3291 || item.type == 3389) {
 					toolTipLine[numLines] = " ";
 					yoyoLogo = numLines;
+					toolTipNames[numLines] = "OneDropLogo";
 					numLines++;
 				}
 
@@ -15514,6 +_,7 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixDamage";
 						numLines++;
 					}
 
@@ -15531,6 +_,7 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixSpeed";
 						numLines++;
 					}
 
@@ -15545,6 +_,7 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixCritChance";
 						numLines++;
 					}
 
@@ -15561,6 +_,7 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixUseMana";
 						numLines++;
 					}
 
@@ -15577,6 +_,7 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixSize";
 						numLines++;
 					}
 
@@ -15593,6 +_,7 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixShootSpeed";
 						numLines++;
 					}
 
@@ -15609,137 +_,160 @@
 							badPreFixLine[numLines] = true;
 
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixKnockback";
 						numLines++;
 					}
 
 					if (item.prefix == 62) {
 						toolTipLine[numLines] = "+1" + Lang.tip[25].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDefense";
 						numLines++;
 					}
 
 					if (item.prefix == 63) {
 						toolTipLine[numLines] = "+2" + Lang.tip[25].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDefense";
 						numLines++;
 					}
 
 					if (item.prefix == 64) {
 						toolTipLine[numLines] = "+3" + Lang.tip[25].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDefense";
 						numLines++;
 					}
 
 					if (item.prefix == 65) {
 						toolTipLine[numLines] = "+4" + Lang.tip[25].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDefense";
 						numLines++;
 					}
 
 					if (item.prefix == 66) {
 						toolTipLine[numLines] = "+20 " + Lang.tip[31].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMaxMana";
 						numLines++;
 					}
 
 					if (item.prefix == 67) {
 						toolTipLine[numLines] = "+2" + Lang.tip[5].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccCritChance";
 						numLines++;
 					}
 
 					if (item.prefix == 68) {
 						toolTipLine[numLines] = "+4" + Lang.tip[5].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccCritChance";
 						numLines++;
 					}
 
 					if (item.prefix == 69) {
 						toolTipLine[numLines] = "+1" + Lang.tip[39].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDamage";
 						numLines++;
 					}
 
 					if (item.prefix == 70) {
 						toolTipLine[numLines] = "+2" + Lang.tip[39].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDamage";
 						numLines++;
 					}
 
 					if (item.prefix == 71) {
 						toolTipLine[numLines] = "+3" + Lang.tip[39].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDamage";
 						numLines++;
 					}
 
 					if (item.prefix == 72) {
 						toolTipLine[numLines] = "+4" + Lang.tip[39].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccDamage";
 						numLines++;
 					}
 
 					if (item.prefix == 73) {
 						toolTipLine[numLines] = "+1" + Lang.tip[46].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMoveSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 74) {
 						toolTipLine[numLines] = "+2" + Lang.tip[46].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMoveSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 75) {
 						toolTipLine[numLines] = "+3" + Lang.tip[46].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMoveSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 76) {
 						toolTipLine[numLines] = "+4" + Lang.tip[46].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMoveSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 77) {
 						toolTipLine[numLines] = "+1" + Lang.tip[47].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMeleeSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 78) {
 						toolTipLine[numLines] = "+2" + Lang.tip[47].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMeleeSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 79) {
 						toolTipLine[numLines] = "+3" + Lang.tip[47].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMeleeSpeed";
 						numLines++;
 					}
 
 					if (item.prefix == 80) {
 						toolTipLine[numLines] = "+4" + Lang.tip[47].Value;
 						preFixLine[numLines] = true;
+						toolTipNames[numLines] = "PrefixAccMeleeSpeed";
 						numLines++;
 					}
 				}
 
 				if (item.wornArmor && player[myPlayer].setBonus != "") {
 					toolTipLine[numLines] = Lang.tip[48].Value + " " + player[myPlayer].setBonus;
+					toolTipNames[numLines] = "SetBonus";
 					numLines++;
 				}
 			}
 
 			if (item.expert) {
 				toolTipLine[numLines] = Language.GetTextValue("GameUI.Expert");
+				toolTipNames[numLines] = "Expert";
 				numLines++;
 			}
 
-			if (item.rare == -13) {
+			if (item.master) {
 				toolTipLine[numLines] = Language.GetTextValue("GameUI.Master");
+				toolTipNames[numLines] = "Master";
 				numLines++;
 			}
 
@@ -15748,6 +_,7 @@
 				if (amountNeeded - sacrificeCount > 0) {
 					toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.CreativeSacrificeNeeded", amountNeeded - sacrificeCount);
 					researchLine = numLines;
+					toolTipNames[numLines] = "JourneyResearch";
 					numLines++;
 				}
 			}
@@ -15757,11 +_,12 @@
 				string[] array = bestiaryNotes.Split('\n');
 				foreach (string text2 in array) {
 					toolTipLine[numLines++] = text2;
+					toolTipNames[numLines - 1] = "BestiaryNotes";
 				}
 			}
 		}
 
-		private void MouseText_DrawBuffTooltip(string buffString, ref int X, ref int Y) {
+		private void MouseText_DrawBuffTooltip(string buffString, ref int X, ref int Y, int buffNameHeight) {
 			Microsoft.Xna.Framework.Point p = new Microsoft.Xna.Framework.Point(X, Y);
 			int num = 220;
 			int num2 = 72;
@@ -15776,7 +_,7 @@
 
 			if (bannerMouseOver) {
 				int num6 = 0;
-				for (int i = 0; i < 289; i++) {
+				for (int i = 0; i < NPCLoader.NPCCount; i++) {
 					if (Item.BannerToNPC(i) != 0 && player[myPlayer].HasNPCBannerBuff(i)) {
 						num6++;
 						string nPCNameValue = Lang.GetNPCNameValue(Item.BannerToNPC(i));
@@ -15801,6 +_,7 @@
 				}
 			}
 
+			BuffLoader.CustomBuffTipSize(buffString, list);
 			Vector2 zero = Vector2.Zero;
 			foreach (Vector2 item2 in list) {
 				if (zero.X < item2.X)
@@ -15818,7 +_,7 @@
 
 			for (int k = 0; k < 5; k++) {
 				int num11 = X;
-				int num12 = Y + (int)FontAssets.MouseText.Value.MeasureString(buffString).Y;
+				int num12 = Y + buffNameHeight;
 				Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Black;
 				switch (k) {
 					case 0:
@@ -15845,7 +_,7 @@
 				return;
 
 			int num13 = 0;
-			for (int l = 0; l < 289; l++) {
+			for (int l = 0; l < NPCLoader.NPCCount; l++) {
 				if (Item.BannerToNPC(l) == 0 || !player[myPlayer].HasNPCBannerBuff(l))
 					continue;
 
@@ -15887,9 +_,12 @@
 					spriteBatch.DrawString(FontAssets.MouseText.Value, text, new Vector2(num14, num15), color2, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
 				}
 
+				// TODO: BuffLoader.DrawCustomBuffTip here? This is new to fix too many banner buffs I think.
 				if (flag)
 					break;
 			}
+
+			BuffLoader.DrawCustomBuffTip(buffString, spriteBatch, X, Y + (int)FontAssets.MouseText.Value.MeasureString(buffString).Y);
 		}
 
 		protected void DrawFPS() {
@@ -16121,7 +_,7 @@
 					continue;
 
 				bool flag = false;
-				if (((gore[i].type >= 706 && gore[i].type <= 717) || gore[i].type == 943 || gore[i].type == 1147 || (gore[i].type >= 1160 && gore[i].type <= 1162)) && (gore[i].frame < 7 || gore[i].frame > 9))
+				if (GoreID.Sets.DrawBehind[gore[i].type] && (gore[i].type >= GoreID.Count || gore[i].frame is < 7 or > 9))
 					flag = true;
 
 				if (flag) {
@@ -16129,11 +_,11 @@
 					if (gore[i].Frame.ColumnCount > 1 || gore[i].Frame.RowCount > 1) {
 						Microsoft.Xna.Framework.Rectangle sourceRectangle = gore[i].Frame.GetSourceRectangle(TextureAssets.Gore[gore[i].type].Value);
 						Microsoft.Xna.Framework.Color alpha = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)sourceRectangle.Width * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)sourceRectangle.Height * 0.5) / 16.0)));
-						spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(sourceRectangle.Width / 2), gore[i].position.Y - screenPosition.Y + (float)(sourceRectangle.Height / 2) - 2f), sourceRectangle, alpha, gore[i].rotation, new Vector2(sourceRectangle.Width / 2, sourceRectangle.Height / 2), gore[i].scale, SpriteEffects.None, 0f);
+						spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X + gore[i].drawOffset.X - screenPosition.X + (float)(sourceRectangle.Width / 2), gore[i].position.Y + gore[i].drawOffset.Y - screenPosition.Y + (float)(sourceRectangle.Height / 2) - 2f), sourceRectangle, alpha, gore[i].rotation, new Vector2(sourceRectangle.Width / 2, sourceRectangle.Height / 2), gore[i].scale, SpriteEffects.None, 0f);
 					}
 					else {
 						Microsoft.Xna.Framework.Color alpha2 = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)TextureAssets.Gore[gore[i].type].Width() * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)TextureAssets.Gore[gore[i].type].Height() * 0.5) / 16.0)));
-						spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(TextureAssets.Gore[gore[i].type].Width() / 2), gore[i].position.Y - screenPosition.Y + (float)(TextureAssets.Gore[gore[i].type].Height() / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Gore[gore[i].type].Width(), TextureAssets.Gore[gore[i].type].Height()), alpha2, gore[i].rotation, new Vector2(TextureAssets.Gore[gore[i].type].Width() / 2, TextureAssets.Gore[gore[i].type].Height() / 2), gore[i].scale, SpriteEffects.None, 0f);
+						spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X + gore[i].drawOffset.X - screenPosition.X + (float)(TextureAssets.Gore[gore[i].type].Width() / 2), gore[i].position.Y + gore[i].drawOffset.Y - screenPosition.Y + (float)(TextureAssets.Gore[gore[i].type].Height() / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Gore[gore[i].type].Width(), TextureAssets.Gore[gore[i].type].Height()), alpha2, gore[i].rotation, new Vector2(TextureAssets.Gore[gore[i].type].Width() / 2, TextureAssets.Gore[gore[i].type].Height() / 2), gore[i].scale, SpriteEffects.None, 0f);
 					}
 				}
 			}
@@ -16145,7 +_,7 @@
 				if (!gore[i].active || gore[i].type <= 0)
 					continue;
 
-				if (((gore[i].type >= 706 && gore[i].type <= 717) || gore[i].type == 943 || gore[i].type == 1147 || (gore[i].type >= 1160 && gore[i].type <= 1162)) && (gore[i].frame < 7 || gore[i].frame > 9)) {
+				if (GoreID.Sets.DrawBehind[gore[i].type] && (gore[i].type >= GoreID.Count || gore[i].frame is < 7 or > 9)) {
 					drawBackGore = true;
 					continue;
 				}
@@ -16158,11 +_,11 @@
 						value.Y += 4f;
 
 					Microsoft.Xna.Framework.Color alpha = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)sourceRectangle.Width * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)sourceRectangle.Height * 0.5) / 16.0)));
-					spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(sourceRectangle.Width / 2), gore[i].position.Y - screenPosition.Y + (float)(sourceRectangle.Height / 2) - 2f) + value, sourceRectangle, alpha, gore[i].rotation, new Vector2(sourceRectangle.Width / 2, sourceRectangle.Height / 2), gore[i].scale, SpriteEffects.None, 0f);
+					spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X + gore[i].drawOffset.X - screenPosition.X + (float)(sourceRectangle.Width / 2), gore[i].position.Y + gore[i].drawOffset.Y - screenPosition.Y + (float)(sourceRectangle.Height / 2) - 2f) + value, sourceRectangle, alpha, gore[i].rotation, new Vector2(sourceRectangle.Width / 2, sourceRectangle.Height / 2), gore[i].scale, SpriteEffects.None, 0f);
 				}
 				else {
 					Microsoft.Xna.Framework.Color alpha2 = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)TextureAssets.Gore[gore[i].type].Width() * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)TextureAssets.Gore[gore[i].type].Height() * 0.5) / 16.0)));
-					spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(TextureAssets.Gore[gore[i].type].Width() / 2), gore[i].position.Y - screenPosition.Y + (float)(TextureAssets.Gore[gore[i].type].Height() / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Gore[gore[i].type].Width(), TextureAssets.Gore[gore[i].type].Height()), alpha2, gore[i].rotation, new Vector2(TextureAssets.Gore[gore[i].type].Width() / 2, TextureAssets.Gore[gore[i].type].Height() / 2), gore[i].scale, SpriteEffects.None, 0f);
+					spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X + gore[i].drawOffset.X - screenPosition.X + (float)(TextureAssets.Gore[gore[i].type].Width() / 2), gore[i].position.Y + gore[i].drawOffset.Y - screenPosition.Y + (float)(TextureAssets.Gore[gore[i].type].Height() / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Gore[gore[i].type].Width(), TextureAssets.Gore[gore[i].type].Height()), alpha2, gore[i].rotation, new Vector2(TextureAssets.Gore[gore[i].type].Width() / 2, TextureAssets.Gore[gore[i].type].Height() / 2), gore[i].scale, SpriteEffects.None, 0f);
 				}
 			}
 
@@ -16249,6 +_,8 @@
 			float num = 0f;
 			if (theNPC.type == 125)
 				num = 30f;
+			else if (theNPC.ModNPC != null)
+				num = theNPC.ModNPC.DrawOffsetY;
 			else if (theNPC.type == 54)
 				num = 2f;
 			else if (theNPC.type == 205)
@@ -16449,7 +_,7 @@
 			Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X - 800, (int)screenPosition.Y - 800, screenWidth + 1600, screenHeight + 1600);
 			for (int num = 199; num >= 0; num--) {
 				try {
-					if (npc[num].active && npc[num].type > 0 && npc[num].type < 670 && !npc[num].hide) {
+					if (npc[num].active && npc[num].type > 0 && !npc[num].hide) {
 						npc[num].position += npc[num].netOffset;
 						if (npc[num].behindTiles == behindTiles) {
 							if (npc[num].type == 125 || npc[num].type == 126) {
@@ -16566,12 +_,12 @@
 			}
 		}
 
-		protected void DrawNPCCheckAlt(NPC n) {
+		public void DrawNPCCheckAlt(NPC n) {
 			if (TownNPCProfiles.Instance.GetProfile(n.type, out ITownNPCProfile profile))
 				TextureAssets.Npc[n.type] = profile.GetTextureNPCShouldUse(n);
 		}
 
-		protected void DrawNPC(int iNPCIndex, bool behindTiles) {
+		public void DrawNPC(int iNPCIndex, bool behindTiles) {
 			NPC rCurrentNPC = npc[iNPCIndex];
 			Vector2 screenPos = screenPosition;
 			DrawNPCDirect(spriteBatch, rCurrentNPC, behindTiles, screenPos);
@@ -16967,6 +_,17 @@
 				}
 			}
 
+			NPCLoader.DrawEffects(rCurrentNPC, ref npcColor); //TODO: Effects were previously done before drawing, here, but 1.4 moved them to updates in UpdateNPC_BuffApplyVFX(). Should this hook be moved and renamed? --Mirsario
+
+			if (NPCLoader.PreDraw(rCurrentNPC, spriteBatch, screenPos, npcColor)) {
+				DrawNPCDirect_Inner(spriteBatch, rCurrentNPC, behindTiles, screenPos, ref npcColor);
+			}
+
+			NPCLoader.PostDraw(rCurrentNPC, spriteBatch, screenPos, npcColor);
+		}
+
+		private void DrawNPCDirect_Inner(SpriteBatch mySpriteBatch, NPC rCurrentNPC, bool behindTiles, Vector2 screenPos, ref Color npcColor) {
+			int type = rCurrentNPC.type;
 			npcColor = rCurrentNPC.GetNPCColorTintedByBuffs(npcColor);
 			if (type == 50) {
 				Vector2 zero = Vector2.Zero;
@@ -20383,12 +_,14 @@
 				}
 
 				instance.LoadItem(num8);
+				NPCLoader.DrawTownAttackGun(n, ref num7, ref num8, ref num9);
 				Texture2D value3 = TextureAssets.Item[num8].Value;
 				int num10 = (int)DrawPlayerItemPos(1f, num8).X - num9;
 				Vector2 origin2 = new Vector2(-num10, value3.Height / 2);
 				if (n.spriteDirection == -1)
 					origin2 = new Vector2(value3.Width + num10, value3.Height / 2);
 
+				//patch context
 				spriteBatch.Draw(value3, new Vector2((int)(vector2.X - screenPosition.X), (int)(vector2.Y - screenPosition.Y)), null, npcColor, rotation, origin2, n.scale * num7, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
 				if (n.type == 22 && n.frame.Y / (TextureAssets.Npc[n.type].Height() / npcFrameCount[n.type]) >= 21) {
 					Texture2D value4 = TextureAssets.Extra[52].Value;
@@ -20448,6 +_,7 @@
 						zero.Y = 12f;
 				}
 
+				NPCLoader.DrawTownAttackSwing(n, ref value9, ref num11, ref scaleFactor, ref zero);
 				Tuple<Vector2, float> swingStats = n.GetSwingStats(NPCID.Sets.AttackTime[n.type] * 2, (int)n.ai[1], n.spriteDirection, num11, num11);
 				Vector2 vector4 = swingStats.Item1 + (swingStats.Item1 - n.Center) * scaleFactor + zero;
 				Vector2 origin4 = value9.Size() * new Vector2((n.spriteDirection != 1) ? 1 : 0, 1f);
@@ -20551,6 +_,9 @@
 				return;
 
 			Projectile projectile = Main.projectile[i];
+			DrawProj_Inner(i, projectile);
+		}
+		private void DrawProj_DrawVoidLens(Projectile projectile, ref bool earlyReturn) {
 			if (projectile.type == 734) {
 				VoidLensHelper voidLensHelper = new VoidLensHelper(projectile);
 				_voidLensData.Clear();
@@ -20563,10 +_,20 @@
 				return;
 			}
 
+			earlyReturn = false;
+		}
+		private void DrawProj_Inner(int i, Projectile projectile) {
 			float polePosX = 0f;
 			float polePosY = 0f;
 			LoadProjectile(projectile.type);
 			Vector2 mountedCenter = Main.player[projectile.owner].MountedCenter;
+			if (ProjectileLoader.PreDrawExtras(projectile)) {
+				DrawProj_DrawYoyoString(projectile, mountedCenter);
+				DrawProj_DrawExtras(projectile, mountedCenter, ref polePosX, ref polePosY);
+			}
+			DrawProj_Inner_DoDrawProj(i, projectile, mountedCenter, polePosX, polePosY);
+		}
+		private void DrawProj_DrawYoyoString(Projectile projectile, Vector2 mountedCenter) {
 			if (projectile.aiStyle == 99) {
 				Vector2 vector = mountedCenter;
 				vector.Y += Main.player[projectile.owner].gfxOffY;
@@ -20665,7 +_,9 @@
 					EntitySpriteDraw(color: new Microsoft.Xna.Framework.Color((byte)((float)(int)white.R * num12), (byte)((float)(int)white.G * num12), (byte)((float)(int)white.B * num12), (byte)((float)(int)white.A * num12)), texture: TextureAssets.FishingLine.Value, position: new Vector2(vector.X - screenPosition.X + (float)TextureAssets.FishingLine.Width() * 0.5f, vector.Y - screenPosition.Y + (float)TextureAssets.FishingLine.Height() * 0.5f) - new Vector2(6f, 0f), sourceRectangle: new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.FishingLine.Width(), (int)num7), rotation: num4, origin: new Vector2((float)TextureAssets.FishingLine.Width() * 0.5f, 0f), scale: 1f, effects: SpriteEffects.None, worthless: 0);
 				}
 			}
-			else {
+		}
+		private void DrawProj_DrawSpecialProjs(Projectile projectile, ref bool earlyReturn) {
+			/*else*/ {
 				if (projectile.aiStyle == 160) {
 					DrawKite(projectile);
 					return;
@@ -20834,6 +_,9 @@
 				return;
 			}
 
+			earlyReturn = false;
+		}
+		private void DrawProj_DrawExtras(Projectile projectile, Vector2 mountedCenter, ref float polePosX, ref float polePosY) {
 			if (projectile.bobber && Main.player[projectile.owner].inventory[Main.player[projectile.owner].selectedItem].holdStyle != 0) {
 				DrawProj_FishingLine(projectile, ref polePosX, ref polePosY, mountedCenter);
 			}
@@ -21905,6 +_,8 @@
 				DrawProj_FlailChains(projectile, mountedCenter);
 			}
 
+		}
+		private void DrawProj_Inner_DoDrawProj(int i, Projectile projectile, Vector2 mountedCenter, float polePosX, float polePosY) {
 			Microsoft.Xna.Framework.Color color31 = Lighting.GetColor((int)((double)projectile.position.X + (double)projectile.width * 0.5) / 16, (int)(((double)projectile.position.Y + (double)projectile.height * 0.5) / 16.0));
 			if (projectile.hide && !ProjectileID.Sets.DontAttachHideToAlpha[projectile.type])
 				color31 = Lighting.GetColor((int)mountedCenter.X / 16, (int)(mountedCenter.Y / 16f));
@@ -21912,6 +_,21 @@
 			if (projectile.type == 14)
 				color31 = Microsoft.Xna.Framework.Color.White;
 
+			if (ProjectileLoader.PreDraw(projectile, ref color31)) {
+				bool earlyReturn = true;
+				DrawProj_DrawVoidLens(projectile, ref earlyReturn);
+				if (earlyReturn)
+					goto PostDraw;
+				earlyReturn = true;
+				DrawProj_DrawSpecialProjs(projectile, ref earlyReturn);
+				if (earlyReturn)
+					goto PostDraw;
+				DrawProj_DrawNormalProjs(i, projectile, polePosX, polePosY, mountedCenter, ref color31);
+			}
+			PostDraw:
+			ProjectileLoader.PostDraw(projectile, color31);
+		}
+		private void DrawProj_DrawNormalProjs(int i, Projectile projectile, float polePosX, float polePosY, Vector2 mountedCenter, ref Color color31) {
 			int num136 = 0;
 			int num137 = 0;
 			if (projectile.type == 175)
@@ -22283,6 +_,7 @@
 				num137 = 3;
 			}
 
+			//patch details
 			if (projectile.type == 397) {
 				num138 -= 1f;
 				num136 = -2;
@@ -22292,6 +_,7 @@
 			if (projectile.type == 398)
 				num136 = 8;
 
+			ProjectileLoader.DrawOffset(projectile, ref num137, ref num136, ref num138);
 			SpriteEffects spriteEffects = SpriteEffects.None;
 			if (projectile.spriteDirection == -1)
 				spriteEffects = SpriteEffects.FlipHorizontally;
@@ -25459,6 +_,11 @@
 						EntitySpriteDraw(TextureAssets.Projectile[projectile.type].Value, new Vector2(projectile.position.X - screenPosition.X + num138 + (float)num137, projectile.position.Y - screenPosition.Y + (float)(projectile.height / 2) + projectile.gfxOffY) + value157 + value158, new Microsoft.Xna.Framework.Rectangle(0, num381 * 2, TextureAssets.Projectile[projectile.type].Width(), num381 - 1), alpha13, projectile.rotation, new Vector2(num138, projectile.height / 2 + num136), projectile.scale, spriteEffects, 0);
 					}
 
+					var modProjectile = projectile.ModProjectile;
+
+					if (modProjectile != null && ModContent.RequestIfExists<Texture2D>(modProjectile.GlowTexture, out var glowTexture, AssetRequestMode.ImmediateLoad)) // todo: preload this!
+						EntitySpriteDraw(glowTexture.Value, new Vector2(projectile.position.X - screenPosition.X + num138 + num137, projectile.position.Y - screenPosition.Y + projectile.height / 2 + projectile.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y27, TextureAssets.Projectile[projectile.type].Width(), num381 - 1), new Microsoft.Xna.Framework.Color(250, 250, 250, projectile.alpha), projectile.rotation, new Vector2(num138, projectile.height / 2 + num136), projectile.scale, spriteEffects, 0);
+
 					if (projectile.type == 335)
 						EntitySpriteDraw(TextureAssets.Projectile[projectile.type].Value, new Vector2(projectile.position.X - screenPosition.X + num138 + (float)num137, projectile.position.Y - screenPosition.Y + (float)(projectile.height / 2) + projectile.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y27, TextureAssets.Projectile[projectile.type].Width(), num381 - 1), new Microsoft.Xna.Framework.Color(100, 100, 100, 0), projectile.rotation, new Vector2(num138, projectile.height / 2 + num136), projectile.scale, spriteEffects, 0);
 
@@ -25674,7 +_,7 @@
 				}
 
 				if (projectile.bobber) {
-					if (projectile.ai[1] > 0f && projectile.ai[1] < 5125f && projectile.ai[0] == 1f) {
+					if (projectile.ai[1] > 0f && projectile.ai[0] == 1f) {
 						int num406 = (int)projectile.ai[1];
 						Vector2 center5 = projectile.Center;
 						float rotation30 = projectile.rotation;
@@ -25719,6 +_,10 @@
 					if (projectile.type == 473)
 						EntitySpriteDraw(TextureAssets.Projectile[projectile.type].Value, new Vector2(projectile.position.X - screenPosition.X + num138 + (float)num137, projectile.position.Y - screenPosition.Y + (float)(projectile.height / 2) + projectile.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[projectile.type].Width(), TextureAssets.Projectile[projectile.type].Height()), new Microsoft.Xna.Framework.Color(255, 255, 0, 0), projectile.rotation, new Vector2(num138, projectile.height / 2 + num136), projectile.scale, spriteEffects, 0);
 
+					ModProjectile modProjectile = projectile.ModProjectile;
+					if (modProjectile != null && ModContent.RequestIfExists<Texture2D>(modProjectile.GlowTexture, out var glowTexture)) // todo: preload this!
+						EntitySpriteDraw(glowTexture.Value, new Vector2(projectile.position.X - screenPosition.X + num138 + num137, projectile.position.Y - screenPosition.Y + projectile.height / 2 + projectile.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[projectile.type].Width(), TextureAssets.Projectile[projectile.type].Height()), new Microsoft.Xna.Framework.Color(250, 250, 250, projectile.alpha), projectile.rotation, new Vector2(num138, projectile.height / 2 + num136), projectile.scale, spriteEffects, 0);
+
 					if (projectile.type == 312) {
 						ulong seed3 = TileFrameSeed;
 						for (int num409 = 0; num409 < 4; num409++) {
@@ -26057,6 +_,7 @@
 			if (type == 4442)
 				stringColor = new Microsoft.Xna.Framework.Color(100, 100, 200, 100);
 
+			ProjectileLoader.ModifyFishingLine(proj, ref polePosX, ref polePosY, ref stringColor);
 			stringColor = TryApplyingPlayerStringColor(player[proj.owner].stringColor, stringColor);
 			float gravDir = player[proj.owner].gravDir;
 			switch (type) {
@@ -27849,10 +_,13 @@
 				}
 				else if (npc[i].type == 516 || npc[i].type == 519) {
 					DrawCacheNPCProjectiles.Add(i);
+					//Extra patch context.
 				}
 				else if (npc[i].type == 548) {
 					DrawCacheNPCsBehindNonSolidTiles.Add(i);
 				}
+
+				NPCLoader.DrawBehind(Main.npc[i], i);
 			}
 		}
 
@@ -27886,7 +_,7 @@
 					DrawCacheProjsBehindNPCs.Add(i);
 
 				if (projectile[i].type != 636 && projectile[i].type != 598 && projectile[i].type != 971)
-					continue;
+					goto PostProjDrawCache;
 
 				bool flag = true;
 				if (projectile[i].ai[0] == 1f) {
@@ -27903,6 +_,9 @@
 
 				if (flag)
 					DrawCacheProjsBehindProjectiles.Add(i);
+
+				PostProjDrawCache:
+				ProjectileLoader.DrawBehind(projectile[i], i, DrawCacheProjsBehindNPCsAndTiles, DrawCacheProjsBehindNPCs, DrawCacheProjsBehindProjectiles, DrawCacheProjsOverPlayers, DrawCacheProjsOverWiresUI);
 			}
 		}
 
@@ -28256,10 +_,14 @@
 			Vector2 value = new Vector2((float)(item.width / 2) - vector.X, item.height - frame.Height);
 			Vector2 vector2 = item.position - screenPosition + vector + value;
 			float num = item.velocity.X * 0.2f;
+			// patch context.
 			float scale = 1f;
 			Microsoft.Xna.Framework.Color color = Lighting.GetColor(item.Center.ToTileCoordinates());
 			Microsoft.Xna.Framework.Color currentColor = item.GetAlpha(color);
 			ItemSlot.GetItemLight(ref currentColor, ref scale, item);
+			if (!ItemLoader.PreDrawInWorld(item, spriteBatch, color, currentColor, ref num, ref scale, whoami)) {
+				goto PostDraw;
+			}
 			int num2 = item.glowMask;
 			if (!gamePaused && base.IsActive && (item.IsACoin || item.type == 58 || item.type == 109) && color.R > 60 && (float)rand.Next(500) - (Math.Abs(item.velocity.X) + Math.Abs(item.velocity.Y)) * 10f < (float)((int)color.R / 50)) {
 				int type = 43;
@@ -28360,11 +_,15 @@
 			if (num2 != -1)
 				spriteBatch.Draw(TextureAssets.GlowMask[num2].Value, vector2, frame, new Microsoft.Xna.Framework.Color(250, 250, 250, item.alpha), num, vector, scale, SpriteEffects.None, 0f);
 
+			//Extra context.
 			if (ItemID.Sets.TrapSigned[item.type])
 				spriteBatch.Draw(TextureAssets.Wire.Value, vector2 + frame.Size().RotatedBy(num) * 0.45f * item.scale, new Microsoft.Xna.Framework.Rectangle(4, 58, 8, 8), currentColor, 0f, new Vector2(4f), 1f, SpriteEffects.None, 0f);
 
 			if (item.type == 3858)
 				spriteBatch.Draw(TextureAssets.GlowMask[233].Value, vector2, glowmaskFrame, new Microsoft.Xna.Framework.Color(255, 255, 255, 63) * 0.75f, num, glowmaskFrame.Size() / 2f, scale, SpriteEffects.None, 0f);
+
+			PostDraw:
+			ItemLoader.PostDrawInWorld(item, spriteBatch, color, currentColor, num, scale, whoami);
 		}
 
 		public void DrawItems() {
@@ -28510,6 +_,13 @@
 					if (dust.type == 213)
 						scale = 1f;
 
+					ModDust modDust = DustLoader.GetDust(dust.type);
+
+					if (modDust != null) {
+						modDust.Draw(dust, newColor, scale);
+						continue;
+					}
+
 					spriteBatch.Draw(TextureAssets.Dust.Value, dust.position - screenPosition, dust.frame, newColor, dust.GetVisualRotation(), new Vector2(4f, 4f), scale, SpriteEffects.None, 0f);
 					if (dust.color.PackedValue != 0) {
 						Microsoft.Xna.Framework.Color color6 = dust.GetColor(newColor);
@@ -29293,12 +_,16 @@
 			string focusText = "";
 			string focusText2 = "";
 			int num4 = player[myPlayer].statLifeMax2 - player[myPlayer].statLife;
-			for (int j = 0; j < 22; j++) {
+			for (int j = 0; j < Player.MaxBuffs; j++) {
 				int num5 = player[myPlayer].buffType[j];
-				if (debuff[num5] && player[myPlayer].buffTime[j] > 60 && (num5 < 0 || num5 >= 338 || !BuffID.Sets.NurseCannotRemoveDebuff[num5]))
+				if (debuff[num5] && player[myPlayer].buffTime[j] > 60 && (num5 < 0 || !BuffID.Sets.NurseCannotRemoveDebuff[num5]))
 					num4 += 100;
 			}
 
+			int health = LocalPlayer.statLifeMax2 - LocalPlayer.statLife;
+			bool removeDebuffs = true;
+			string reason = "";
+			bool canHeal = true;
 			if (NPC.downedGolemBoss)
 				num4 *= 200;
 			else if (NPC.downedPlantBoss)
@@ -29463,6 +_,10 @@
 				if (num15 > 0 && num15 < 1)
 					num15 = 1;
 
+				reason = Language.GetTextValue("tModLoader.DefaultNurseCantHealChat");
+				canHeal = PlayerLoader.ModifyNurseHeal(player[myPlayer], npc[player[myPlayer].talkNPC], ref health, ref removeDebuffs, ref reason);
+				PlayerLoader.ModifyNursePrice(player[myPlayer], npc[player[myPlayer].talkNPC], health, removeDebuffs, ref num15);
+
 				if (num15 < 0)
 					num15 = 0;
 
@@ -29513,8 +_,11 @@
 				else {
 					text5 = text5.Substring(0, text5.Length - 1);
 					focusText = Lang.inter[54].Value + " (" + text5 + ")";
+					//Patch context.
 				}
 			}
+
+			NPCLoader.SetChatButtons(ref focusText, ref focusText2);
 
 			if (!flag) {
 				DrawNPCChatButtons(num, textColor, amountOfLines, focusText, focusText2);
@@ -29550,11 +_,19 @@
 						SubmitSignText();
 					else
 						IngameFancyUI.OpenVirtualKeyboard(1);
+					return;
 				}
 				else if (NPCID.Sets.IsTownPet[npc[player[myPlayer].talkNPC].type]) {
 					player[myPlayer].PetAnimal(player[myPlayer].talkNPC);
+					return;
 				}
+
+				if (!NPCLoader.PreChatButtonClicked(true))
+					return;
+
+				NPCLoader.OnChatButtonClicked(true);
+
-				else if (npc[player[myPlayer].talkNPC].type == 369) {
+				if (npc[player[myPlayer].talkNPC].type == 369) {
 					npcChatCornerItem = 0;
 					SoundEngine.PlaySound(12);
 					bool flag3 = false;
@@ -29725,10 +_,15 @@
 
 					SoundEngine.PlaySound(12);
 					if (num4 > 0) {
+						if (!canHeal) {
+							npcChatText = reason;
+							return;
+						}
+
 						if (player[myPlayer].BuyItem(num4)) {
 							AchievementsHelper.HandleNurseService(num4);
 							SoundEngine.PlaySound(SoundID.Item4);
-							player[myPlayer].HealEffect(player[myPlayer].statLifeMax2 - player[myPlayer].statLife);
+							player[myPlayer].HealEffect(health, true);
 							if ((double)player[myPlayer].statLife < (double)player[myPlayer].statLifeMax2 * 0.25)
 								npcChatText = Lang.dialog(227);
 							else if ((double)player[myPlayer].statLife < (double)player[myPlayer].statLifeMax2 * 0.5)
@@ -29738,14 +_,21 @@
 							else
 								npcChatText = Lang.dialog(230);
 
-							player[myPlayer].statLife = player[myPlayer].statLifeMax2;
-							for (int l = 0; l < 22; l++) {
+							player[myPlayer].statLife += health;
+
+							if (!removeDebuffs) // no indent for better patching
+								goto SkipDebuffRemoval;
+
+							for (int l = 0; l < Player.MaxBuffs; l++) {
 								int num24 = player[myPlayer].buffType[l];
-								if (debuff[num24] && player[myPlayer].buffTime[l] > 0 && (num24 < 0 || num24 >= 338 || !BuffID.Sets.NurseCannotRemoveDebuff[num24])) {
+								if (debuff[num24] && player[myPlayer].buffTime[l] > 0 && (num24 < 0 || !BuffID.Sets.NurseCannotRemoveDebuff[num24])) {
 									player[myPlayer].DelBuff(l);
 									l = -1;
 								}
 							}
+
+							SkipDebuffRemoval:
+							PlayerLoader.PostNurseHeal(LocalPlayer, npc[LocalPlayer.talkNPC], health, removeDebuffs, num4);
 						}
 						else {
 							int num25 = rand.Next(3);
@@ -29787,6 +_,10 @@
 				if (!npcChatFocus3 || player[myPlayer].talkNPC < 0)
 					return;
 
+				if (!NPCLoader.PreChatButtonClicked(false))
+					return;
+
+				NPCLoader.OnChatButtonClicked(false);
 				if (npc[player[myPlayer].talkNPC].type == 20) {
 					SoundEngine.PlaySound(12);
 					npcChatText = Lang.GetDryadWorldStatusDialog();
@@ -30514,7 +_,7 @@
 					num29++;
 
 				int num31 = 46;
-				for (int n = 0; n < 22; n++) {
+				for (int n = 0; n < Player.MaxBuffs; n++) {
 					if (player[myPlayer].buffType[n] != 0) {
 						int num32 = num28 / num29;
 						int num33 = num28 % num29;
@@ -30537,17 +_,19 @@
 						if (num34 == 147)
 							bannerMouseOver = true;
 
+						int rare = 0;
 						if (meleeBuff[num34])
-							MouseTextHackZoom(buffName, -10, 0, buffTooltip);
-						else
-							MouseTextHackZoom(buffName, buffTooltip);
+							rare = -10;
+
+						BuffLoader.ModifyBuffTip(num34, ref buffTooltip, ref rare);
+						MouseTextHackZoom(buffName, rare, 0);
 					}
 				}
 			}
 			else if (EquipPage == 1) {
 				DrawNPCHousesInUI();
 			}
-			else {
+			else if (EquipPage == 0) {// allow mods to add custom equip pages
 				int num35 = 4;
 				if (mouseX > screenWidth - 64 - 28 && mouseX < (int)((float)(screenWidth - 64 - 28) + 56f * inventoryScale) && mouseY > num20 && mouseY < (int)((float)num20 + 448f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
 					player[myPlayer].mouseInterface = true;
@@ -30564,7 +_,7 @@
 				Microsoft.Xna.Framework.Color color = inventoryBack;
 				Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(80, 80, 80, 80);
 				int num39 = -1;
-				for (int num40 = 0; num40 < 10; num40++) {
+				for (int num40 = 0; num40 < 3; num40++) {
 					if ((num40 == 8 && !flag4) || (num40 == 9 && !flag5))
 						continue;
 
@@ -30585,6 +_,7 @@
 						context2 = 10;
 					}
 
+					/*
 					if (num39 == num38 && !_achievementAdvisor.CanDrawAboveCoins) {
 						_achievementAdvisor.DrawOneAchievement(spriteBatch, new Vector2(num41 - 10 - 47 - 47 - 14 - 14, num42 + 8), large: false);
 						UILinkPointNavigator.SetPosition(1570, new Vector2(num41 - 10 - 47 - 47 - 14 - 14, num42 + 8) + new Vector2(20f) * inventoryScale);
@@ -30592,6 +_,7 @@
 
 					if (num39 == num37)
 						DrawDefenseCounter(num41, num42);
+					*/
 
 					Texture2D value4 = TextureAssets.InventoryTickOn.Value;
 					if (player[myPlayer].hideVisibleAccessory[num40])
@@ -30638,7 +_,7 @@
 					player[myPlayer].mouseInterface = true;
 
 				num39 = -1;
-				for (int num46 = 10; num46 < 20; num46++) {
+				for (int num46 = 10; num46 < 13; num46++) {
 					if ((num46 == 18 && !flag4) || (num46 == 19 && !flag5))
 						continue;
 
@@ -30679,7 +_,7 @@
 					player[myPlayer].mouseInterface = true;
 
 				num39 = -1;
-				for (int num50 = 0; num50 < 10; num50++) {
+				for (int num50 = 0; num50 < 3; num50++) {
 					if ((num50 == 8 && !flag4) || (num50 == 9 && !flag5))
 						continue;
 
@@ -30714,9 +_,22 @@
 				}
 
 				inventoryBack = color;
+
+				var defPos = AccessorySlotLoader.DefenseIconPosition;
+				DrawDefenseCounter((int)defPos.X, (int)defPos.Y);
+
+				if (!_achievementAdvisor.CanDrawAboveCoins) {
+					var achievePos = new Vector2(defPos.X - 10 - 47 - 47 - 14 - 14, defPos.Y - 56 * inventoryScale * 0.5f);
+					_achievementAdvisor.DrawOneAchievement(spriteBatch, achievePos , large: false);
+					UILinkPointNavigator.SetPosition(1570, achievePos + new Vector2(20f) * inventoryScale);
+				}
+
+				inventoryBack = color;
 				inventoryScale = num36;
 			}
 
+			LoaderManager.Get<AccessorySlotLoader>().DrawAccSlots(num20);
+
 			int num54 = (screenHeight - 600) / 2;
 			int num55 = (int)((float)screenHeight / 600f * 250f);
 			if (screenHeight < 700) {
@@ -30760,11 +_,17 @@
 					string text = Lang.inter[46].Value + ": ";
 					if (reforgeItem.type > 0) {
 						int num58 = reforgeItem.value;
-						if (player[myPlayer].discount)
+						bool canApplyDiscount = true;
+						if (!ItemLoader.ReforgePrice(reforgeItem, ref num58, ref canApplyDiscount))
+							goto skipVanillaPricing;
+
+						if (canApplyDiscount && LocalPlayer.discount)
 							num58 = (int)((double)num58 * 0.8);
 
 						num58 = (int)((double)num58 * player[myPlayer].currentShoppingSettings.PriceAdjustment);
 						num58 /= 3;
+
+						skipVanillaPricing:
 						string text2 = "";
 						int num59 = 0;
 						int num60 = 0;
@@ -30822,13 +_,23 @@
 
 							mouseReforge = true;
 							player[myPlayer].mouseInterface = true;
-							if (mouseLeftRelease && mouseLeft && player[myPlayer].BuyItem(num58)) {
+							if (mouseLeftRelease && mouseLeft && player[myPlayer].CanBuyItem(num58) && ItemLoader.PreReforge(reforgeItem)) {
+								player[myPlayer].BuyItem(num58);
 								bool favorited = reforgeItem.favorited;
-								reforgeItem.netDefaults(reforgeItem.netID);
-								reforgeItem.Prefix(-2);
+								int stack = reforgeItem.stack;	//keep the stack, stacked weps support (i.e. light discs)
+																//vanilla doesn't have a good way of resetting prefixes, so it creates a new item entirely
+																//before we roll the prefix, we simply copy over the old mod data before doing so
+								Item r = new Item();
+								r.netDefaults(reforgeItem.netID);
+								//TODO: Delet this. //CB: method only used here, probably a poor implementation
+								r = r.CloneWithModdedDataFrom(reforgeItem);
+								r.Prefix(-2);
+								reforgeItem = r.Clone();
 								reforgeItem.position.X = player[myPlayer].position.X + (float)(player[myPlayer].width / 2) - (float)(reforgeItem.width / 2);
 								reforgeItem.position.Y = player[myPlayer].position.Y + (float)(player[myPlayer].height / 2) - (float)(reforgeItem.height / 2);
 								reforgeItem.favorited = favorited;
+								reforgeItem.stack = stack;
+								ItemLoader.PostReforge(reforgeItem);
 								PopupText.NewText(PopupTextContext.ItemReforge, reforgeItem, reforgeItem.stack, noStack: true);
 								SoundEngine.PlaySound(SoundID.Item37);
 							}
@@ -30877,13 +_,14 @@
 						ItemSlot.MouseHover(ref guideItem, 7);
 					}
 
+					//Extra patch context.
 					ItemSlot.Draw(spriteBatch, ref guideItem, 7, new Vector2(inventoryX, inventoryY));
 				}
 			}
 
 			CreativeMenu.Draw(spriteBatch);
 			bool flag9 = CreativeMenu.Enabled && !CreativeMenu.Blocked;
-			if (!InReforgeMenu && !LocalPlayer.tileEntityAnchor.InUse && !flag9) {
+			if (!InReforgeMenu && !hidePlayerCraftingMenu && !LocalPlayer.tileEntityAnchor.InUse && !flag9) {
 				UILinkPointNavigator.Shortcuts.CRAFT_CurrentRecipeBig = -1;
 				UILinkPointNavigator.Shortcuts.CRAFT_CurrentRecipeSmall = -1;
 				if (numAvailableRecipes > 0)
@@ -30965,7 +_,7 @@
 				if (numAvailableRecipes > 0) {
 					UILinkPointNavigator.Shortcuts.CRAFT_CurrentRecipeBig = -1;
 					UILinkPointNavigator.Shortcuts.CRAFT_CurrentRecipeSmall = -1;
-					for (int num72 = 0; num72 < Recipe.maxRequirements; num72++) {
+					for (int num72 = 0; num72 < recipe[availableRecipe[focusRecipe]].requiredItem.Count; num72++) {
 						if (recipe[availableRecipe[focusRecipe]].requiredItem[num72].type == 0) {
 							UILinkPointNavigator.Shortcuts.CRAFT_CurrentIngridientsCount = num72 + 1;
 							break;
@@ -31010,7 +_,8 @@
 						UILinkPointNavigator.Shortcuts.CRAFT_CurrentRecipeSmall = 1 + num72;
 						Microsoft.Xna.Framework.Color color5 = inventoryBack;
 						inventoryBack = new Microsoft.Xna.Framework.Color((byte)num75, (byte)num75, (byte)num75, (byte)num75);
-						ItemSlot.Draw(spriteBatch, ref recipe[availableRecipe[focusRecipe]].requiredItem[num72], 22, new Vector2(num73, num74));
+						Item tempItem = recipe[availableRecipe[focusRecipe]].requiredItem[num72];
+						ItemSlot.Draw(spriteBatch, ref tempItem, 22, new Vector2(num73, num74));
 						inventoryBack = color5;
 					}
 				}
@@ -31043,6 +_,7 @@
 					}
 				}
 			}
+			hidePlayerCraftingMenu = false;
 
 			if (recBigList && !flag9) {
 				UILinkPointNavigator.Shortcuts.CRAFT_CurrentRecipeBig = -1;
@@ -31327,7 +_,7 @@
 				if (npc[j].active && !_npcTypesThatAlreadyDrewAHead.Contains(npc[j].type)) {
 					ITownNPCProfile profile;
 					int num4 = (!TownNPCProfiles.Instance.GetProfile(npc[j].type, out profile)) ? NPC.TypeToDefaultHeadIndex(npc[j].type) : profile.GetHeadTextureIndex(npc[j]);
-					if (num4 > 0 && num4 <= 46 && !NPCHeadID.Sets.CannotBeDrawnInHousingUI[num4] && _npcIndexWhoHoldsHeadIndex[num4] == -1) {
+					if (num4 > 0 && num4 < NPCHeadLoader.NPCHeadCount && !NPCHeadID.Sets.CannotBeDrawnInHousingUI[num4] && _npcIndexWhoHoldsHeadIndex[num4] == -1) {
 						_npcIndexWhoHoldsHeadIndex[num4] = j;
 						_npcTypesThatAlreadyDrewAHead.Add(npc[j].type);
 					}
@@ -31431,7 +_,7 @@
 			else {
 				text = Lang.inter[21].Value + " " + guideItem.Name;
 				Recipe recipe = Main.recipe[availableRecipe[focusRecipe]];
-				for (int i = 0; i < Recipe.maxRequirements; i++) {
+				for (int i = 0; i < recipe.requiredTile.Count; i++) {
 					int num = recipe.requiredTile[i];
 					if (num == -1)
 						break;
@@ -31456,6 +_,8 @@
 				if (recipe.needGraveyardBiome)
 					_requiredObjecsForCraftingText.Add(Lang.inter[124].Value);
 
+				_requiredObjecsForCraftingText.AddRange(recipe.Conditions.Select(x => x.Description));
+
 				if (_requiredObjecsForCraftingText.Count == 0) {
 					string value = Lang.inter[23].Value;
 					_requiredObjecsForCraftingText.Add(value);
@@ -31492,7 +_,7 @@
 				spriteBatch.DrawString(FontAssets.MouseText.Value, Lang.inter[22].Value, new Vector2(inventoryX, inventoryY + 118), craftingTipColor, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
 				int num3 = focusRecipe;
 				int num4 = 0;
-				for (int i = 0; i < Recipe.maxRequirements; i++) {
+				for (int i = 0; i < recipe[availableRecipe[num3]].requiredTile.Count; i++) {
 					int num5 = (i + 1) * 26;
 					if (recipe[availableRecipe[num3]].requiredTile[i] == -1) {
 						if (i == 0 && !recipe[availableRecipe[num3]].needWater && !recipe[availableRecipe[num3]].needHoney && !recipe[availableRecipe[num3]].needLava && !recipe[availableRecipe[num3]].needSnowBiome && !recipe[availableRecipe[num3]].needGraveyardBiome)
@@ -31621,6 +_,11 @@
 				inventoryScale = 0.755f;
 				num += 5;
 			}
+			else if ((player[myPlayer].chest == -1 || npcShop == -1) && trashSlotOffset != Point16.Zero) {
+				num += trashSlotOffset.X;
+				num2 += trashSlotOffset.Y;
+				inventoryScale = 0.755f;
+			}
 
 			new Microsoft.Xna.Framework.Color(150, 150, 150, 150);
 			if (mouseX >= num && (float)mouseX <= (float)num + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num2 && (float)mouseY <= (float)num2 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface) {
@@ -31857,8 +_,11 @@
 			mouseItem.position.Y = player[myPlayer].position.Y + (float)(player[myPlayer].height / 2) - (float)(mouseItem.height / 2);
 			PopupText.NewText(PopupTextContext.ItemCraft, mouseItem, r.createItem.stack);
 			r.Create();
-			if (mouseItem.type > 0 || r.createItem.type > 0)
+			if (mouseItem.type > 0 || r.createItem.type > 0) {
+				ItemLoader.OnCreate(mouseItem, new RecipeCreationContext {recipe = r});
+				RecipeLoader.OnCraft(mouseItem, r);
 				SoundEngine.PlaySound(7);
+			}
 		}
 
 		private static void DrawPVPIcons() {
@@ -32036,6 +_,8 @@
 						rare = item[i].rare;
 						if (item[i].expert)
 							rare = -12;
+						if (item[i].master)
+							rare = -13;
 
 						MouseTextHackZoom(text, rare, 0);
 						mouseText = true;
@@ -32081,7 +_,7 @@
 					bool flag2 = flag || (SmartInteractShowingGenuine && SmartInteractNPC == k);
 					if (flag2 && ((npc[k].type != 85 && npc[k].type != 341 && npc[k].type != 629 && npc[k].aiStyle != 87) || npc[k].ai[0] != 0f) && npc[k].type != 488) {
 						bool flag3 = SmartInteractShowingGenuine && SmartInteractNPC == k;
-						if (npc[k].townNPC || npc[k].type == 105 || npc[k].type == 106 || npc[k].type == 123 || npc[k].type == 354 || npc[k].type == 376 || npc[k].type == 579 || npc[k].type == 453 || npc[k].type == 589) {
+						if (NPCLoader.CanChat(npc[k], npc[k].townNPC || npc[k].type == 105 || npc[k].type == 106 || npc[k].type == 123 || npc[k].type == 354 || npc[k].type == 376 || npc[k].type == 579 || npc[k].type == 453 || npc[k].type == 589)) {
 							Microsoft.Xna.Framework.Rectangle rectangle2 = new Microsoft.Xna.Framework.Rectangle((int)(player[myPlayer].position.X + (float)(player[myPlayer].width / 2) - (float)(Player.tileRangeX * 16)), (int)(player[myPlayer].position.Y + (float)(player[myPlayer].height / 2) - (float)(Player.tileRangeY * 16)), Player.tileRangeX * 16 * 2, Player.tileRangeY * 16 * 2);
 							Microsoft.Xna.Framework.Rectangle value4 = new Microsoft.Xna.Framework.Rectangle((int)npc[k].position.X, (int)npc[k].position.Y, npc[k].width, npc[k].height);
 							if (rectangle2.Intersects(value4))
@@ -32257,14 +_,14 @@
 			recBigList = false;
 			int num = -1;
 			int num2 = 11;
-			for (int i = 0; i < 22; i++) {
+			for (int i = 0; i < Player.MaxBuffs; i++) {
 				if (player[myPlayer].buffType[i] > 0) {
 					_ = player[myPlayer].buffType[i];
 					int x = 32 + i * 38;
 					int num3 = 76;
 					if (i >= num2) {
-						x = 32 + (i - num2) * 38;
-						num3 += 50;
+						x = 32 + Math.Abs(i % 11) * 38;
+						num3 += 50 * (i / 11);
 					}
 
 					num = DrawBuffIcon(num, i, x, num3);
@@ -32284,10 +_,11 @@
 				if (num4 == 147)
 					bannerMouseOver = true;
 
+				int rare = 0;
 				if (meleeBuff[num4])
-					MouseTextHackZoom(buffName, -10, 0, buffTooltip);
-				else
-					MouseTextHackZoom(buffName, buffTooltip);
+					rare = -10;
+				BuffLoader.ModifyBuffTip(num4, ref buffTooltip, ref rare);
+				MouseTextHackZoom(buffName, rare, 0, buffTooltip);
 			}
 		}
 
@@ -33624,7 +_,9 @@
 				SetupDrawInterfaceLayers();
 
 			PlayerInput.SetZoom_UI();
+			List<GameInterfaceLayer> interfaceLayers = new List<GameInterfaceLayer>(_gameInterfaceLayers);
+			SystemLoader.ModifyInterfaceLayers(interfaceLayers);
-			using (List<GameInterfaceLayer>.Enumerator enumerator = _gameInterfaceLayers.GetEnumerator()) {
+			using (List<GameInterfaceLayer>.Enumerator enumerator = interfaceLayers.GetEnumerator()) {
 				while (enumerator.MoveNext() && enumerator.Current.Draw()) {
 				}
 			}
@@ -33929,6 +_,8 @@
 		}
 
 		private void DrawInterface_33_MouseText() {
+			// TODO - UI Sorting and selective disable support -  move this to new one between 32 and 33
+			SystemLoader.PostDrawInterface(spriteBatch);
 			if (mouseItem.stack <= 0)
 				mouseItem.type = 0;
 
@@ -33975,7 +_,8 @@
 					num4 += num5;
 				}
 
+				//TML: Remove the Setting button being moved when player has too many slots. The ModAccessorySlot rework fixed this in a better fashion.
-				if (amountOfExtraAccessorySlotsToShow >= 1 && (screenHeight < num3 || (screenHeight < num4 && mapStyle == 1))) {
+				if (false && amountOfExtraAccessorySlotsToShow >= 1 && (screenHeight < num3 || (screenHeight < num4 && mapStyle == 1))) {
 					num -= 140;
 					num2 -= PlayerInput.UsingGamepad.ToInt() * 30;
 					_settingsButtonIsPushedToSide = true;
@@ -34414,6 +_,11 @@
 						if (HealthBarDrawSettings == 2)
 							num3 -= 34f;
 
+						if (!NPCLoader.DrawHealthBar(npc[num2], ref scale)) {
+							npc[num2].position -= npc[num2].netOffset;
+							continue;
+						}
+
 						if ((!expertMode || type != 266) && ((type != 439 && type != 440) || npc[num2].ai[0] != 5f)) {
 							if (type >= 134 && type <= 136) {
 								scale = 1.5f;
@@ -35155,10 +_,18 @@
 				num4 += 50f;
 			}
 
+			InfoDisplayPageHandler(startX, ref text, out int startingDisplay, out int endingDisplay);
-			for (int i = 0; i < 12; i++) {
+			for (int i = startingDisplay; i < endingDisplay; i++) {
 				string text2 = "";
 				string text3 = "";
+
+				InfoDisplay info = InfoDisplayLoader.InfoDisplays[i];
+
+				if (!InfoDisplayLoader.Active(info) || (player[myPlayer].hideInfo[info.Type] && !playerInventory))
+					continue;
+
-				if (player[myPlayer].accWatch > 0 && !flag && (!player[myPlayer].hideInfo[0] || playerInventory)) {
+				//if (player[myPlayer].accWatch > 0 && !flag && (!player[myPlayer].hideInfo[0] || playerInventory)) {
+				if (info == InfoDisplay.Watches) {
 					num = 0;
 					text3 = Lang.inter[95].Value;
 					string textValue = Language.GetTextValue("GameUI.TimeAtMorning");
@@ -35196,7 +_,8 @@
 					text2 = num7 + ":" + text4 + " " + textValue;
 					flag = true;
 				}
-				else if (player[myPlayer].accWeatherRadio && !flag5 && (!player[myPlayer].hideInfo[1] || playerInventory)) {
+				//else if (player[myPlayer].accWeatherRadio && !flag5 && (!player[myPlayer].hideInfo[1] || playerInventory)) {
+				else if (info == InfoDisplay.WeatherRadio) {
 					num = 1;
 					text3 = Lang.inter[96].Value;
 					string text5 = "";
@@ -35210,7 +_,8 @@
 
 					flag5 = true;
 				}
-				else if (player[myPlayer].accCalendar && !flag8 && (!player[myPlayer].hideInfo[7] || playerInventory)) {
+				//else if (player[myPlayer].accCalendar && !flag8 && (!player[myPlayer].hideInfo[7] || playerInventory)) {
+				else if (info == InfoDisplay.Sextant) {
 					num = ((bloodMoon && !dayTime) ? 8 : ((!eclipse || !dayTime) ? 7 : 8));
 					text3 = Lang.inter[102].Value;
 					if (moonPhase == 0)
@@ -35232,7 +_,8 @@
 
 					flag8 = true;
 				}
-				else if (player[myPlayer].accFishFinder && !flag4 && (!player[myPlayer].hideInfo[2] || playerInventory)) {
+				//else if (player[myPlayer].accFishFinder && !flag4 && (!player[myPlayer].hideInfo[2] || playerInventory)) {
+				else if (info == InfoDisplay.FishFinder) {
 					bool flag13 = false;
 					num = 2;
 					text3 = Lang.inter[97].Value;
@@ -35253,7 +_,8 @@
 
 					flag4 = true;
 				}
-				else if (player[myPlayer].accOreFinder && !flag10 && (!player[myPlayer].hideInfo[10] || playerInventory)) {
+				//else if (player[myPlayer].accOreFinder && !flag10 && (!player[myPlayer].hideInfo[10] || playerInventory)) {
+				else if (info == InfoDisplay.MetalDetector) {
 					num = 10;
 					text3 = Lang.inter[104].Value;
 					if (SceneMetrics.bestOre <= 0) {
@@ -35278,7 +_,8 @@
 
 					flag10 = true;
 				}
-				else if (player[myPlayer].accCritterGuide && !flag11 && (!player[myPlayer].hideInfo[11] || playerInventory)) {
+				//else if (player[myPlayer].accCritterGuide && !flag11 && (!player[myPlayer].hideInfo[11] || playerInventory)) {
+				else if (info == InfoDisplay.LifeformAnalyzer) {
 					flag11 = true;
 					num = 11;
 					text3 = Lang.inter[105].Value;
@@ -35303,7 +_,8 @@
 
 					text2 = ((num13 < 0 || num13 >= 200 || !npc[num13].active || npc[num13].rarity <= 0) ? Language.GetTextValue("GameUI.NoRareCreatures") : npc[num13].GivenOrTypeName);
 				}
-				else if (player[myPlayer].accThirdEye && !flag6 && (!player[myPlayer].hideInfo[5] || playerInventory)) {
+				//else if (player[myPlayer].accThirdEye && !flag6 && (!player[myPlayer].hideInfo[5] || playerInventory)) {
+				else if (info == InfoDisplay.Radar) {
 					flag6 = true;
 					num = 5;
 					text3 = Lang.inter[100].Value;
@@ -35322,14 +_,16 @@
 
 					text2 = ((player[myPlayer].accThirdEyeNumber == 0) ? Language.GetTextValue("GameUI.NoEnemiesNearby") : ((player[myPlayer].accThirdEyeNumber != 1) ? Language.GetTextValue("GameUI.EnemiesNearby", player[myPlayer].accThirdEyeNumber) : Language.GetTextValue("GameUI.OneEnemyNearby")));
 				}
-				else if (player[myPlayer].accJarOfSouls && !flag7 && (!player[myPlayer].hideInfo[6] || playerInventory)) {
+				//else if (player[myPlayer].accJarOfSouls && !flag7 && (!player[myPlayer].hideInfo[6] || playerInventory)) {
+				else if (info == InfoDisplay.TallyCounter) {
 					flag7 = true;
 					num = 6;
 					text3 = Lang.inter[101].Value;
 					int lastCreatureHit = player[myPlayer].lastCreatureHit;
 					text2 = ((lastCreatureHit > 0) ? (Lang.GetNPCNameValue(Item.BannerToNPC(lastCreatureHit)) + ": " + NPC.killCount[lastCreatureHit]) : Language.GetTextValue("GameUI.NoKillCount"));
 				}
-				else if (player[myPlayer].accDreamCatcher && !flag12 && (!player[myPlayer].hideInfo[12] || playerInventory)) {
+				//else if (player[myPlayer].accDreamCatcher && !flag12 && (!player[myPlayer].hideInfo[12] || playerInventory)) {
+				else if (info == InfoDisplay.DPSMeter) {
 					num = 12;
 					text3 = Lang.inter[106].Value;
 					player[myPlayer].checkDPSTime();
@@ -35337,7 +_,8 @@
 					flag12 = true;
 					text2 = ((dPS != 0) ? Language.GetTextValue("GameUI.DPS", player[myPlayer].getDPS()) : Language.GetTextValue("GameUI.NoDPS"));
 				}
-				else if (player[myPlayer].accStopwatch && !flag9 && (!player[myPlayer].hideInfo[9] || playerInventory)) {
+				//else if (player[myPlayer].accStopwatch && !flag9 && (!player[myPlayer].hideInfo[9] || playerInventory)) {
+				else if (info == InfoDisplay.Stopwatch) {
 					num = 9;
 					text3 = Lang.inter[103].Value;
 					Vector2 vector = player[myPlayer].velocity + player[myPlayer].instantMovementAccumulatedThisFrame;
@@ -35375,15 +_,17 @@
 					text2 = Language.GetTextValue("GameUI.Speed", Math.Round(num20));
 					flag9 = true;
 				}
-				else if (player[myPlayer].accCompass > 0 && !flag3 && (!player[myPlayer].hideInfo[3] || playerInventory)) {
+				//else if (player[myPlayer].accCompass > 0 && !flag3 && (!player[myPlayer].hideInfo[3] || playerInventory)) {
+				else if (info == InfoDisplay.Compass) {
 					num = 3;
 					text3 = Lang.inter[98].Value;
 					int num21 = (int)((player[myPlayer].position.X + (float)(player[myPlayer].width / 2)) * 2f / 16f - (float)maxTilesX);
 					text2 = ((num21 > 0) ? Language.GetTextValue("GameUI.CompassEast", num21) : ((num21 >= 0) ? Language.GetTextValue("GameUI.CompassCenter") : Language.GetTextValue("GameUI.CompassWest", -num21)));
 					flag3 = true;
 				}
-				else if (player[myPlayer].accDepthMeter > 0 && !flag2 && (!player[myPlayer].hideInfo[4] || playerInventory)) {
+				//else if (player[myPlayer].accDepthMeter > 0 && !flag2 && (!player[myPlayer].hideInfo[4] || playerInventory)) {
+				else if (info == InfoDisplay.DepthMeter) {
-					num = 4;
+				num = 4;
 					text3 = Lang.inter[99].Value;
 					int num22 = (int)((double)((player[myPlayer].position.Y + (float)player[myPlayer].height) * 2f / 16f) - worldSurface * 2.0);
 					string text6 = "";
@@ -35398,27 +_,33 @@
 					text2 = text7 + " " + text6;
 					flag2 = true;
 				}
+				else {
+					num = info.Type;
+					text2 = info.DisplayValue();
+					text3 = info.DisplayName;
+				}
+
+				InfoDisplayLoader.ModifyDisplayValue(info, ref text2);
+				InfoDisplayLoader.ModifyDisplayName(info, ref text3);
 
 				if (!(text2 != ""))
 					continue;
 
 				GetInfoAccIconPosition(num3, startX, out int X, out int Y);
 				if (num >= 0) {
-					num3++;
 					int num26 = 22;
 					if (screenHeight < 650)
 						num26 = 20;
 
-					Vector2 vector2 = new Vector2(X, Y + 74 + num26 * i + 52);
+					Vector2 vector2 = new Vector2(X, Y + 74 + num26 * num3 + 52);
-					int num27 = num;
+					int num27 = info.Type;
-					if (num27 == 8)
-						num27 = 7;
 
+					Texture2D icon = ModContent.Request<Texture2D>(info.Texture).Value;
 					Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White;
 					bool flag14 = false;
 					if (playerInventory) {
 						vector2 = new Vector2(X, Y);
-						if ((float)mouseX >= vector2.X && (float)mouseY >= vector2.Y && (float)mouseX <= vector2.X + (float)TextureAssets.InfoIcon[num].Width() && (float)mouseY <= vector2.Y + (float)TextureAssets.InfoIcon[num].Height() && !PlayerInput.IgnoreMouseInterface) {
+						if ((float)mouseX >= vector2.X && (float)mouseY >= vector2.Y && (float)mouseX <= vector2.X + (float)icon.Width && (float)mouseY <= vector2.Y + (float)icon.Height && !PlayerInput.IgnoreMouseInterface) {
 							flag14 = true;
 							player[myPlayer].mouseInterface = true;
 							if (mouseLeft && mouseLeftRelease) {
@@ -35436,14 +_,17 @@
 						if (player[myPlayer].hideInfo[num27])
 							color = new Microsoft.Xna.Framework.Color(80, 80, 80, 70);
 					}
-					else if ((float)mouseX >= vector2.X && (float)mouseY >= vector2.Y && (float)mouseX <= vector2.X + (float)TextureAssets.InfoIcon[num].Width() && (float)mouseY <= vector2.Y + (float)TextureAssets.InfoIcon[num].Height() && !mouseText) {
+					else if ((float)mouseX >= vector2.X && (float)mouseY >= vector2.Y && (float)mouseX <= vector2.X + (float)icon.Width && (float)mouseY <= vector2.Y + (float)icon.Height && !mouseText) {
-						num2 = i;
+						//num2 = i;
+						num2 = num3;
+						if (i >= 7)
+							num2 += 1;
 						text = text3;
 						mouseText = true;
 					}
 
-					UILinkPointNavigator.SetPosition(1558 + num3 - 1, vector2 + TextureAssets.InfoIcon[num].Value.Size() * 0.75f);
+					UILinkPointNavigator.SetPosition(1558 + num3 - 1, vector2 + icon.Size() * 0.75f);
-					spriteBatch.Draw(TextureAssets.InfoIcon[num].Value, vector2, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.InfoIcon[num].Width(), TextureAssets.InfoIcon[num].Height()), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
+					spriteBatch.Draw(icon, vector2, new Microsoft.Xna.Framework.Rectangle(0, 0, icon.Width, icon.Height), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
 					if (flag14)
 						spriteBatch.Draw(TextureAssets.InfoIcon[13].Value, vector2 - Vector2.One * 2f, null, OurFavoriteColor, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
 
@@ -35451,8 +_,9 @@
 				}
 
 				UILinkPointNavigator.Shortcuts.INFOACCCOUNT = num3;
+
 				if (playerInventory)
-					continue;
+					goto endThisIcon;
 
 				Vector2 scale = new Vector2(1f);
 				Vector2 vector3 = FontAssets.MouseText.Value.MeasureString(text2);
@@ -35488,8 +_,11 @@
 					if (screenHeight < 650)
 						num30 = 20;
 
-					spriteBatch.DrawString(FontAssets.MouseText.Value, text2, new Vector2(X + num28, Y + 74 + num30 * i + num29 + 48), color2, 0f, default(Vector2), scale, SpriteEffects.None, 0f);
+					spriteBatch.DrawString(FontAssets.MouseText.Value, text2, new Vector2(X + num28, Y + 74 + num30 * num3 + num29 + 48), color2, 0f, default(Vector2), scale, SpriteEffects.None, 0f);
 				}
+
+				endThisIcon:
+				num3++; // moved here due to calculation changes
 			}
 
 			if (!string.IsNullOrEmpty(text)) {
@@ -35508,8 +_,8 @@
 					Y += 261;
 			}
 			else if (ShouldDrawInfoIconsHorizontally) {
-				X = screenWidth - 280 + 20 * drawnCount - 10;
-				Y = 94;
+				X = screenWidth - 280 + 20 * (drawnCount % 12) - 10;
+				Y = 94 + (20 * (drawnCount / 12));
 				if (mapStyle == 1 && mapEnabled)
 					Y += 261;
 			}
@@ -36446,8 +_,10 @@
 			screenLastPosition = screenPosition;
 			screenPosition.Y = (float)(worldSurface * 16.0 - (double)screenHeight);
 			MenuXMovement = 4f;
-			if (alreadyGrabbingSunOrMoon)
+			if (alreadyGrabbingSunOrMoon && !playOldTile) {
 				playOldTile = true;
+				MenuLoader.ActivateOldVanillaMenu();
+			}
 
 			screenPosition.X += MenuXMovement;
 			if (screenPosition.X > 2.1474835E+09f)
@@ -36497,13 +_,14 @@
 					logoScaleSpeed -= 1f;
 			}
 
+			MenuLoader.UpdateAndDrawModMenu(spriteBatch, gameTime, color, logoRotation, logoScale);
 			Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color((byte)((float)(int)color.R * ((float)LogoA / 255f)), (byte)((float)(int)color.G * ((float)LogoA / 255f)), (byte)((float)(int)color.B * ((float)LogoA / 255f)), (byte)((float)(int)color.A * ((float)LogoA / 255f)));
 			Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color((byte)((float)(int)color.R * ((float)LogoB / 255f)), (byte)((float)(int)color.G * ((float)LogoB / 255f)), (byte)((float)(int)color.B * ((float)LogoB / 255f)), (byte)((float)(int)color.A * ((float)LogoB / 255f)));
-			if (playOldTile) {
+			if (MenuLoader.MenuOldVanilla.IsSelected) {
 				spriteBatch.Draw(TextureAssets.Logo3.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color2, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
 				spriteBatch.Draw(TextureAssets.Logo4.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color3, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
 			}
-			else {
+			else if (MenuLoader.MenuJourneysEnd.IsSelected) {
 				spriteBatch.Draw(TextureAssets.Logo.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color2, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
 				spriteBatch.Draw(TextureAssets.Logo2.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color3, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
 			}
@@ -36562,8 +_,21 @@
 			if (menuMode == -1)
 				menuMode = 0;
 
-			if (Program.LoadedEverything)
+			if (Program.LoadedEverything) {
 				GamepadMainMenuHandler.CanRun = true;
+			} else {
+				array9[0] = string.Format("{0}  {1}", Language.GetTextValue("UI.LoadingCode"), Program.LoadedPercentage.ToString("P0"));
+				if (!ModLoader.ModLoader.skipLoad) {
+					array9[1] = "Click to skip loading mods";
+					array7[1] = 0.5f;
+					num5 = 2;
+					if(selectedMenu == 1) {
+						ModLoader.ModLoader.skipLoad = true;
+					}
+				}
+
+				goto SkipMenuEnumeration; //Put the label somewhere after the following if-else chain.
+			}
 
 			if (menuMode == 1212) {
 				array9[0] = Lang.menu[102].Value;
@@ -36600,7 +_,7 @@
 				if (selectedMenu >= 1) {
 					changeTheTitle = true;
 					LanguageManager.Instance.SetLanguage(selectedMenu);
-					menuMode = 0;
+					menuMode = Interface.loadModsID;
 					SoundEngine.PlaySound(10);
 					SaveSettings();
 				}
@@ -36738,7 +_,7 @@
 					menuMode = 14;
 				}
 			}
-			else if (netMode == 1 || menuMode == 14) {
+			else if (netMode == 1 && menuMode < 10000 && menuMode != 888 || menuMode == 14) {
 				num5 = 2;
 				array9[0] = statusText;
 				array[0] = true;
@@ -36836,17 +_,21 @@
 					Netplay.ServerPassword = "";
 				}
 				else if (selectedMenu == 2 || inputTextEnter || autoPass) {
-					string str = "-autoshutdown -password \"" + ConvertToSafeArgument(Netplay.ServerPassword) + "\" -lang " + Language.ActiveCulture.LegacyId;
+					string str = "tModLoader.dll -server " + "-autoshutdown -password \"" + ConvertToSafeArgument(Netplay.ServerPassword) + "\" -lang " + Language.ActiveCulture.LegacyId;
 #if LINUX
 					str += IntPtr.Size == 8 ? " -x64": " -x86";
 #endif
 					str = ((!ActiveWorldFileData.IsCloudSave) ? (str + SanitizePathArgument("world", worldPathName)) : (str + SanitizePathArgument("cloudworld", worldPathName)));
 					str = str + " -worldrollbackstokeep " + WorldRollingBackupsCountToKeep;
+					str += $@" -modpath ""{ModOrganizer.modPath}""";
+					if (showServerConsole)
+						str += " -showserverconsole";
+
 					tServer = new Process();
 #if WINDOWS
-					tServer.StartInfo.FileName = "TerrariaServer.exe";
+					tServer.StartInfo.FileName = "tModLoaderServer.exe";
 #else
-					tServer.StartInfo.FileName = "TerrariaServer";
+					tServer.StartInfo.FileName = Process.GetCurrentProcess().MainModule.FileName;
 #endif
 					tServer.StartInfo.Arguments = str;
 					if (libPath != "") {
@@ -36854,8 +_,10 @@
 						startInfo.Arguments = startInfo.Arguments + " -loadlib " + libPath;
 					}
 
-					tServer.StartInfo.UseShellExecute = false;
-					tServer.StartInfo.CreateNoWindow = true;
+					tServer.StartInfo.UseShellExecute = true;
+					if (!showServerConsole)
+						tServer.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
+
 					if (SocialAPI.Network != null)
 						SocialAPI.Network.LaunchLocalServer(tServer, MenuServerMode);
 					else
@@ -36876,7 +_,10 @@
 				array4[3] = 30;
 				array4[4] = 70;
 				array4[5] = 70;
+				array4[6] = 70;
-				num5 = 6;
+				num5 = 7;
+				array9[6] = Language.GetTextValue(showServerConsole ? "tModLoader.MPShowServerConsoleYes" : "tModLoader.MPShowServerConsoleNo");
+				array7[6] = 0.5f;
 				array9[0] = Lang.menu[135].Value;
 				array9[4] = Lang.menu[144].Value;
 				array9[5] = Lang.menu[5].Value;
@@ -36937,6 +_,10 @@
 						menuMode = 6;
 						SoundEngine.PlaySound(11);
 						break;
+					case 6:
+						showServerConsole = !showServerConsole;
+						SoundEngine.PlaySound(12, -1, -1, 1, 1f, 0f);
+						break;
 				}
 			}
 			else if (menuMode == 15) {
@@ -36957,16 +_,23 @@
 			else if (menuMode == 200) {
 				num5 = 3;
 				array9[0] = Lang.menu[9].Value;
+				if (WorldIO.customDataFail != null)
+					array9[0] = WorldIO.customDataFail.modName + ": " + array9[0];
+
 				array[0] = true;
 				num2 -= 30;
 				array4[1] = 70;
 				array4[2] = 50;
 				array9[1] = Lang.menu[10].Value;
 				array9[2] = Lang.menu[6].Value;
+				if (WorldIO.customDataFail != null)
+					array9[2] = Language.GetTextValue("tModLoader.OpenLogs");
+
 				if (selectedMenu == 1) {
 					if (FileUtilities.Exists(worldPathName + ".bak", ActiveWorldFileData.IsCloudSave)) {
 						FileUtilities.Move(worldPathName, worldPathName + ".bad", ActiveWorldFileData.IsCloudSave);
 						FileUtilities.Move(worldPathName + ".bak", worldPathName, ActiveWorldFileData.IsCloudSave);
+						WorldIO.LoadBackup(worldPathName, ActiveWorldFileData.IsCloudSave);
 						SoundEngine.PlaySound(10);
 						WorldGen.playWorld();
 						menuMode = 10;
@@ -36981,13 +_,23 @@
 				if (selectedMenu == 2 || flag5) {
 					flag5 = false;
 					SoundEngine.PlaySound(11);
+					if (WorldIO.customDataFail == null)
-					menuMode = 0;
+						menuMode = 0;
+					else {
+						Logging.tML.Error(Language.GetTextValue("tModLoader.WorldIODataException"), WorldIO.customDataFail.InnerException);
+						SoundEngine.PlaySound(SoundID.MenuOpen);
+						Utils.OpenFolder(Logging.LogDir);
+					}
+
 					netMode = 0;
 				}
 			}
 			else if (menuMode == 201) {
 				num5 = 3;
 				array9[0] = Lang.menu[9].Value;
+				if (WorldIO.customDataFail != null)
+					array9[0] = WorldIO.customDataFail.modName + ": " + array9[0];
+
 				array[0] = true;
 				array[1] = true;
 				num2 -= 30;
@@ -36995,9 +_,21 @@
 				array4[2] = 50;
 				array9[1] = Lang.menu[11].Value;
 				array9[2] = Lang.menu[5].Value;
+				if (WorldIO.customDataFail != null)
+					array9[2] = Language.GetTextValue("tModLoader.OpenLogs");
+
 				if (selectedMenu == 2 || flag5) {
 					flag5 = false;
 					SoundEngine.PlaySound(11);
+					if (WorldIO.customDataFail == null) {
+						menuMode = 0;
+					}
+					else {
+						Logging.tML.Error(Language.GetTextValue("tModLoader.WorldIODataException"), WorldIO.customDataFail.InnerException);
+						SoundEngine.PlaySound(SoundID.MenuOpen);
+						Utils.OpenFolder(Logging.LogDir);
+					}
+
 					menuMode = 0;
 					netMode = 0;
 				}
@@ -37055,7 +_,9 @@
 				}
 
 				num11++;
-				if (SocialAPI.Workshop != null) {
+
+				// The workshop hub itself will no longer be exclusive to Steam versions.
+				if (true) { //if (SocialAPI.Workshop != null) {
 					array9[num11] = Language.GetText("UI.Workshop").Value;
 					if (selectedMenu == num11) {
 						SoundEngine.PlaySound(10);
@@ -37074,6 +_,7 @@
 				}
 
 				num11++;
+				Interface.AddMenuButtons(this, selectedMenu, array9, array7, ref num2, ref num4, ref num11, ref num5);
 				array9[num11] = Lang.menu[14].Value;
 				if (selectedMenu == num11) {
 					SoundEngine.PlaySound(10);
@@ -37702,6 +_,7 @@
 					num2 = 210;
 					num4 = 37;
 					num5 = 8;
+					num5++; // Room for tModLoader settings option.
 					array4[num5 - 1] = 8;
 					for (int num19 = 0; num19 < num5; num19++) {
 						array7[num19] = 0.75f;
@@ -37757,6 +_,13 @@
 					}
 
 					num20++;
+					array9[num20] = Language.GetTextValue("tModLoader.tModLoaderSettings");
+					if (selectedMenu == num20) {
+						SoundEngine.PlaySound(SoundID.MenuOpen);
+						menuMode = Interface.tModLoaderSettingsID;
+					}
+
+					num20++;
 					array9[num20] = Lang.menu[5].Value;
 					if (selectedMenu == num20 || flag5) {
 						flag5 = false;
@@ -37835,6 +_,7 @@
 					num2 = 210;
 					num4 = 36;
 					num5 = 9;
+					num5++; // Room for tModLoader BossBarStyle option.
 					array4[num5 - 1] = 18;
 					for (int num23 = 0; num23 < num5; num23++) {
 						array7[num23] = 0.75f;
@@ -37905,6 +_,11 @@
 						ResourceSetsManager.CycleResourceSet();
 
 					num24++;
+					array9[num24] = BossBarLoader.InsertMenu(out Action onClick);
+					if (selectedMenu == num24)
+						onClick();
+
+					num24++;
 					array9[num24] = Lang.menu[5].Value;
 					if (selectedMenu == num24 || flag5) {
 						flag5 = false;
@@ -38078,7 +_,8 @@
 						SoundEngine.PlaySound(12);
 						int num31 = 0;
 						for (int num32 = 0; num32 < numDisplayModes; num32++) {
+							// TML: Match the changeto follow so that resolution options provided on this settings menu still can be cycled correctly
-							if (displayWidth[num32] == PendingResolutionWidth && displayHeight[num32] == PendingResolutionHeight) {
+							if (displayWidth[num32] == PendingResolutionWidth && BorderedHeight(displayHeight[num32], graphics.IsFullScreen) == PendingResolutionHeight) {
 								num31 = num32;
 								break;
 							}
@@ -38086,7 +_,8 @@
 
 						num31 = (num31 + 1) % numDisplayModes;
 						PendingResolutionWidth = displayWidth[num31];
-						PendingResolutionHeight = displayHeight[num31];
+						// TML: Limit the resolution when going from fullscreen to windowed to be less than the full monitor size so that the key window edges are accessible
+						PendingResolutionHeight = BorderedHeight(displayHeight[num31], graphics.IsFullScreen);
 					}
 
 					num30++;
@@ -38790,7 +_,12 @@
 						}
 					}
 				}
+				else {
+					Interface.ModLoaderMenus(this, selectedMenu, array9, array7, array4, ref num2, ref num4, ref num5, ref flag5);
+				}
 			}
+
+			SkipMenuEnumeration:
 
 			if (menuMode == 888) {
 				if (!_blockFancyUIWhileLoading)
@@ -39313,6 +_,7 @@
 
 			bool flag11 = false;
 			for (int num95 = 0; num95 < num5; num95++) {
+				//patch file: num5, array9, num95
 				if (array9[num95] == null)
 					continue;
 
@@ -39410,6 +_,7 @@
 
 					num104 *= array7[num95];
 					if (!array8[num95])
+						//patch file: array9, array7, array4, num2, num4
 						spriteBatch.DrawString(FontAssets.DeathText.Value, array9[num95], new Vector2(num3 + num102 + array5[num95], (float)(num2 + num4 * num95 + num103) + origin.Y * array7[num95] + (float)array4[num95]), color11, 0f, origin, num104, SpriteEffects.None, 0f);
 					else
 						spriteBatch.DrawString(FontAssets.DeathText.Value, array9[num95], new Vector2(num3 + num102 + array5[num95], (float)(num2 + num4 * num95 + num103) + origin.Y * array7[num95] + (float)array4[num95]), color11, 0f, new Vector2(0f, origin.Y), num104, SpriteEffects.None, 0f);
@@ -39537,6 +_,21 @@
 			else
 				mouseRightRelease = true;
 
+			if (mouseMiddle)
+				mouseMiddleRelease = false;
+			else
+				mouseMiddleRelease = true;
+
+			if (mouseXButton1)
+				mouseXButton1Release = false;
+			else
+				mouseXButton1Release = true;
+
+			if (mouseXButton2)
+				mouseXButton2Release = false;
+			else
+				mouseXButton2Release = true;
+
 			if (menuMode == num)
 				GamepadMainMenuHandler.LastDrew = num;
 		}
@@ -39551,7 +_,11 @@
 		}
 
 		private static void DrawVersionNumber(Microsoft.Xna.Framework.Color menuColor, float upBump) {
-			string text = versionNumber;
+			string supportMessage = Language.GetTextValue("tModLoader.PatreonSupport");
+			string patreonShortURL = @"patreon.com/tModLoader";
+			bool showPatreon = !Steam.IsSteamApp;
+			string text = versionNumber + Environment.NewLine + ModLoader.ModLoader.versionedName + (showPatreon ? Environment.NewLine + supportMessage : "");
+
 			Vector2 origin = FontAssets.MouseText.Value.MeasureString(text);
 			origin.X *= 0.5f;
 			origin.Y *= 0.5f;
@@ -39580,7 +_,47 @@
 					num2 = 2;
 
 				spriteBatch.DrawString(FontAssets.MouseText.Value, text, new Vector2(origin.X + (float)num + 10f, (float)screenHeight - origin.Y + (float)num2 - 2f - upBump), color, 0f, origin, 1f, SpriteEffects.None, 0f);
+
+				// Developer mode button.
+				if (menuMode == 0 && !ModCompile.DeveloperMode) {
+					const string DeveloperModeText = "Enable Developer Mode";
+
+					// measure and draw text from bottom right
+					var textSize = FontAssets.MouseText.Value.MeasureString(DeveloperModeText);
+					var pos = new Vector2(screenWidth - 10f + num, screenHeight - 2f + num2);
+					var d_color = color;
+
+					// final draw
+					if (i == 4) {
+						var rect = new Rectangle((int)(pos.X - textSize.X), (int)(pos.Y - textSize.Y), (int)textSize.X, (int)textSize.Y);
+						bool mouseover = rect.Contains(mouseX, mouseY);
+						d_color = mouseover ? highVersionColor : new Color(120, 120, 120, 76);
+
+						if (mouseover && mouseLeftRelease && mouseLeft) {
+							SoundEngine.PlaySound(SoundID.MenuOpen);
+							menuMode = Interface.modSourcesID;
+						}
+					}
+
+					spriteBatch.DrawString(FontAssets.MouseText.Value, DeveloperModeText, pos, d_color, 0f, textSize, 1f, SpriteEffects.None, 0f);
+				}
+
+				// TML Patreon.
+				if (showPatreon) {
+					var font = FontAssets.MouseText.Value;
+					var patreonOrigin = font.MeasureString(supportMessage);
+					Vector2 urlSize = font.MeasureString(patreonShortURL);
+
+					spriteBatch.DrawString(font, patreonShortURL, new Vector2(patreonOrigin.X + num + 10f, screenHeight - patreonOrigin.Y + num2 - 2f - (int)upBump), color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
+
+					if (i == 4 && mouseLeftRelease && mouseLeft && new Microsoft.Xna.Framework.Rectangle((int)patreonOrigin.X + 10, screenHeight - (int)urlSize.Y - 2 - (int)upBump, (int)urlSize.X, (int)patreonOrigin.Y).Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)) && hasFocus) {
+						SoundEngine.PlaySound(SoundID.MenuOpen);
+						Utils.OpenToURL("https://www.patreon.com/tModLoader");
+					}
+				}
 			}
+
+			// End of DrawVersionNumber
 		}
 
 		private static void ClearVisualPostProcessEffects() {
@@ -39677,6 +_,10 @@
 			CreditsRollEvent.Reset();
 			maxRaining = 0f;
 			raining = false;
+
+			//Added by tML.
+			Graphics.Effects.Filters.Scene.DeactivateAll();
+			SkyManager.Instance.DeactivateAll();
 		}
 
 		private static void PostDrawMenu(Microsoft.Xna.Framework.Point screenSizeCache, Microsoft.Xna.Framework.Point screenSizeCacheAfterScaling) {
@@ -40146,9 +_,16 @@
 			float value3 = (float)((double)(screenPosition.Y - (float)(screenHeight / 2) + 200f) - rockLayer * 16.0) / 300f;
 			value3 = MathHelper.Clamp(value3, 0f, 1f);
 			int num7 = (int)((screenPosition.X + (float)(screenWidth / 2)) / 16f);
+
+			LoaderManager.Get<UndergroundBackgroundStylesLoader>().ChooseStyle(out var modBG, out var priority);
 			int num8 = 3;
 			num8 = ((num7 <= caveBackX[0]) ? caveBackStyle[0] : ((num7 <= caveBackX[1]) ? caveBackStyle[1] : ((num7 > caveBackX[2]) ? caveBackStyle[3] : caveBackStyle[2])));
 			num8 += 3;
+
+			if (priority == SceneEffectPriority.BiomeLow) {
+				num8 = modBG;
+			}
+
 			if (SceneMetrics.SnowTileCount > SceneMetrics.SnowTileThreshold && (screenPosition.Y + (float)screenHeight + 1200f) / 16f < (float)(maxTilesY - 250))
 				num8 = 1;
 
@@ -40162,6 +_,10 @@
 				}
 			}
 
+			if (priority == SceneEffectPriority.BiomeMedium) {
+				num8 = modBG;
+			}
+
 			if (WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenHeight / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16)) {
 				num8 = (player[myPlayer].ZoneCorrupt ? 19 : (player[myPlayer].ZoneCrimson ? 21 : ((!player[myPlayer].ZoneHallow) ? 18 : 20)));
 			}
@@ -40188,6 +_,16 @@
 			if (SceneMetrics.MushroomTileCount > SceneMetrics.MushroomTileMax)
 				num8 = 2;
 
+			if (priority >= SceneEffectPriority.BiomeHigh) {
+				num8 = modBG;
+			}
+
+			if (GlobalBackgroundStyleLoader.loaded) {
+				foreach (var hook in GlobalBackgroundStyleLoader.HookChooseUndergroundBackgroundStyle) {
+					hook(ref num8);
+				}
+			}
+
 			if (num8 != undergroundBackground) {
 				oldUndergroundBackground = undergroundBackground;
 				undergroundBackground = num8;
@@ -40393,6 +_,7 @@
 					array3[5] = 127;
 
 				array3[6] = 185 + hellBackStyle;
+				LoaderManager.Get<UndergroundBackgroundStylesLoader>().FillTextureArray(num9, array3);
 				LoadBackground(array3[0]);
 				LoadBackground(array3[1]);
 				LoadBackground(array3[2]);
@@ -42614,8 +_,22 @@
 				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise);
 				flag = true;
 				DrawMapFullscreenBackground(screenPosition, screenWidth, screenHeight);
+				/* Map texture drawing replaced by an adaptive drawing below, as mod worlds sometimes aren't regular sizes.
 				Microsoft.Xna.Framework.Rectangle destinationRectangle = new Microsoft.Xna.Framework.Rectangle((int)num27, (int)num28, (int)num29, (int)num30);
 				spriteBatch.Draw(TextureAssets.Map.Value, destinationRectangle, Microsoft.Xna.Framework.Color.White);
+				*/
+				int x = (int)(num + mapFullscreenScale * 10);
+				int y = (int)(num2 + mapFullscreenScale * 10);
+				int width = (int)((maxTilesX - 40) * mapFullscreenScale);
+				int height = (int)((maxTilesY - 40) * mapFullscreenScale);
+				var destinationRectangle = new Rectangle(x, y, width, height);
+				spriteBatch.Draw(TextureAssets.Map.Value, destinationRectangle, new Rectangle(40, 4, 848, 240), Color.White);
+				int edgeWidth = (int)(40 * mapFullscreenScale * 5);
+				int edgeHeight = (int)(4 * mapFullscreenScale * 5);
+				destinationRectangle = new Rectangle(x - edgeWidth, y - edgeHeight, edgeWidth, height + 2 * edgeHeight);
+				spriteBatch.Draw(TextureAssets.Map.Value, destinationRectangle, new Rectangle(0, 0, 40, 248), Color.White);
+				destinationRectangle = new Rectangle(x + width, y - edgeHeight, edgeWidth, height + 2 * edgeHeight);
+				spriteBatch.Draw(TextureAssets.Map.Value, destinationRectangle, new Rectangle(888, 0, 40, 248), Color.White);
 				if (mouseLeft && mouseLeftRelease) {
 					double totalSeconds = gameTime.TotalGameTime.TotalSeconds;
 					if (totalSeconds - _lastPingMouseDownTime < 0.5 && Vector2.Distance(MouseScreen, _lastPingMousePosition) < 2f)
@@ -42727,7 +_,7 @@
 			float num40 = (float)textureMaxHeight * num5;
 			float num41 = num;
 			float num42 = 0f;
-			for (int k = 0; k <= 4; k++) {
+			for (int k = 0; k <= mapTargetX - 1; k++) {
 				if (!((float)((k + 1) * textureMaxWidth) > num7) || !((float)(k * textureMaxWidth) < num7 + num9))
 					continue;
 
@@ -43116,6 +_,7 @@
 						}
 					}
 					else if (type >= num99 && type < num99 + num100) {
+						//patch file: num91, num92
 						Tile tile5 = Main.tile[num91, num92];
 						if (tile5 != null) {
 							int num109 = num92;
@@ -43129,6 +_,7 @@
 					}
 					else {
 						text = Lang.GetMapObjectName(type);
+						text = Lang._mapLegendCache.FromTile(Map[num91, num92], num91, num92);
 					}
 				}
 
@@ -43294,6 +_,7 @@
 				}
 
 				spriteBatch.Draw(TextureAssets.MapIcon[num138].Value, new Vector2(num136, num137), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.MapIcon[num138].Width(), TextureAssets.MapIcon[num138].Height()), new Microsoft.Xna.Framework.Color(num139, num139, num139, num139), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
+				SystemLoader.PostDrawFullscreenMap(ref text);
 				DrawCursor(DrawThickCursor());
 			}
 
@@ -43326,6 +_,11 @@
 		}
 
 		private static void DrawMapFullscreenBackground(Vector2 screenPosition, int screenWidth, int screenHeight) {
+			Texture2D modTexture = PlayerLoader.GetMapBackgroundImage(LocalPlayer);
+			if (modTexture != null) {
+				spriteBatch.Draw(modTexture, new Microsoft.Xna.Framework.Rectangle(0, 0, screenWidth, screenHeight), Microsoft.Xna.Framework.Color.White);
+				return;
+			}
 			Asset<Texture2D> asset = TextureAssets.MapBGs[0];
 			int num = -1;
 			Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White;
@@ -44030,6 +_,10 @@
 						return 12;
 					return 6;
 				default:
+					LoaderManager.Get<WaterStylesLoader>().ChooseStyle(out var waterStyle, out var priority);
+					if (priority >= SceneEffectPriority.BiomeLow) {
+						return waterStyle;
+					}
 					if ((double)(screenPosition.Y / 16f) > rockLayer + 40.0) {
 						if (player[myPlayer].ZoneGlowshroom)
 							return 7;
@@ -44061,6 +_,7 @@
 							liquidAlpha[i] = Math.Min(liquidAlpha[i] + 0.2f, 1f);
 					}
 				}
+				LoaderManager.Get<WaterStylesLoader>().UpdateLiquidAlphas();
 			}
 
 			if (!drawToScreen && !isBackground) {
@@ -44086,9 +_,12 @@
 			}
 
 			DrawWater(isBackground, waterStyle, flag ? liquidAlpha[waterStyle] : 1f);
+
+		postWaterDraw:
+			LoaderManager.Get<WaterStylesLoader>().DrawWatersToScreen(isBackground);
 		}
 
-		protected void DrawWater(bool bg = false, int Style = 0, float Alpha = 1f) {
+		protected internal void DrawWater(bool bg = false, int Style = 0, float Alpha = 1f) {
 			if (!Lighting.NotRetro) {
 				oldDrawWater(bg, Style, Alpha);
 				return;
@@ -45250,8 +_,8 @@
 						float num5 = rand.Next((int)num3, (int)num4);
 						num5 *= (1f - maxRaining + 1f) / 2f;
 						num5 *= (1f - windSpeedTarget + 1f) / 2f;
-						num5 *= (float)dayRate;
-						if (rand.Next((int)num5) == 0)
+						num5 *= (float)Math.Max(desiredWorldEventsUpdateRate, 1);
+						if (rand.NextFloat() <= 1f / num5)
 							NewLightning();
 					}
 					else if ((double)GraveyardVisualIntensity >= 0.9 && rand.Next(7200) == 0) {
@@ -45403,7 +_,9 @@
 		}
 
 		public void LoadBackground(int i) {
-			if (i >= 0 && TextureAssets.Background[i].State == AssetState.NotLoaded) {
+			// sometimes when updating GraphicsProfile from Reach to HiDef, the device is re-created rather than reset
+			// This happens early, and the background loading texture may be disposed
+			if (i >= 0 && (TextureAssets.Background[i].State == AssetState.NotLoaded || TextureAssets.Background[i].IsDisposed)) {
 				Assets.Request<Texture2D>(TextureAssets.Background[i].Name);
 				backgroundWidth[i] = TextureAssets.Background[i].Width();
 				backgroundHeight[i] = TextureAssets.Background[i].Height();
@@ -45621,12 +_,12 @@
 			if (!WorldGen.drunkWorldGen && !mapFullscreen && (double)(screenPosition.Y / 16f) <= worldSurface + 10.0) {
 				if (BackgroundEnabled) {
 					if (cloudBGActive > 0f) {
-						cloudBGAlpha += 0.0005f * (float)dayRate;
+						cloudBGAlpha += 0.0005f * (float)desiredWorldEventsUpdateRate;
 						if (cloudBGAlpha > 1f)
 							cloudBGAlpha = 1f;
 					}
 					else {
-						cloudBGAlpha -= 0.0005f * (float)dayRate;
+						cloudBGAlpha -= 0.0005f * (float)desiredWorldEventsUpdateRate;
 						if (cloudBGAlpha < 0f)
 							cloudBGAlpha = 0f;
 					}
@@ -45641,7 +_,7 @@
 						bgScale = 1.65f;
 						bgParallax = 0.09000000357627869;
 						if (base.IsActive && !gamePaused)
-							cloudBGX[0] += windSpeedCurrent * (float)bgParallax * 9f * (float)dayRate;
+							cloudBGX[0] += windSpeedCurrent * (float)bgParallax * 9f * (float)desiredWorldEventsUpdateRate;
 
 						if (cloudBGX[0] > (float)backgroundWidth[cloudBG[0]] * bgScale)
 							cloudBGX[0] -= (float)backgroundWidth[cloudBG[0]] * bgScale;
@@ -45671,7 +_,7 @@
 						bgScale = 1.85f;
 						bgParallax = 0.12;
 						if (base.IsActive && !gamePaused)
-							cloudBGX[1] += windSpeedCurrent * (float)bgParallax * 9f * (float)dayRate;
+							cloudBGX[1] += windSpeedCurrent * (float)bgParallax * 9f * (float)desiredWorldEventsUpdateRate;
 
 						if (cloudBGX[1] > (float)backgroundWidth[cloudBG[1]] * bgScale)
 							cloudBGX[1] -= (float)backgroundWidth[cloudBG[1]] * bgScale;
@@ -45878,6 +_,10 @@
 							DrawSurfaceBG_Mushroom(num4, num5, num6, bgTexIndexes7);
 							DrawSurfaceBG_DrawChangeOverlay(11);
 						}
+
+						if (num20 >= BG_STYLES_COUNT) {
+							LoaderManager.Get<SurfaceBackgroundStylesLoader>().DrawCloseBackground(num20);
+						}
 					}
 				}
 			}
@@ -46042,6 +_,7 @@
 				DrawSurfaceBG_DrawBackMountainsLayer(246);
 			}
 
+			LoaderManager.Get<SurfaceBackgroundStylesLoader>().DrawFarTexture();
 			SkyManager.Instance.DrawToDepth(spriteBatch, 5f);
 		}
 
@@ -46112,6 +_,8 @@
 				if (treeMntBGSet4[1] > -1)
 					DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet4[1]);
 			}
+
+			LoaderManager.Get<SurfaceBackgroundStylesLoader>().DrawMiddleTexture();
 		}
 
 		private void UpdateOceanWaterLineForAmbience() {
@@ -47302,7 +_,7 @@
 
 				bool flag2 = false;
 				bool flag3 = false;
-				if (tile[x, y].type == 10) {
+				if (TileLoader.IsClosedDoor(tile[x, y])) {
 					flag2 = false;
 				}
 				else if (tileSolid[tile[x, y].type] && !tileSolidTop[tile[x, y].type]) {
@@ -47367,6 +_,7 @@
 		}
 
 		protected override void Draw(GameTime gameTime) {
+			try {
 			if (!_isDrawingOrUpdating && IsGraphicsDeviceAvailable) {
 				_isDrawingOrUpdating = true;
 				EnsureRenderTargetContent();
@@ -47375,7 +_,13 @@
 					Main.OnPostDraw(gameTime);
 
 				Assets.TransferCompletedAssets();
+				ModContent.TransferCompletedAssets();
 				_isDrawingOrUpdating = false;
+			}
+			}
+			catch (Exception e) {
+				Logging.Terraria.Error(e);
+				throw;
 			}
 		}
 
@@ -47504,19 +_,22 @@
 					renderCount = 99;
 				}
 				else {
+					//TML: RenderTiles() is quite slow. ~30ms at peak; doesn't change with lighting modes
 					if (renderCount == 3) {
 						RenderTiles();
 						sceneTilePos.X = screenPosition.X - (float)offScreenRange;
 						sceneTilePos.Y = screenPosition.Y - (float)offScreenRange;
 					}
 
-					if (renderCount == 3) {
+					//TML: Remapped from 3 to 2 to flatten per frame load for colour lighting ( ~5ms peak).
+					if (renderCount == (Lighting.LegacyEngine.Mode == 0 ? 2 : 3)) {
 						RenderTiles2();
 						sceneTile2Pos.X = screenPosition.X - (float)offScreenRange;
 						sceneTile2Pos.Y = screenPosition.Y - (float)offScreenRange;
 					}
 
-					if (renderCount == 3) {
+					//TML: Remapped from 3 to 0 to flatten per frame load for colour lighting ( ~15ms peak).
+					if (renderCount == (Lighting.LegacyEngine.Mode == 0 ? 0 : 3)) {
 						RenderWalls();
 						sceneWallPos.X = screenPosition.X - (float)offScreenRange;
 						sceneWallPos.Y = screenPosition.Y - (float)offScreenRange;
@@ -47611,10 +_,13 @@
 			if (gameMenu || netMode == 2)
 				bgTopY = -200;
 
+			/*
 			int num3 = dayRate;
 			if (num3 < 1)
 				num3 = 1;
+			*/
 
+			double num3 = desiredWorldEventsUpdateRate;
 			float num4 = 0.0005f * (float)num3;
 			if (gameMenu)
 				num4 *= 20f;
@@ -47681,13 +_,16 @@
 			UpdateAtmosphereTransparencyToSkyColor();
 			base.GraphicsDevice.Clear(Microsoft.Xna.Framework.Color.Black);
 			base.Draw(gameTime);
-			float val = (float)screenWidth / MinimumZoomComparerX;
-			float val2 = (float)screenHeight / MinimumZoomComparerY;
+			float val = screenWidth / (ModLoader.ModLoader.removeForcedMinimumZoom ? 8192f : MinimumZoomComparerX);
+			float val2 = screenHeight / (ModLoader.ModLoader.removeForcedMinimumZoom ? 8192f : MinimumZoomComparerY);
 			ForcedMinimumZoom = Math.Max(Math.Max(1f, val), val2);
 			GameViewMatrix.Effects = ((!gameMenu && player[myPlayer].gravDir != 1f) ? SpriteEffects.FlipVertically : SpriteEffects.None);
 			BackgroundViewMatrix.Effects = GameViewMatrix.Effects;
 			BackgroundViewMatrix.Zoom = new Vector2(ForcedMinimumZoom);
 			GameViewMatrix.Zoom = new Vector2(ForcedMinimumZoom * MathHelper.Clamp(GameZoomTarget, 1f, 2f));
+
+			SystemLoader.ModifyTransformMatrix(ref GameViewMatrix);
+
 			if (gameMenu || player[myPlayer].gravDir == 1f)
 				Rasterizer = RasterizerState.CullCounterClockwise;
 			else
@@ -47774,7 +_,7 @@
 			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, Rasterizer, null, GameViewMatrix.TransformationMatrix);
 			DrawBackgroundBlackFill();
 			spriteBatch.End();
-			Overlays.Scene.Draw(spriteBatch, RenderLayers.Landscape);
+			Overlays.Scene.Draw(spriteBatch, RenderLayers.Landscape, true);
 			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, Rasterizer, null, UIScaleMatrix);
 			if (gameMenu || netMode == 2) {
 				spriteBatch.End();
@@ -47873,6 +_,7 @@
 
 			TimeLogger.DetailedDrawReset();
 			spriteBatch.End();
+			SystemLoader.PostDrawTiles();
 			TimeLogger.DetailedDrawTime(35);
 			HasInteractibleObjectThatIsNotATile = false;
 			SortDrawCacheWorms();
@@ -47944,7 +_,7 @@
 			ScreenObstruction.Draw(spriteBatch);
 			TimeLogger.DetailedDrawReset();
 			spriteBatch.End();
-			Overlays.Scene.Draw(spriteBatch, RenderLayers.All);
+			Overlays.Scene.Draw(spriteBatch, RenderLayers.All, true);
 			if (flag2)
 				Terraria.Graphics.Effects.Filters.Scene.EndCapture(null, screenTarget, screenTargetSwap, Microsoft.Xna.Framework.Color.Black);
 
@@ -48069,6 +_,21 @@
 			else
 				mouseRightRelease = true;
 
+			if (mouseMiddle)
+				mouseMiddleRelease = false;
+			else
+				mouseMiddleRelease = true;
+
+			if (mouseXButton1)
+				mouseXButton1Release = false;
+			else
+				mouseXButton1Release = true;
+
+			if (mouseXButton2)
+				mouseXButton2Release = false;
+			else
+				mouseXButton2Release = true;
+
 			if (!PlayerInput.Triggers.Current.MouseRight && !PlayerInput.Triggers.Current.MouseLeft && !preventStackSplitReset)
 				stackSplit = 0;
 
@@ -48247,6 +_,7 @@
 						else if (player.scope)
 							num5 = 0.5f;
 
+						PlayerLoader.ModifyZoom(LocalPlayer, ref num5);
 						Vector2 vector3 = (MouseScreen - new Vector2(screenWidth, screenHeight) / 2f) / (new Vector2(screenWidth, screenHeight) / 2f);
 						num4 = 48f;
 						if (vector3 != Vector2.Zero && num5 != -1f) {
@@ -48272,8 +_,10 @@
 					if (num7 < 0)
 						num7 = 0;
 
-					vector2.X = (float)(num6 - screenWidth / 2) / 1.25f;
-					vector2.Y = (float)(num7 - screenHeight / 2) / 1.25f;
+					float zoom = 0.8f;
+					PlayerLoader.ModifyZoom(LocalPlayer, ref zoom);
+					vector2.X = (num6 - screenWidth / 2) * zoom;
+					vector2.Y = (num7 - screenHeight / 2) * zoom;
 					flag = true;
 				}
 				else if (Main.player[myPlayer].inventory[Main.player[myPlayer].selectedItem].type == 1254 && mouseRight) {
@@ -48291,8 +_,10 @@
 					if (num9 < 0)
 						num9 = 0;
 
-					vector2.X = (float)(num8 - screenWidth / 2) / 1.5f;
-					vector2.Y = (float)(num9 - screenHeight / 2) / 1.5f;
+					float zoom = 3f/2f;
+					PlayerLoader.ModifyZoom(LocalPlayer, ref zoom);
+					vector2.X = (num8 - screenWidth / 2) * zoom;
+					vector2.Y = (num9 - screenHeight / 2) * zoom;
 					flag = true;
 				}
 				else if (Main.player[myPlayer].inventory[Main.player[myPlayer].selectedItem].type == 1299 && Main.player[myPlayer].selectedItem != 58) {
@@ -48310,8 +_,10 @@
 					if (num11 < 0)
 						num11 = 0;
 
-					vector2.X = (float)(num10 - screenWidth / 2) / 1.5f;
-					vector2.Y = (float)(num11 - screenHeight / 2) / 1.5f;
+					float zoom = 3f/2f;
+					PlayerLoader.ModifyZoom(LocalPlayer, ref zoom);
+					vector2.X = (num10 - screenWidth / 2) * zoom;
+					vector2.Y = (num11 - screenHeight / 2) * zoom;
 					flag = true;
 				}
 				else if (Main.player[myPlayer].scope && mouseRight) {
@@ -48329,8 +_,32 @@
 					if (num13 < 0)
 						num13 = 0;
 
+					float zoom = 0.5f;
+					PlayerLoader.ModifyZoom(player[myPlayer], ref zoom);
-					vector2.X = (float)(num12 - screenWidth / 2) / 2f;
+					vector2.X = (num12 - screenWidth / 2) * zoom;
-					vector2.Y = (float)(num13 - screenHeight / 2) / 2f;
+					vector2.Y = (num13 - screenHeight / 2) * zoom;
+				}
+				else {
+					int mouseXClamped = mouseX;
+					int mouseYClamped = mouseY;
+					if (mouseXClamped > screenWidth)
+						mouseXClamped = screenWidth;
+
+					if (mouseXClamped < 0)
+						mouseXClamped = 0;
+
+					if (mouseYClamped > screenHeight)
+						mouseYClamped = screenHeight;
+
+					if (mouseYClamped < 0)
+						mouseYClamped = 0;
+
+					float zoom = -1f;
+					PlayerLoader.ModifyZoom(LocalPlayer, ref zoom);
+					if (zoom != -1f) {
+						vector2.X = (mouseXClamped - screenWidth / 2) * zoom;
+						vector2.Y = (mouseYClamped - screenHeight / 2) * zoom;
+					}
 					flag = true;
 				}
 			}
@@ -48377,16 +_,26 @@
 			instance.CameraModifiers.ApplyTo(ref screenPosition);
 			screenPosition.X = (int)screenPosition.X;
 			screenPosition.Y = (int)screenPosition.Y;
+			PlayerLoader.ModifyScreenPosition(LocalPlayer);
+			SystemLoader.ModifyScreenPosition();
 			ClampScreenPositionToWorld();
 		}
 
 		private void DrawSunAndMoon(SceneArea sceneArea, Microsoft.Xna.Framework.Color moonColor, Microsoft.Xna.Framework.Color sunColor, float tempMushroomInfluence) {
-			Texture2D value = TextureAssets.Sun.Value;
+			Texture2D value;
+			Texture2D value2;
+			ModMenu menu = MenuLoader.CurrentMenu;
 			int num = moonType;
+			if (gameMenu) {
+				value = menu.SunTexture?.Value ?? TextureAssets.Sun.Value;
+				value2 = menu.MoonTexture?.Value ?? TextureAssets.Moon[Utils.Clamp(num, 0, 8)].Value;
+				goto SkipVanillaTextures;
+			}
+			value = TextureAssets.Sun.Value;
 			if (!TextureAssets.Moon.IndexInRange(num))
 				num = Utils.Clamp(num, 0, 8);
-
-			Texture2D value2 = TextureAssets.Moon[num].Value;
+			value2 = TextureAssets.Moon[num].Value;
+			SkipVanillaTextures:
 			int num2 = sceneArea.bgTopY;
 			int num3 = (int)(time / 54000.0 * (double)(sceneArea.totalWidth + (float)(value.Width * 2))) - value.Width;
 			int num4 = 0;
@@ -48460,7 +_,11 @@
 
 				moonColor *= num13;
 				Vector2 position2 = new Vector2(num6, num7 + moonModY) + sceneArea.SceneLocalScreenPositionOffset;
+				if (Main.gameMenu && menu != null) {
+					bool needsVanillaFraming = value2 == TextureAssets.Moon[num].Value;
+					spriteBatch.Draw(value2, position2, new Rectangle(0, needsVanillaFraming ? TextureAssets.Moon[num].Width() * moonPhase : 0, needsVanillaFraming ? TextureAssets.Moon[num].Width() : value2.Width, needsVanillaFraming ? TextureAssets.Moon[num].Width() : value2.Width), moonColor, num9, new Vector2(needsVanillaFraming ? TextureAssets.Moon[num].Width() / 2 : value2.Width / 2), num8, SpriteEffects.None, 0f);
+				}
-				if (WorldGen.drunkWorldGen)
+				else if (WorldGen.drunkWorldGen)
 					spriteBatch.Draw(TextureAssets.SmileyMoon.Value, position2, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.SmileyMoon.Width(), TextureAssets.SmileyMoon.Height()), moonColor, num9 / 2f + (float)Math.PI, new Vector2(TextureAssets.SmileyMoon.Width() / 2, TextureAssets.SmileyMoon.Width() / 2), num8, SpriteEffects.None, 0f);
 				else if (pumpkinMoon)
 					spriteBatch.Draw(TextureAssets.PumpkinMoon.Value, position2, new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.PumpkinMoon.Width() * moonPhase, TextureAssets.PumpkinMoon.Width(), TextureAssets.PumpkinMoon.Width()), moonColor, num9, new Vector2(TextureAssets.PumpkinMoon.Width() / 2, TextureAssets.PumpkinMoon.Width() / 2), num8, SpriteEffects.None, 0f);
@@ -48469,7 +_,6 @@
 				else
 					spriteBatch.Draw(TextureAssets.Moon[num].Value, position2, new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.Moon[num].Width() * moonPhase, TextureAssets.Moon[num].Width(), TextureAssets.Moon[num].Width()), moonColor, num9, new Vector2(TextureAssets.Moon[num].Width() / 2, TextureAssets.Moon[num].Width() / 2), num8, SpriteEffects.None, 0f);
 			}
-
 			Microsoft.Xna.Framework.Rectangle value3 = dayTime ? new Microsoft.Xna.Framework.Rectangle((int)((double)num3 - (double)TextureAssets.Sun.Width() * 0.5 * (double)num5), (int)((double)num4 - (double)TextureAssets.Sun.Height() * 0.5 * (double)num5 + (double)sunModY), (int)((float)TextureAssets.Sun.Width() * num5), (int)((float)TextureAssets.Sun.Width() * num5)) : new Microsoft.Xna.Framework.Rectangle((int)((double)num6 - (double)TextureAssets.Moon[num].Width() * 0.5 * (double)num8), (int)((double)num7 - (double)TextureAssets.Moon[num].Width() * 0.5 * (double)num8 + (double)moonModY), (int)((float)TextureAssets.Moon[num].Width() * num8), (int)((float)TextureAssets.Moon[num].Width() * num8));
 			value3.Offset((int)sceneArea.SceneLocalScreenPositionOffset.X, (int)sceneArea.SceneLocalScreenPositionOffset.Y);
 			Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(mouseX, mouseY, 1, 1);
@@ -48554,7 +_,7 @@
 				Vector2 origin = value.Size() / 2f;
 				if (star.falling) {
 					star.fadeIn = 0f;
-					int num7 = star.fallTime;
+					double num7 = star.fallTime;
 					float num8 = 30f;
 					if ((float)num7 > num8)
 						num7 = (int)num8;
@@ -48580,6 +_,8 @@
 			tileColor.G = (byte)((colorOfTheSkies.R + colorOfTheSkies.G + colorOfTheSkies.B + colorOfTheSkies.G * 7) / 10);
 			tileColor.B = (byte)((colorOfTheSkies.R + colorOfTheSkies.G + colorOfTheSkies.B + colorOfTheSkies.B * 7) / 10);
 			tileColor = SkyManager.Instance.ProcessTileColor(tileColor);
+			// TODO: Add in white and white2 as sunColor and moonColor
+			SystemLoader.ModifySunLightColor(ref tileColor, ref colorOfTheSkies);
 		}
 
 		private static void UpdateAtmosphereTransparencyToSkyColor() {
@@ -49332,6 +_,8 @@
 
 			UpdateBGVisibility_BackLayer(null, null);
 			UpdateBGVisibility_FrontLayer(null, null);
+
+			LoaderManager.Get<SurfaceBackgroundStylesLoader>().ModifyFarFades(bgStyle, bgAlphaFrontLayer, backgroundLayerTransitionSpeed);
 			try {
 				DrawSurfaceBG();
 				if (BackgroundEnabled)
@@ -49417,6 +_,10 @@
 					DrawBG_ModifyBGFarBackLayerAlpha(value, null, transitionAmountOverride);
 					break;
 				default:
+					if (value >= BG_STYLES_COUNT) {
+						DrawBG_ModifyBGFarBackLayerAlpha(value, null, transitionAmountOverride);
+						break;
+					}
 					DrawBG_ModifyBGFarBackLayerAlpha(0, null, transitionAmountOverride);
 					break;
 			}
@@ -49425,7 +_,12 @@
 		public static int GetPreferredBGStyleForPlayer() {
 			int num = bgStyle;
 			int num2 = (int)((screenPosition.X + (float)(screenWidth / 2)) / 16f);
+			LoaderManager.Get<SurfaceBackgroundStylesLoader>().ChooseStyle(out var modBG, out var priority);
+
+			if (priority >= SceneEffectPriority.BiomeHigh) {
+				num = modBG;
+			}
-			if (WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16)) {
+			else if (WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16)) {
 				num = (player[myPlayer].ZoneHallow ? 6 : (player[myPlayer].ZoneCorrupt ? ((SceneMetrics.BloodTileCount <= SceneMetrics.EvilTileCount) ? 1 : 8) : (player[myPlayer].ZoneCrimson ? 8 : ((SceneMetrics.HoneyBlockCount <= 400) ? 4 : 3))));
 			}
 			else if (player[myPlayer].ZoneGlowshroom) {
@@ -49443,12 +_,18 @@
 			else if (player[myPlayer].ZoneCrimson) {
 				num = 8;
 			}
+			else if (priority >= SceneEffectPriority.BiomeMedium) {
+				num = modBG;
+			}
 			else if (player[myPlayer].ZoneJungle) {
 				num = 3;
 			}
 			else if (player[myPlayer].ZoneSnow) {
 				num = 7;
 			}
+			else if (priority >= SceneEffectPriority.BiomeLow) {
+				num = modBG;
+			}
 			else {
 				num = 0;
 				if (num2 >= treeX[0]) {
@@ -49458,6 +_,12 @@
 						num = 11;
 					else if (WorldGen.treeBG1 != WorldGen.treeBG4)
 						num = 12;
+				} // Patch context
+			}
+
+			if (GlobalBackgroundStyleLoader.loaded) {
+				foreach (var hook in GlobalBackgroundStyleLoader.HookChooseSurfaceBackgroundStyle) {
+					hook(ref num);
 				}
 			}
 
@@ -49517,6 +_,13 @@
 		}
 
 		private static void UpdateInvasion() {
+			SystemLoader.PreUpdateInvasions();
+
+			UpdateInvasion_Inner();
+
+			SystemLoader.PostUpdateInvasions();
+		}
+		private static void UpdateInvasion_Inner() {
 			if (invasionType <= 0)
 				return;
 
@@ -49549,9 +_,14 @@
 			if (invasionX == (double)spawnTileX)
 				return;
 
+			/*
 			float num = dayRate;
 			if (num < 1f)
 				num = 1f;
+			*/
+			double num = desiredWorldEventsUpdateRate;
+			if (num < 0)
+				num = 0;
 
 			if (invasionX > (double)spawnTileX) {
 				invasionX -= num;
@@ -49757,6 +_,11 @@
 			}
 		}
 
+		public static void NewText(object o, Color? color = null) {
+			if (color == null) color = Color.White;
+			NewText(o.ToString(), color.Value.R, color.Value.G, color.Value.B);
+		}
+
 		public static void NewText(string newText, byte R = byte.MaxValue, byte G = byte.MaxValue, byte B = byte.MaxValue) {
 			chatMonitor.NewText(newText, R, G, B);
 			SoundEngine.PlaySound(12);
@@ -49767,12 +_,20 @@
 			SoundEngine.PlaySound(12);
 		}
 
+		/// <summary>
+		/// Stops rain. Should be called on the server (netMode != client) - vanilla syncs it using <see cref="SyncRain"/>.
+		/// <br>You can also call this on the client to update visuals immediately, assuming it was called serverside aswell (Journey Mode rain slider does this).</br>
+		/// </summary>
 		public static void StopRain() {
 			rainTime = 0;
 			raining = false;
 			maxRaining = 0f;
 		}
 
+		/// <summary>
+		/// Starts rain for a random amount of time. Should be called on the server (netMode != client) - vanilla syncs it using <see cref="SyncRain"/>.
+		/// <br>You can also call this on the client to update visuals immediately, assuming it was/will be called serverside aswell (Journey Mode rain slider does this).</br>
+		/// </summary>
 		public static void StartRain() {
 			int num = 86400;
 			int num2 = num / 24;
@@ -49884,7 +_,7 @@
 			}
 
 			if (ladyBugRainBoost > 0)
-				ladyBugRainBoost -= dayRate;
+				ladyBugRainBoost -= desiredWorldEventsUpdateRate;
 
 			if (pumpkinMoon) {
 				bloodMoon = false;
@@ -49896,12 +_,12 @@
 
 			if ((netMode != 1 && !gameMenu) || netMode == 2) {
 				if (slimeRainTime > 0.0) {
-					slimeRainTime -= dayRate;
+					slimeRainTime -= desiredWorldEventsUpdateRate;
 					if (slimeRainTime <= 0.0)
 						StopSlimeRain();
 				}
 				else if (slimeRainTime < 0.0) {
-					slimeRainTime += dayRate;
+					slimeRainTime += desiredWorldEventsUpdateRate;
 					if (slimeRainTime > 0.0)
 						slimeRainTime = 0.0;
 				}
@@ -49912,31 +_,30 @@
 							StopRain();
 						}
 						else {
-							rainTime -= dayRate;
+							rainTime -= desiredWorldEventsUpdateRate;
-							if (dayRate > 0) {
+							if (desiredWorldEventsUpdateRate > 0) {
-								int num = 86400 / dayRate / 24;
+								double num = 86400 / desiredWorldEventsUpdateRate / 24;
 								if (rainTime <= 0)
 									StopRain();
-								else if (rand.Next(num * 2) == 0)
+								else if (rand.NextDouble() <= 1 / (num * 2))
 									ChangeRain();
 							}
 						}
 					}
 				}
 				else if (!slimeRain && !LanternNight.LanternsUp && !LanternNight.NextNightIsLanternNight) {
-					int num2 = 86400;
-					num2 /= ((dayRate == 0) ? 1 : dayRate);
-					if (!CreativePowerManager.Instance.GetPower<CreativePowers.FreezeRainPower>().Enabled && dayRate != 0) {
+					if (!CreativePowerManager.Instance.GetPower<CreativePowers.FreezeRainPower>().Enabled && desiredWorldEventsUpdateRate != 0) {
+						double num2 = 86400 / desiredWorldEventsUpdateRate;
 						if (rand.Next((int)((double)num2 * 5.75)) == 0)
 							StartRain();
 						else if (cloudBGActive >= 1f && rand.Next((int)((double)num2 * 4.25)) == 0)
 							StartRain();
-						else if (ladyBugRainBoost > 0 && rand.Next(num2) == 0)
+						else if (ladyBugRainBoost > 0 && rand.Next((int)num2) == 0)
 							StartRain();
 					}
 
-					if (!raining && !NPC.BusyWithAnyInvasionOfSorts() && dayRate > 0) {
+					if (!raining && !NPC.BusyWithAnyInvasionOfSorts() && desiredWorldEventsUpdateRate > 0) {
-						int num3 = (int)(1728000.0 / (double)dayRate);
+						int num3 = (int)(1728000.0 / desiredWorldEventsUpdateRate);
 						if (!NPC.downedSlimeKing)
 							num3 /= 2;
 
@@ -50017,9 +_,14 @@
 						WorldGen.UnspawnTravelNPC();
 				}
 				else if (!fastForwardTime && dayTime && time < 27000.0) {
+					/*
 					int num6 = dayRate;
 					if (num6 < 1)
 						num6 = 1;
+					*/
+					double num6 = dayRate;
+					if (num6 < 0)
+						num6 = 0;
 
 					int num7 = (int)(27000.0 / (double)num6);
 					num7 *= 4;
@@ -50381,6 +_,11 @@
 		}
 
 		public static BestiaryUnlockProgressReport GetBestiaryProgressReport() {
+			List<BestiaryEntry> terEntries = BestiaryDB.GetBestiaryEntriesByMod(null);
+			return new BestiaryUnlockProgressReport() {
+				EntriesTotal = terEntries.Count,
+				CompletionAmountTotal = terEntries.Count(e => e.UIInfoProvider.GetEntryUICollectionInfo().UnlockState > BestiaryEntryUnlockState.NotKnownAtAll_0)
+			};
 			float num = 0f;
 			int num2 = 0;
 			List<BestiaryEntry> entries = BestiaryDB.Entries;
@@ -50397,7 +_,7 @@
 		}
 
 		private static void UpdateTime_SpawnTownNPCs() {
-			int worldUpdateRate = WorldGen.GetWorldUpdateRate();
+			double worldUpdateRate = WorldGen.GetWorldUpdateRate();
 			if (netMode == 1 || worldUpdateRate <= 0)
 				return;
 
@@ -50412,7 +_,7 @@
 					num++;
 			}
 
-			for (int j = 0; j < 670; j++) {
+			for (int j = 0; j < townNPCCanSpawn.Length; j++) {
 				townNPCCanSpawn[j] = false;
 			}
 
@@ -50543,6 +_,7 @@
 					if (npc[k].type == 663)
 						num31++;
 
+					//Patch context: this is the amount of NPCs.
 					num32++;
 				}
 			}
@@ -50566,6 +_,7 @@
 						continue;
 
 					if (num33 < 2000000000) {
+						//Patch context: this is the amount of money.
 						if (player[l].inventory[m].type == 71)
 							num33 += player[l].inventory[m].stack;
 
@@ -50794,6 +_,9 @@
 				num37 = 663;
 
 			WorldGen.prioritizedTownNPCType = num37;
+
+			// TODO, see what changed and see if we need to do anything to integrate mod npc
+			NPCLoader.CanTownNPCSpawn(num32, num33);
 		}
 
 		public static int DamageVar(float dmg, float luck = 0f) {
@@ -50903,7 +_,8 @@
 		}
 
 		public static void SetFullScreen(bool fullscreen) {
-			SetDisplayMode(PendingResolutionWidth, PendingResolutionHeight, fullscreen);
+			// TML: Make the fullscreen reset to windowed display borders when downsizing
+			SetDisplayMode(PendingResolutionWidth, BorderedHeight(PendingResolutionHeight, fullscreen), fullscreen);
 		}
 
 		public static void SetResolution(int width, int height) {
@@ -50948,7 +_,11 @@
 					width = (int)(num2 * (float)height);
 				}
 
+#if !NETCORE
+				if (!Platform.IsWindows)
-				PlayerInput.RawMouseScale = new Vector2((float)width / (float)instance.Window.ClientBounds.Width, (float)height / (float)instance.Window.ClientBounds.Height);
+					PlayerInput.RawMouseScale = new Vector2((float)width / (float)instance.Window.ClientBounds.Width, (float)height / (float)instance.Window.ClientBounds.Height);
+#endif
+
 				if (!graphics.IsFullScreen) {
 					num3 = Math.Max(graphics.PreferredBackBufferWidth, graphics.GraphicsDevice.Viewport.Width);
 					num4 = Math.Max(graphics.PreferredBackBufferHeight, graphics.GraphicsDevice.Viewport.Height);
@@ -51002,6 +_,7 @@
 				graphics.ToggleFullScreen();
 			}
 
+			// Runs if Graphics Device needs a reset to match backBuffer to Viewport, or if target resolution is diff than current
 			if (width != num3 || height != num4 || flag2) {
 				mapTime = 0;
 				if (gamePaused)
@@ -51011,7 +_,9 @@
 				screenHeight = height;
 				graphics.PreferredBackBufferWidth = screenWidth;
 				graphics.PreferredBackBufferHeight = screenHeight;
+				if (width != num3 || height != num4)
-				graphics.ApplyChanges();
+					graphics.ApplyChanges();
+
 				PlayerInput.CacheOriginalScreenDimensions();
 				FixUIScale();
 				if (Main.OnResolutionChanged != null)
