<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" InitialTargets="IncludeModReferences">

	<!-- Build Defaults -->
	<PropertyGroup>
		<PlatformTarget>AnyCPU</PlatformTarget>
		<TargetFramework>net8.0</TargetFramework>
		<LangVersion>12.0</LangVersion>
	</PropertyGroup>
	
	<PropertyGroup>
		<!-- legacy property -->
		<TerrariaSteamPath>$(MSBuildThisFileDirectory)</TerrariaSteamPath>
		<tMLSteamPath>$(MSBuildThisFileDirectory)</tMLSteamPath>
		<tMLLibraryPath>$(tMLSteamPath)Libraries</tMLLibraryPath>
		<tMLName>tModLoader</tMLName>
		<tMLPath>$(tMLName).dll</tMLPath>
		<tMLServerPath>$(tMLPath) -server</tMLServerPath>
    	<DotNetName Condition=" '$(OS)' == 'Windows_NT' ">dotnet.exe</DotNetName>
    	<DotNetName Condition=" '$(OS)' == 'Unix' ">dotnet</DotNetName>
    	<DotNetName Condition=" '$(DotNetName)' == '' ">dotnet</DotNetName>
		<!-- TML stable version define placeholder -->
	</PropertyGroup>
	
	<ItemGroup>
		<AdditionalFiles Include="**/*.hjson" />
		<AdditionalFiles Include="**/*.txt" />
		<AdditionalFiles Include="**/*.png" />
		<AdditionalFiles Include="**/*.fx" />
		<!-- Remove the txt files that can be found in build folders, causing them to appear in the editor -->
		<AdditionalFiles Remove="bin/**" />
		<AdditionalFiles Remove="obj/**" />
		<Reference Include="$(tMLSteamPath)$(tMLPath)" Private="false" />
		<Reference Include="$(tMLLibraryPath)/**/*.dll" Private="false" />
		<Reference Remove="$(tMLLibraryPath)/Native/**" />
		<Reference Remove="$(tMLLibraryPath)/**/runtime*/**" />
		<Reference Remove="$(tMLLibraryPath)/**/*.resources.dll" />

		<PackageReference Include="tModLoader.CodeAssist" Version="0.1.*" />
	</ItemGroup>

	<ItemDefinitionGroup>
		<ModReference>
			<Visible>false</Visible>
		</ModReference>
	</ItemDefinitionGroup>
	<UsingTask TaskName="GetTmlVersionSymbol" AssemblyFile="$(tMLLibraryPath)/tModLoader.BuildTasks/1.0.0/tModLoader.BuildTasks.dll" TaskFactory="TaskHostFactory" />
	<Target Name="AddPreprocessorVersionSymbol" BeforeTargets="CoreCompile">
		<GetTmlVersionSymbol TmlDllPath="$(tMLSteamPath)$(tMLPath)">
			<Output TaskParameter="TmlVersionSymbol" PropertyName="TmlVersionSymbol" />
		</GetTmlVersionSymbol>
		<PropertyGroup>
			<DefineConstants>$(DefineConstants);$(TmlVersionSymbol)</DefineConstants>
		</PropertyGroup>
	</Target>
	<Target Name="IncludeModReferences">
		<Message Text="Adding %(ModReference.Identity) as a reference" />

		<ItemGroup>
			<Reference Include="%(ModReference.Identity)" Condition="'%(ModReference.ProjectPath)'=='' AND '%(ModReference.HintPath)'!=''" Private="true">
				<HintPath>%(ModReference.HintPath)</HintPath>
			</Reference>
		</ItemGroup>

		<ItemGroup>
			<ProjectReference Include="%(ModReference.ProjectPath)" Condition="'%(ModReference.ProjectPath)'!=''" Private="true" />
		</ItemGroup>
	</Target>

	<UsingTask TaskName="PackageModFile" AssemblyFile="$(tMLLibraryPath)/tModLoader.BuildTasks/1.0.0/tModLoader.BuildTasks.dll" TaskFactory="TaskHostFactory" />
	<Target Name="Package" AfterTargets="Build">
		<Message Text="Packaging mod..." />

		<Message Text="Convert mod properties into item group" />
		<ItemGroup>
			<ModProperty Include="Version" Value="$(Version)" Condition="$(Version) != ''" />
			<ModProperty Include="DisplayName" Value="$(DisplayName)" Condition="$(DisplayName) != ''" />
			<ModProperty Include="Author" Value="$(Author)" Condition="$(Author) != ''" />
			<ModProperty Include="Homepage" Value="$(Homepage)" Condition="$(Homepage) != ''" />
			<ModProperty Include="HideResources" Value="$(HideResources)" Condition="$(HideResources) != ''" />
			<ModProperty Include="IncludeSource" Value="$(IncludeSource)" Condition="$(IncludeSource) != ''" />
			<ModProperty Include="BuildIgnore" Value="$(BuildIgnore)" Condition="$(BuildIgnore) != ''" />
			<ModProperty Include="Side" Value="$(Side)" Condition="$(Side) != ''" />
			<ModProperty Include="SortBefore" Value="$(SortBefore)" Condition="$(SortBefore) != ''" />
			<ModProperty Include="SortAfter" Value="$(SortAfter)" Condition="$(SortAfter) != ''" />
			<ModProperty Include="PlayableOnPreview" Value="$(PlayableOnPreview)" Condition="$(PlayableOnPreview) != ''" />
			<ModProperty Include="TranslationMod" Value="$(TranslationMod)" Condition="$(TranslationMod) != ''" />
		</ItemGroup>

		<PackageModFile
				PackageReferences="@(PackageReference)"
				ProjectReferences="@(_ResolvedProjectReferencePaths)"
				ModReferences="@(ModReference)"
				ReferencePaths="@(ReferencePath)"
				ProjectDirectory="$(MSBuildProjectDirectory)"
				OutputPath="$(OutputPath)"
				AssemblyName="$(AssemblyName)"
				TmlDllPath="$(tMLSteamPath)$(tMLPath)"
				OutputTmodPath="$(OutputTmodPath)"
				ModProperties="@(ModProperty)" >
		</PackageModFile>
	</Target>

</Project>