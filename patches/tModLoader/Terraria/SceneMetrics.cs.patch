--- src/TerrariaNetCore/Terraria/SceneMetrics.cs
+++ src/tModLoader/Terraria/SceneMetrics.cs
@@ -2,6 +_,7 @@
 using System;
 using System.Collections.Generic;
 using Terraria.ID;
+using Terraria.ModLoader;
 using Terraria.WorldBuilding;
 
 namespace Terraria;
@@ -29,14 +_,16 @@
 	public bool CanPlayCreditsRoll;
 	public bool[] NPCBannerBuff = new bool[290];
 	public bool hasBanner;
-	private readonly int[] _tileCounts = new int[693];
+	internal int[] _tileCounts = new int[TileLoader.TileCount];
 	private readonly int[] _liquidCounts = new int[4];
 	private readonly List<Point> _oreFinderTileLocations = new List<Point>(512);
 	public int bestOre;
 
+	//TML: The following pile of properties has had its setters publicized
+
 	public Point? ClosestOrePosition {
 		get;
-		private set;
+		set;
 	}
 
 	public int ShimmerTileCount {
@@ -66,127 +_,127 @@
 
 	public int SandTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int MushroomTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int SnowTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int WaterCandleCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int PeaceCandleCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int ShadowCandleCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int PartyMonolithCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int MeteorTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int BloodTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int JungleTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public int DungeonTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasSunflower {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasGardenGnome {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasClock {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasCampfire {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasStarInBottle {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasHeartLantern {
 		get;
-		private set;
+		set;
 	}
 
 	public int ActiveFountainColor {
 		get;
-		private set;
+		set;
 	}
 
 	public int ActiveMonolithType {
 		get;
-		private set;
+		set;
 	}
 
 	public bool BloodMoonMonolith {
 		get;
-		private set;
+		set;
 	}
 
 	public bool MoonLordMonolith {
 		get;
-		private set;
+		set;
 	}
 
 	public bool EchoMonolith {
 		get;
-		private set;
+		set;
 	}
 
 	public int ShimmerMonolithState {
 		get;
-		private set;
+		set;
 	}
 
 	public bool HasCatBast {
 		get;
-		private set;
+		set;
 	}
 
 	public int GraveyardTileCount {
 		get;
-		private set;
+		set;
 	}
 
 	public bool EnoughTilesForShimmer => ShimmerTileCount >= ShimmerTileThreshold;
@@ -221,6 +_,8 @@
 		if (settings.ScanOreFinderData)
 			_oreFinderTileLocations.Clear();
 
+		SystemLoader.ResetNearbyTileEffects();
+
 		if (settings.BiomeScanCenterPositionInWorld.HasValue) {
 			Point point = settings.BiomeScanCenterPositionInWorld.Value.ToTileCoordinates();
 			Rectangle tileRectangle = new Rectangle(point.X - Main.buffScanAreaWidth / 2, point.Y - Main.buffScanAreaHeight / 2, Main.buffScanAreaWidth, Main.buffScanAreaHeight);
@@ -285,6 +_,8 @@
 
 					if (settings.ScanOreFinderData && Main.tileOreFinderPriority[tile.type] != 0)
 						_oreFinderTileLocations.Add(new Point(i, j));
+
+					TileLoader.NearbyEffects(i, j, tile.type, false);
 				}
 			}
 		}
@@ -297,7 +_,7 @@
 					if (tile2 == null || !tile2.active())
 						continue;
 
-					if (tile2.type == 104)
+					if (TileID.Sets.Clock[tile2.type])
 						HasClock = true;
 
 					switch (tile2.type) {
@@ -357,15 +_,23 @@
 							if (tile2.frameY >= 54)
 								BloodMoonMonolith = true;
 							break;
+						// Extra extra patch context.
 						case 657:
 							if (tile2.frameY >= 54)
 								EchoMonolith = true;
 							break;
+						// Extra patch context.
 						case 658: {
 								int num8 = ShimmerMonolithState = tile2.frameY / 54;
 								break;
 							}
 					}
+
+					// This does not use TileLoader.IsModMusicBox because it needs the *exact* frameY for the second dict lookup
+					if (MusicLoader.tileToMusic.ContainsKey(tile2.type) && MusicLoader.tileToMusic[tile2.type].ContainsKey(tile2.frameY) && tile2.frameX == 36)
+						ActiveMusicBox = MusicLoader.tileToMusic[tile2.type][tile2.frameY];
+
+					TileLoader.NearbyEffects(k, l, tile2.type, true);
 				}
 			}
 		}
@@ -377,6 +_,8 @@
 		CanPlayCreditsRoll = (ActiveMusicBox == 85);
 		if (settings.ScanOreFinderData)
 			UpdateOreFinderData();
+
+		SystemLoader.TileCountsAvailable(_tileCounts);
 	}
 
 	private void ExportTileCountsToMain() {
@@ -475,6 +_,8 @@
 		Array.Clear(NPCBannerBuff, 0, NPCBannerBuff.Length);
 		hasBanner = false;
 		CanPlayCreditsRoll = false;
+		if(NPCBannerBuff.Length<ModLoader.NPCLoader.NPCCount)
+			Array.Resize(ref NPCBannerBuff, ModLoader.NPCLoader.NPCCount);
 	}
 
 	private void UpdateOreFinderData() {
